http://127.0.0.1:8000/viewassignment/ZUA101165



 if ($request->assignment === 'UNA100002') {

all completed on kgsdemo and kgslive ```start hare 
While adding a team member in the assignment, the team should be searchable  ```start
vsademo vsalive  done 
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\viewassignment.blade.php
find <option value="2">Staff</option>




<select class="language form-control key"






({{ $teammemberData->staffcode }})  find it 

   <select class="language form-control" id="exampleFormControlSelect" name="teammember_id">






resources\views\backEnd\viewassignment.blade.php
find   $('#exampleModal120').on('hidden.bs.modal', function() {


        $('#exampleModal14').on('hidden.bs.modal', function() {
            $(this).find('select').val(null).trigger('change');
        });
		
		


	

	
```end  deployed vademo, vsalive


15-09-2025 bugs 
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Console\Commands\TimesheetnotfillReminder.php
timesheetnotfillreminder


$rejoiningData = DB::table('teammembers')


                    $rejoiningData = DB::table('teammembers')
                        ->leftJoin('teamrolehistory', 'teamrolehistory.teammember_id', '=', 'teammembers.id')
                        ->leftJoin('rejoiningsamepost', 'rejoiningsamepost.teammember_id', '=', 'teammembers.id')
                        ->where('teammembers.id', $user->teammember_id)
                        ->select('teamrolehistory.rejoiningdate', 'rejoiningsamepost.rejoiningdate as samepostrejoiningdate')
                        ->first();

                    // check promotion user
                    if ($rejoiningData && $rejoiningData->rejoiningdate == null && $rejoiningData->samepostrejoiningdate == null) {
                        $rejoiningData = DB::table('teamrolehistory')
                            ->where('teamrolehistory.teammember_id', $user->teammember_id)
                            ->select('promotion_date as rejoiningdate')
                            ->first();
                    }


end hare 



One more functionality added to the Autosubmit Exam Leave functionality  ```start   `````
vsademo, vsalive done 
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Console\Commands\SubmittedExamleaveTimesheet.php

    public function handle()
    {
        if ('Wednesday' == date('l', time())) {
            // All employee temmeber id 
            $createdbyList = DB::table('timesheetusers')->distinct()->pluck('createdby')->toArray();

            // Implementation for all employee
            foreach ($createdbyList as $createdby) {
                // Exam leave data get hare
                $usertimesheetfirstdate =  DB::table('timesheetusers')
                    ->where('status', '0')
                    ->where('assignment_id', 214)
                    ->where('createdby', $createdby)
                    ->orderBy('date', 'ASC')->first();
                // Exam leave data should not be empty
                if ($usertimesheetfirstdate && !empty($usertimesheetfirstdate->date)) {

                    $date = Carbon::createFromFormat('Y-m-d', $usertimesheetfirstdate->date);
                    // Automatic submit will be on this date 
                    // find days name Wednesday 
                    $autosubmitdate = $date->copy()->next(Carbon::SUNDAY)->addDays(3);
                    // $autosubmitdate = $date->copy()->next(Carbon::SUNDAY)->addDays(5);
                    $todaydate = Carbon::now('Asia/Kolkata');

                    //autosubmitdate and todaydate should be same 
                    if ($autosubmitdate->isSameDay($todaydate)) {
                        $lastdate = Carbon::createFromFormat('Y-m-d', $usertimesheetfirstdate->date)->addDays(6);

                        $firstDate = new DateTime($usertimesheetfirstdate->date);
                        $dayOfWeek = $firstDate->format('w');

                        $daysToAdd = 0;

                        if ($dayOfWeek !== '0') {
                            $daysToAdd = 7 - $dayOfWeek;
                        }

                        if ($dayOfWeek > 0) {
                            $daysToSubtract = $dayOfWeek - 1;
                        } else {
                            $daysToSubtract = $dayOfWeek;
                        }
                        $upcomingSunday = (new DateTime($firstDate->format('Y-m-d')))->modify("+$daysToAdd days")->format('Y-m-d');
                        $presentWeekMonday = (new DateTime($firstDate->format('Y-m-d')))->modify("-$daysToSubtract days")->format('Y-m-d');

                        // Get six data of exam leave 
                        $get_six_Data = DB::table('timesheetusers')
                            ->where('status', '0')
                            ->where('assignment_id', 214)
                            ->where('createdby', $createdby)
                            ->whereBetween('date', [$firstDate->format('Y-m-d'), $upcomingSunday])
                            ->orderBy('date', 'ASC')
                            ->get();

                        $lastdate = $get_six_Data->max('date');

                        // get date only of retrived data 
                        $retrievedDates = [];
                        foreach ($get_six_Data as $entry) {
                            $date = new DateTime($entry->date);
                            $retrievedDates[] = $date->format('Y-m-d');
                        }

                        $firstDate = new DateTime($presentWeekMonday);
                        $upcomingSundayDate = new DateTime($upcomingSunday);
                        $currentDate = clone $firstDate;

                        $expectedDates = [];
                        while ($currentDate->format('Y-m-d') < $upcomingSundayDate->format('Y-m-d')) {
                            //excluding sunday
                            $expectedDates[] = $currentDate->format('Y-m-d');
                            $currentDate->modify("+1 day");
                        }

                        $missingDates = array_diff($expectedDates, $retrievedDates);
                        // missing date should be empty 
                        if (empty($missingDates)) {
                            foreach ($get_six_Data as $getsixdata) {
                                $requestedDate = Carbon::createFromFormat('Y-m-d', $getsixdata->date);

                                $previousMonday = $requestedDate->copy()->previous(Carbon::MONDAY);
                                $previousMondayformated = $previousMonday->format('Y-m-d');

                                $previousMondaytimesheetsubmit = DB::table('timesheetusers')
                                    ->where('status', '1')
                                    ->where('createdby', $createdby)
                                    ->where('date', $previousMondayformated)
                                    ->exists();

                                // check previous week timesheet submitted or not 
                                if ($previousMondaytimesheetsubmit) {
                                    if (date('l', strtotime(date('d-m-Y', strtotime($getsixdata->date)))) == 'Monday') {
                                        $previousMonday = $requestedDate->copy()->previous(Carbon::MONDAY);
                                        // Find the nearest next Saturday to the requested date
                                        $nextSaturday = $requestedDate->copy()->next(Carbon::SATURDAY);
                                        $previousMondayFormatted = $getsixdata->date;
                                        $nextSaturdayFormatted = $nextSaturday->format('Y-m-d');
                                        $nextSaturdayFormatted = $lastdate;

                                        $week =  date('d-m-Y', strtotime($previousMondayFormatted))  . ' to ' . date('d-m-Y', strtotime($nextSaturdayFormatted));

                                        $co = DB::table('timesheetusers')
                                            ->where('status', '0')
                                            ->where('assignment_id', 214)
                                            ->where('createdby', $createdby)
                                            ->whereBetween('date', [$previousMondayFormatted, $nextSaturdayFormatted])
                                            ->select(DB::raw('SUM(hour) as total_hours'), DB::raw('COUNT(DISTINCT timesheetid) as row_count'))
                                            ->get();

                                        foreach ($co as $codata) {
                                            DB::table('timesheetreport')->insert([
                                                'teamid'       =>     $createdby,
                                                'week'       =>     $week,
                                                'totaldays'       =>     $codata->row_count,
                                                'totaltime' =>  $codata->total_hours,
                                                'startdate'  => $previousMondayFormatted,
                                                'enddate'  => $nextSaturdayFormatted,
                                                'created_at'                =>      date('y-m-d H:i:s'),
                                            ]);
                                        }
                                    }

                                    DB::table('timesheetusers')->where('id', $getsixdata->id)->update([
                                        'status'         =>     1,
                                        'updated_at'              =>     date('y-m-d H:i:s'),
                                    ]);

                                    DB::table('timesheets')->where('id', $getsixdata->timesheetid)->update([
                                        'status'         =>     1,
                                        'updated_at'              =>     date('y-m-d H:i:s'),
                                    ]);
                                }
                            }
                        }
                    }
                }
            }
        }
    }








 // for tester not on vsalive 
    // public function handle()
    // {
    //     // if ('Wednesday' == date('l', time())) {
    //     //     // All employee temmeber id 
    //     $createdbyList = DB::table('timesheetusers')->distinct()->pluck('createdby')->toArray();

    //     // Implementation for all employee
    //     foreach ($createdbyList as $createdby) {
    //         // Exam leave data get hare
    //         $usertimesheetfirstdate =  DB::table('timesheetusers')
    //             ->where('status', '0')
    //             ->where('assignment_id', 214)
    //             ->where('createdby', $createdby)
    //             ->orderBy('date', 'ASC')->first();
    //         // Exam leave data should not be empty
    //         if ($usertimesheetfirstdate && !empty($usertimesheetfirstdate->date)) {

    //             $date = Carbon::createFromFormat('Y-m-d', $usertimesheetfirstdate->date);
    //             // Automatic submit will be on this date 
    //             // find days name Wednesday 
    //             $autosubmitdate = $date->copy()->next(Carbon::SUNDAY)->addDays(3);
    //             // $autosubmitdate = $date->copy()->next(Carbon::SUNDAY)->addDays(5);
    //             $todaydate = Carbon::now('Asia/Kolkata');

    //             //autosubmitdate and todaydate should be same 
    //             // if ($autosubmitdate->isSameDay($todaydate)) {
    //             $lastdate = Carbon::createFromFormat('Y-m-d', $usertimesheetfirstdate->date)->addDays(6);

    //             $firstDate = new DateTime($usertimesheetfirstdate->date);
    //             $dayOfWeek = $firstDate->format('w');

    //             $daysToAdd = 0;

    //             if ($dayOfWeek !== '0') {
    //                 $daysToAdd = 7 - $dayOfWeek;
    //             }

    //             if ($dayOfWeek > 0) {
    //                 $daysToSubtract = $dayOfWeek - 1;
    //             } else {
    //                 $daysToSubtract = $dayOfWeek;
    //             }
    //             $upcomingSunday = (new DateTime($firstDate->format('Y-m-d')))->modify("+$daysToAdd days")->format('Y-m-d');
    //             $presentWeekMonday = (new DateTime($firstDate->format('Y-m-d')))->modify("-$daysToSubtract days")->format('Y-m-d');

    //             // Get six data of exam leave 
    //             $get_six_Data = DB::table('timesheetusers')
    //                 ->where('status', '0')
    //                 ->where('assignment_id', 214)
    //                 ->where('createdby', $createdby)
    //                 ->whereBetween('date', [$firstDate->format('Y-m-d'), $upcomingSunday])
    //                 ->orderBy('date', 'ASC')
    //                 ->get();

    //             $lastdate = $get_six_Data->max('date');

    //             // get date only of retrived data 
    //             $retrievedDates = [];
    //             foreach ($get_six_Data as $entry) {
    //                 $date = new DateTime($entry->date);
    //                 $retrievedDates[] = $date->format('Y-m-d');
    //             }

    //             $firstDate = new DateTime($presentWeekMonday);
    //             $upcomingSundayDate = new DateTime($upcomingSunday);
    //             $currentDate = clone $firstDate;

    //             $expectedDates = [];
    //             while ($currentDate->format('Y-m-d') < $upcomingSundayDate->format('Y-m-d')) {
    //                 //excluding sunday
    //                 $expectedDates[] = $currentDate->format('Y-m-d');
    //                 $currentDate->modify("+1 day");
    //             }

    //             $missingDates = array_diff($expectedDates, $retrievedDates);
    //             // missing date should be empty 
    //             if (empty($missingDates)) {
    //                 foreach ($get_six_Data as $getsixdata) {
    //                     $requestedDate = Carbon::createFromFormat('Y-m-d', $getsixdata->date);

    //                     $previousMonday = $requestedDate->copy()->previous(Carbon::MONDAY);
    //                     $previousMondayformated = $previousMonday->format('Y-m-d');

    //                     $previousMondaytimesheetsubmit = DB::table('timesheetusers')
    //                         ->where('status', '1')
    //                         ->where('createdby', $createdby)
    //                         ->where('date', $previousMondayformated)
    //                         ->exists();

    //                     if ($previousMondaytimesheetsubmit) {
    //                         if (date('l', strtotime(date('d-m-Y', strtotime($getsixdata->date)))) == 'Monday') {
    //                             // $previousMonday = $requestedDate->copy()->previous(Carbon::MONDAY);
    //                             // Find the nearest next Saturday to the requested date
    //                             $nextSaturday = $requestedDate->copy()->next(Carbon::SATURDAY);
    //                             $previousMondayFormatted = $getsixdata->date;
    //                             $nextSaturdayFormatted = $nextSaturday->format('Y-m-d');
    //                             $nextSaturdayFormatted = $lastdate;

    //                             $week =  date('d-m-Y', strtotime($previousMondayFormatted))  . ' to ' . date('d-m-Y', strtotime($nextSaturdayFormatted));

    //                             $co = DB::table('timesheetusers')
    //                                 ->where('status', '0')
    //                                 ->where('assignment_id', 214)
    //                                 ->where('createdby', $createdby)
    //                                 ->whereBetween('date', [$previousMondayFormatted, $nextSaturdayFormatted])
    //                                 ->select(DB::raw('SUM(hour) as total_hours'), DB::raw('COUNT(DISTINCT timesheetid) as row_count'))
    //                                 ->get();

    //                             foreach ($co as $codata) {
    //                                 DB::table('timesheetreport')->insert([
    //                                     'teamid'       =>     $createdby,
    //                                     'week'       =>     $week,
    //                                     'totaldays'       =>     $codata->row_count,
    //                                     'totaltime' =>  $codata->total_hours,
    //                                     'startdate'  => $previousMondayFormatted,
    //                                     'enddate'  => $nextSaturdayFormatted,
    //                                     'created_at'                =>      date('y-m-d H:i:s'),
    //                                 ]);
    //                             }
    //                         }

    //                         DB::table('timesheetusers')->where('id', $getsixdata->id)->update([
    //                             'status'         =>     1,
    //                             'updated_at'              =>     date('y-m-d H:i:s'),
    //                         ]);

    //                         DB::table('timesheets')->where('id', $getsixdata->timesheetid)->update([
    //                             'status'         =>     1,
    //                             'updated_at'              =>     date('y-m-d H:i:s'),
    //                         ]);
    //                     }
    //                 }
    //             }

    //             //   return 'message'
    //             // }
    //         }
    //     }
    //     // }
    // }
	





 
 
 
 


	
One more functionality added to the Autosubmit Exam Leave functionality  ```end hare




vsalocal, vsademo vsalive  ```start 
Rejoining/Promotion features Deployed ```start
Client want to implement Rejoining process to users.   07-10-2025 ko deployed on vsalive 
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php
 public function allteamsubmitted()


      return (object)[
        'id' => $firstItem->id,
        'teamid' => $firstItem->teamid,
        'week' => $firstItem->week,
        'totaldays' => $group->sum('totaldays'),
        'totaltime' => $group->sum('totaltime'),
        'dayscount' => $group->sum('dayscount'),
        'startdate' => $firstItem->startdate,
        'enddate' => $firstItem->enddate,
        'partnername' => $firstItem->partnername,
        'created_at' => $firstItem->created_at,
        'team_member' => $firstItem->team_member,
        'emailid' => $firstItem->emailid,
        // Use newstaff_code if available, otherwise staffcode
        'staffcode' => $firstItem->newstaff_code ?? $firstItem->staffcode,
        'partnerid' => $firstItem->partnerid,
      ];





22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\myteamindex.blade.php
 <select class="language form-control" id="category7" name="teamname">
 


                                      <select class="language form-control" id="category7" name="teamname">
                                          <option value="">Please Select One</option>
                                          @foreach ($get_date->unique('emailid') as $jobDatas)
                                              <option value="{{ $jobDatas->teamid }}">
                                                  {{ $jobDatas->team_member }}(
                                                  {{ $jobDatas->newstaff_code ?? ($jobDatas->staffcode ?? '') }})
                                              </option>
                                          @endforeach
                                      </select>
	

	
	
	
	
									  
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\assignmentmapping\yearwise.blade.php
 @if ($sub->profilepic == null)
 
 
 1


                                        @foreach (DB::table('assignmentmappings')->leftJoin('assignmentteammappings', 'assignmentteammappings.assignmentmapping_id', '=', 'assignmentmappings.id')->leftJoin('teammembers', 'teammembers.id', '=', 'assignmentteammappings.teammember_id')->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
                $join->on('teamrolehistoryteam.teammember_id', '=', 'assignmentteammappings.teammember_id')->on('teamrolehistoryteam.created_at', '<', 'assignmentmappings.created_at');
            })->where('assignmentmappings.id', $assignmentmappingDatas->id)->where('assignmentteammappings.type', 0)->select('assignmentmappings.*', 'assignmentteammappings.*', 'teammembers.team_member', 'teammembers.staffcode', 'teammembers.profilepic', 'teamrolehistoryteam.newstaff_code')->get() as $sub)
                                            @if ($sub->profilepic == null)
                                                <a class="avatar avatar-xs" data-toggle="tooltip"
                                                    title="{{ $sub->team_member }} ({{ $sub->newstaff_code ?? ($sub->staffcode ?? '') }})">
                                                    <img src="{{ url('backEnd/image/dummy.png') }}"
                                                        class="avatar-img rounded-circle" alt="...">
                                                @else
                                                    <a class="avatar avatar-xs" data-toggle="tooltip"
                                                        title="{{ $sub->team_member }} ({{ $sub->newstaff_code ?? ($sub->staffcode ?? '') }})">
                                                        <img src="{{ asset('backEnd/image/teammember/profilepic/' . $sub->profilepic) }}"
                                                            class="avatar-img rounded-circle" alt="...">
                                            @endif
                                        @endforeach
										
										
										
										
										
										
										
2
                                        
                                        @foreach (DB::table('assignmentmappings')->leftjoin('assignmentteammappings', 'assignmentteammappings.assignmentmapping_id', 'assignmentmappings.id')->leftjoin('teammembers', 'teammembers.id', 'assignmentteammappings.teammember_id')->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
                $join->on('teamrolehistoryteam.teammember_id', '=', 'assignmentteammappings.teammember_id')->on('teamrolehistoryteam.created_at', '<', 'assignmentmappings.created_at');
            })->where('assignmentmappings.id', $assignmentmappingDatas->id)->where('assignmentteammappings.type', 2)->select('assignmentmappings.*', 'assignmentteammappings.*', 'teammembers.team_member', 'teammembers.staffcode', 'teammembers.profilepic', 'teamrolehistoryteam.newstaff_code')->get() as $sub)
                                            @if ($sub->profilepic == null)
                                                <a class="avatar avatar-xs" data-toggle="tooltip"
                                                    title="{{ $sub->team_member }} ({{ $sub->newstaff_code ?? ($sub->staffcode ?? '') }})">
                                                    <img src="{{ url('backEnd/image/dummy.png') }}"
                                                        class="avatar-img rounded-circle" alt="...">
                                                @else
                                                    <a class="avatar avatar-xs" data-toggle="tooltip"
                                                        title="{{ $sub->team_member }} ({{ $sub->newstaff_code ?? ($sub->staffcode ?? '') }})">
                                                        <img src="{{ asset('backEnd/image/teammember/profilepic/' . $sub->profilepic) }}"
                                                            class="avatar-img rounded-circle" alt="...">
                                            @endif
                                        @endforeach									
										
			






			

22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ChecklistanswerController.php

  public function assignmentList($id)
  $teammemberDatas = DB::table('assignmentmappings')
  
  

        $teammemberDatas = DB::table('assignmentmappings')
            ->join('assignmentteammappings', 'assignmentteammappings.assignmentmapping_id', 'assignmentmappings.id')
            ->join('teammembers', 'teammembers.id', 'assignmentteammappings.teammember_id')
            ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
                $join
                    ->on(
                        'teamrolehistoryteam.teammember_id',
                        '=',
                        'assignmentteammappings.teammember_id',
                    )
                    ->on(
                        'teamrolehistoryteam.created_at',
                        '<',
                        'assignmentmappings.created_at',
                    );
            })
            ->where('assignmentmappings.assignmentgenerate_id', $id)
            ->select('teammembers.*', 'assignmentteammappings.type', 'teamrolehistoryteam.newstaff_code')
            ->get();







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\assignmentlist.blade.php

<td>{{ $teammemberData->staffcode }}</td>
 
 
 
                                            <td>{{ $teammemberData->newstaff_code ?? ($teammemberData->staffcode ?? '') }}
                                            </td>
 










22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ChecklistanswerController.php
 $teammember = Teammember::whereIn('role_id', [15, 14])


        $teammember = DB::table('teammembers')
            ->leftJoin('teamrolehistory', 'teamrolehistory.teammember_id', '=', 'teammembers.id')
            ->whereIn('teammembers.role_id', [15, 14])
            ->where('teammembers.status', 1)
            ->select('teammembers.*', 'teamrolehistory.newstaff_code')
            ->orderBy('team_member', 'ASC')
            ->get();








22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\assignmentlist.blade.php
@foreach ($teammember as $teammemberData)



                                        @foreach ($teammember as $teammemberData)
                                            <option value="{{ $teammemberData->id }}">{{ $teammemberData->team_member }}
                                                ({{ $teammemberData->newstaff_code ?? ($teammemberData->staffcode ?? '') }})
                                            </option>
                                        @endforeach









22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\StepController.php
$teammemberall = DB::table('teammembers')


        $teammemberall = DB::table('teammembers')
            ->leftJoin('teamrolehistory', 'teamrolehistory.teammember_id', '=', 'teammembers.id')
            ->whereIn('teammembers.role_id', [15, 14])
            ->where('teammembers.status', 1)
            ->select('teammembers.*', 'teamrolehistory.newstaff_code')
            ->orderBy('team_member', 'ASC')
            ->get();













22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\viewassignment.blade.php
 @foreach ($teammemberall as $teammemberData)


                                                                    @foreach ($teammemberall as $teammemberData)
                                                                        <option value="{{ $teammemberData->id }}">
                                                                            {{ $teammemberData->team_member }}
                                                                            ({{ $teammemberData->newstaff_code ?? ($teammemberData->staffcode ?? '') }})
                                                                        </option>
                                                                    @endforeach










22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\StepController.php
 $teammemberDatas = DB::table('assignmentteammappings')


        $teammemberDatas = DB::table('assignmentteammappings')
            ->join('assignmentmappings', 'assignmentteammappings.assignmentmapping_id', '=', 'assignmentmappings.id')
            ->join('teammembers', 'teammembers.id', '=', 'assignmentteammappings.teammember_id')
            ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
                $join->on('teamrolehistoryteam.teammember_id', '=', 'assignmentteammappings.teammember_id')
                    ->whereRaw('teamrolehistoryteam.created_at < assignmentmappings.created_at');
            })
            ->leftJoin('titles', 'titles.id', '=', 'teammembers.title_id')
            ->leftJoin('roles', 'roles.id', '=', 'teammembers.role_id')
            ->where('assignmentmappings.assignmentgenerate_id', $id)
            ->whereNotNull('assignmentteammappings.id')
            ->where('assignmentteammappings.type', '!=', 1)
            ->select([
                'teammembers.*',
                'roles.rolename',
                'titles.title',
                'assignmentteammappings.id AS assignmentteammappingsId',
                'assignmentteammappings.status AS assignmentteammappingsStatus',
                'assignmentteammappings.type',
                'assignmentteammappings.teamhour',
                'assignmentteammappings.viewerteam',
                'assignmentmappings.assignmentgenerate_id AS assignmentgenerateid',
                'assignmentmappings.leadpartner',
                'teamrolehistoryteam.newstaff_code'
            ])
            ->orderByDesc('assignmentteammappings.id')
            ->get();












resources\views\backEnd\viewassignment.blade.php
<td>{{ $teammemberData->staffcode }}</td>

1

                                                        <td>{{ $teammemberData->newstaff_code ?? ($teammemberData->staffcode ?? '') }}
                                                        </td>

2
 <td>{{ $teammemberData->newstaff_code ?? ($teammemberData->staffcode ?? '') }}
                                                        </td>
 
 
 
 
 
 
 
 
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\AssignmentfolderfileController.php
   $assignmentfolderfile = DB::table('assignmentfolderfiles')


       $assignmentfolderfile = DB::table('assignmentfolderfiles')
            ->leftjoin('teammembers', 'teammembers.id', 'assignmentfolderfiles.createdby')
            ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
                $join->on('teamrolehistoryteam.teammember_id', '=', 'assignmentfolderfiles.createdby')
                    ->whereRaw('teamrolehistoryteam.created_at < assignmentfolderfiles.created_at');
            })
            ->where('assignmentfolderfiles.assignmentfolder_id', $id)
            ->where('assignmentfolderfiles.status', 1)
            ->select('assignmentfolderfiles.*', 'teammembers.team_member', 'teammembers.staffcode', 'teamrolehistoryteam.newstaff_code')
            ->latest()
            ->get();
			
			
			
			
		

		
			
			

resources\views\backEnd\assignmentfolderfile\index.blade.php	
<td>{{ $assignmentfolderData->team_member }}

			
                                    <td>{{ $assignmentfolderData->team_member }}
                                        ({{ $assignmentfolderData->newstaff_code ?? ($assignmentfolderData->staffcode ?? '') }})
                                    </td>








22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\AssignmentmappingController.php

 $teammember = Teammember::where('status', '1')->whereIn('role_id', [14, 15])->with('title', 'role')
 
 
          $teammember = DB::table('teammembers')
            ->leftJoin('teamrolehistory', 'teamrolehistory.teammember_id', '=', 'teammembers.id')
            ->leftjoin('titles', 'titles.id', 'teammembers.title_id')
            ->leftjoin('roles', 'roles.id', 'teammembers.role_id')
            ->whereIn('teammembers.role_id', [15, 14])
            ->where('teammembers.status', 1)
            ->select('teammembers.*', 'titles.title', 'roles.rolename', 'teamrolehistory.newstaff_code')
            ->orderBy('team_member', 'ASC')
            // ->take(7)
            ->get();
			
	
	
	

	

resources\views\backEnd\assignmentmapping\form.blade.php
 @foreach ($teammember as $teammemberData)

                     @foreach ($teammember as $teammemberData)
                        <option value="{{ $teammemberData->id }}" @if (!empty($store->financial) && $store->financial == $teammemberData->id) selected @endif>
                            {{ $teammemberData->team_member }} ( {{ $teammemberData->rolename }} ) (
                            {{ $teammemberData->newstaff_code ?? ($teammemberData->staffcode ?? '') }} )</option>
                    @endforeach

					
					
		
		
		

		
					
					
resources\views\backEnd\assignmentmapping\create.blade.php
  '{{ $teammemberData->team_member }} ({{ $teammemberData->role->rolename }}) ({{ $teammemberData->staffcode }})</option>' +					
					


                  var fieldHTML =
                      '<div class="row row-sm hidedive"><div class="col-6"><div class="form-group">' +
                      '<label class="font-weight-600">Name *</label>' +
                      '<select required class="language form-control enablefalse" id="teammember_' + x +
                      '" name="teammember_id[]">' +
                      '<option value="">Please Select One</option>' +
                      '@foreach ($teammember as $teammemberData)' +
                      '<option value="{{ $teammemberData->id }}">' +
                      '{{ $teammemberData->team_member }} ({{ $teammemberData->rolename }}) ({{ $teammemberData->newstaff_code ?? ($teammemberData->staffcode ?? '') }})</option>' +
                      '@endforeach</select></div></div>' +
                      '<div class="col-5"><div class="form-group">' +
                      '<label class="font-weight-600">Type *</label>' +
                      '<select required class="form-control key enablefalse" name="type[]" id="type_' +
                      x + '">' +
                      '<option value="">Please Select One</option>' +
                      '<option value="0">Team Leader</option>' +
                      '<option value="2">Staff</option></select></div></div>' +
                      '<a style="margin-top: 36px; margin-left:12px" href="javascript:void(0);" class="remove_button">' +
                      '<img src="{{ url('backEnd/image/remove-icon.png') }}" /></a></div></div>';				
					








resources\views\backEnd\assignmentmapping\create.blade.php
 @foreach ($teammember as $teammemberData)
 

          @foreach ($teammember as $teammemberData)
              teamMembers['{{ $teammemberData->id }}'] =
                  '{{ $teammemberData->team_member }} ({{ $teammemberData->rolename }}) ({{ $teammemberData->newstaff_code ?? ($teammemberData->staffcode ?? '') }})';
          @endforeach
				












22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\clientlist.blade.php
@foreach (DB::table('assignmentmappings')->leftjoin('assignmentteammappings', 


1


                                               @foreach (DB::table('assignmentmappings')->leftJoin('assignmentteammappings', 'assignmentteammappings.assignmentmapping_id', '=', 'assignmentmappings.id')->leftJoin('teammembers', 'teammembers.id', '=', 'assignmentteammappings.teammember_id')->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
                $join->on('teamrolehistoryteam.teammember_id', '=', 'assignmentteammappings.teammember_id')->on('teamrolehistoryteam.created_at', '<', 'assignmentmappings.created_at');
            })->where('assignmentmappings.id', $clientassignmentDatas->id)->where('assignmentteammappings.type', 0)->select('assignmentmappings.*', 'assignmentteammappings.*', 'teammembers.team_member', 'teammembers.staffcode', 'teammembers.profilepic', 'teamrolehistoryteam.newstaff_code')->get() as $sub)
                                                    @if ($sub->profilepic == null)
                                                        <a class="avatar avatar-xs" data-toggle="tooltip"
                                                            title="{{ $sub->team_member }} ({{ $sub->newstaff_code ?? ($sub->staffcode ?? '') }})">
                                                            <img src="{{ url('backEnd/image/dummy.png') }}"
                                                                class="avatar-img rounded-circle" alt="...">
                                                        @else
                                                            <a class="avatar avatar-xs" data-toggle="tooltip"
                                                                title="{{ $sub->team_member }} ({{ $sub->newstaff_code ?? ($sub->staffcode ?? '') }})">
                                                                <img src="{{ asset('backEnd/image/teammember/profilepic/' . $sub->profilepic) }}"
                                                                    class="avatar-img rounded-circle" alt="...">
                                                    @endif
                                                @endforeach





2



                                               @foreach (DB::table('assignmentmappings')->leftjoin('assignmentteammappings', 'assignmentteammappings.assignmentmapping_id', 'assignmentmappings.id')->leftjoin('teammembers', 'teammembers.id', 'assignmentteammappings.teammember_id')->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
                $join->on('teamrolehistoryteam.teammember_id', '=', 'assignmentteammappings.teammember_id')->on('teamrolehistoryteam.created_at', '<', 'assignmentmappings.created_at');
            })->where('assignmentmappings.id', $clientassignmentDatas->id)->where('assignmentteammappings.type', 2)->select('assignmentmappings.*', 'assignmentteammappings.*', 'teammembers.team_member', 'teammembers.staffcode', 'teammembers.profilepic', 'teamrolehistoryteam.newstaff_code')->get() as $sub)
                                                    @if ($sub->profilepic == null)
                                                        <a class="avatar avatar-xs" data-toggle="tooltip"
                                                            title="{{ $sub->team_member }} ({{ $sub->newstaff_code ?? ($sub->staffcode ?? '') }})">
                                                            <img src="{{ url('backEnd/image/dummy.png') }}"
                                                                class="avatar-img rounded-circle" alt="...">
                                                        @else
                                                            <a class="avatar avatar-xs" data-toggle="tooltip"
                                                                title="{{ $sub->team_member }} ({{ $sub->newstaff_code ?? ($sub->staffcode ?? '') }})">
                                                                <img src="{{ asset('backEnd/image/teammember/profilepic/' . $sub->profilepic) }}"
                                                                    class="avatar-img rounded-circle" alt="...">
                                                    @endif
                                                @endforeach










22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TeamloginController.php
 $teammemberlist = Teammember::where('status', '0')->get();
 
 
            $teammemberlist = Teammember::leftJoin('teamrolehistory', 'teamrolehistory.teammember_id', '=', 'teammembers.id')
                ->where('teammembers.status', 0)
                ->select('teammembers.*', 'teamrolehistory.newstaff_code')
                ->get();









resources\views\backEnd\teamlogin\form.blade.php
@foreach ($teammemberlist as $teammemberlistData)

            <option value="{{ $teammemberlistData->emailid }}">
                    {{ $teammemberlistData->team_member }} ({{ $teammemberlistData->newstaff_code ?? ($teammemberlistData->staffcode ?? '') }})</option>




22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\applyleave\adminrevertleave.blade.php
@foreach ($timesheetrequestsDatas as $timesheetrequestsData)

replace @php


                                      @php
                                         $teamMembers = DB::table('teamrolehistory')
                                             ->whereIn('teammember_id', [
                                                 $timesheetrequestsData->createdby,
                                                 $timesheetrequestsData->approver,
                                             ])
                                             ->get()
                                             ->keyBy('teammember_id');

                                         $datadate = $timesheetrequestsData->created_at
                                             ? Carbon\Carbon::createFromFormat(
                                                 'Y-m-d H:i:s',
                                                 $timesheetrequestsData->created_at,
                                             )
                                             : null;

                                         $permotioncheck = $teamMembers[$timesheetrequestsData->createdby] ?? null;
                                         $approverdata = $teamMembers[$timesheetrequestsData->approver] ?? null;

                                         $permotiondate = $permotioncheck
                                             ? Carbon\Carbon::createFromFormat(
                                                 'Y-m-d H:i:s',
                                                 $permotioncheck->created_at,
                                             )
                                             : null;
                                         $approverdate = $approverdata
                                             ? Carbon\Carbon::createFromFormat('Y-m-d H:i:s', $approverdata->created_at)
                                             : null;
                                     @endphp







1
 <a href="{{ url('examleaverequest', $timesheetrequestsData->id) }}"> after this td replace staffcode 

                                        <td>
                                             @if ($permotioncheck && $datadate && $datadate->greaterThan($permotiondate))
                                                 {{ $permotioncheck->newstaff_code }}
                                             @else
                                                 {{ $timesheetrequestsData->teamstaffcode }}
                                             @endif
                                         </td>
		
		
		
		
		
	
	
	


	
2
<td class="textfixed">{{ $timesheetrequestsData->team_member }} after this td replace staffcode 

                                    <td>
                                         @if ($approverdata && $datadate && $datadate->greaterThan($approverdate))
                                             {{ $approverdata->newstaff_code }}
                                         @else
                                             {{ $timesheetrequestsData->staffcode }}
                                         @endif
                                     </td>	
									 
									 
									 

					

					


22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php

   public function full_list()
  {
    // die;
    $teammember = DB::table('teammembers')
      ->leftjoin('roles', 'roles.id', 'teammembers.role_id')
      ->leftJoin('teamrolehistory', 'teamrolehistory.teammember_id', '=', 'teammembers.id')
      ->select('teammembers.id', 'teammembers.team_member', 'teammembers.emailid', 'roles.rolename', 'teammembers.staffcode', 'teamrolehistory.newstaff_code')
      ->where('teammembers.status', '1')->distinct()->get();

    $month = collect([
      'January',
      'February',
      'March',
      'April',
      'May',
      'June',
      'July',
      'August',
      'September',
      'October',
      'November',
      'December'
    ]);

    $result = DB::table('timesheetusers')->select(DB::raw('YEAR(date) as year'))
      ->distinct()->orderBy('year', 'DESC')->limit(5)->get();

    $years = $result->pluck('year');

    $timesheetData = DB::table('timesheets')
      ->leftJoin('teammembers', 'teammembers.id', '=', 'timesheets.created_by')
      ->where('timesheets.status', 0)
      // ->where('timesheets.created_by', 780)
      ->select([
        'timesheets.*',
        'teammembers.team_member',
        'teammembers.staffcode'
      ])
      ->orderByDesc('timesheets.id')
      ->limit(20)
      ->get();


    return view('backEnd.timesheet.hrindex', compact('timesheetData', 'teammember', 'month', 'years'));
  }










22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\hrindex.blade.php

               <form method="GET" action="{{ url('timesheet/search') }}">
                    <div class="row row-sm">
                        <div class="col-4">
                            <div class="form-group">
                                <label class="font-weight-600">Employee </label>
                                <select class="language form-control" id="categoryy" name="teammember">
                                    <option value="">Please Select One</option>
                                    @foreach ($teammember as $teammemberData)
                                        <option value="{{ $teammemberData->id }}">
                                            {{ $teammemberData->team_member }} (
                                            {{ $teammemberData->newstaff_code ?? ($teammemberData->staffcode ?? '') }} )
                                        </option>
                                    @endforeach
                                </select>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="form-group">
                                <label class="font-weight-600">Select Month *</label>
                                <select required class="language form-control" id="category" name="month">
                                    @if (Request::is('timesheet/search'))
                                        @foreach ($month as $monthData)
                                            <option value="{{ $monthData }}"
                                                {{ date('F') == $monthData ? 'selected="selected"' : '' }}>
                                                {{ $monthData }}
                                            </option>
                                        @endforeach
                                    @else
                                        <option value="">Please Select One</option>
                                        @foreach ($month as $monthData)
                                            <option value="{{ $monthData }}">{{ $monthData }}</option>
                                        @endforeach
                                    @endif
                                </select>
                            </div>
                        </div>

                        <div class="col-3">
                            <div class="form-group">
                                <label class="font-weight-600">Select Year *</label>
                                <select required class="language form-control" id="category" name="year">
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-1">
                            <div class="form-group">
                                <label class="font-weight-600" style="visibility: hidden;">action</label>
                                <button type="submit" class="btn btn-success" style="float:right"> Submit</button>
                            </div>
                        </div>

                        @if (Request::is('timesheet/search'))
                            <div class="col-1 d-flex justify-content-center align-items-center">
                                <div class="form-group m-0">
                                    <a href="{{ url('/timesheet/fulllist') }}">
                                        <img src="{{ url('backEnd/image/reload.png') }}" style="width: 30px; height: 30px;"
                                            alt="Reload">
                                    </a>
                                </div>
                            </div>
                        @endif
                    </div>
                </form>









22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\hrindex.blade.php

                    <table id="examplee" class="display nowrap">
                        <thead>
                            <tr>
                                <th style="display: none;">id</th>
                                <th>Employee Name</th>
                                <th class="textfixed">Staff Code</th>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Client Name</th>
                                <th class="textfixed">Client Code</th>
                                <th>Assignment Name</th>
                                <th>Work Item</th>
                                <th>Partner</th>
                                <th class="textfixed">Partner Code</th>
                                <th>Hour</th>
                                <th>Total Hour</th>
                                @if (Auth::user()->role_id == 18 || Auth::user()->role_id == 11)
                                    <th>Action</th>
                                @endif
                            </tr>

                        </thead>
                        <tbody>
                            @foreach ($timesheetData as $timesheetDatas)
                                <tr>
                                    @php
                                        $client_id = DB::table('timesheetusers')
                                            ->leftjoin('clients', 'clients.id', 'timesheetusers.client_id')
                                            ->leftjoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
                                            ->leftjoin('teammembers', 'teammembers.id', 'timesheetusers.partner')
                                            ->where('timesheetusers.timesheetid', $timesheetDatas->id)
                                            ->select(
                                                'timesheetusers.client_id',
                                                'timesheetusers.date',
                                                'clients.client_name',
                                                'clients.client_code',
                                                'timesheetusers.hour',
                                                'assignments.assignment_name',
                                                'billable_status',
                                                'workitem',
                                                'teammembers.id',
                                                'teammembers.team_member',
                                                'teammembers.staffcode',
                                            )
                                            ->get();

                                        //  dd($client_id);
                                        $total = DB::table('timesheetusers')
                                            ->where('timesheetusers.timesheetid', $timesheetDatas->id)
                                            ->sum('hour');

                                        $dates = date('l', strtotime($timesheetDatas->date));

                                        $timesheetusersclientcheck = DB::table('timesheetusers')
                                            ->where('timesheetid', $timesheetDatas->id)
                                            ->first();

                                        $targetAssignments = [29, 34, 32, 33, 134];
                                        if (in_array($timesheetusersclientcheck->client_id, $targetAssignments)) {
                                            $rejoindpromotioncheck = DB::table('teamrolehistory')
                                                ->where('teammember_id', $timesheetusersclientcheck->createdby)
                                                ->first();

                                            $timesheetDate = $timesheetusersclientcheck->date
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d',
                                                    $timesheetusersclientcheck->date,
                                                )->startOfDay()
                                                : null;

                                            $rejoindpromotioncheckdate = null;
                                            if ($rejoindpromotioncheck) {
                                                $rejoindpromotioncheckdate = Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $rejoindpromotioncheck->created_at,
                                                )->startOfDay();
                                            }
                                        } else {
                                            $permotioncheck = DB::table('teamrolehistory')
                                                ->where('teammember_id', $timesheetDatas->created_by)
                                                ->first();

                                            $assignmentcheck = DB::table('timesheetusers')
                                                ->leftJoin(
                                                    'assignmentbudgetings',
                                                    'assignmentbudgetings.assignmentgenerate_id',
                                                    'timesheetusers.assignmentgenerate_id',
                                                )
                                                ->where('timesheetid', $timesheetDatas->id)
                                                ->select('assignmentbudgetings.created_at')
                                                ->first();

                                            //shshid client

                                            $datadate = $assignmentcheck->created_at
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $assignmentcheck->created_at,
                                                )
                                                : null;

                                            $permotiondate = null;
                                            if ($permotioncheck) {
                                                $permotiondate = Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $permotioncheck->created_at,
                                                );
                                            }
                                        }
                                    @endphp
                                    <td style="display: none;">{{ $timesheetDatas->id }}</td>
                                    <td class="textfixed">{{ $timesheetDatas->team_member ?? '' }} </td>
                                    @if (in_array($timesheetusersclientcheck->client_id, $targetAssignments))
                                        @if ($rejoindpromotioncheck && $timesheetDate && $timesheetDate->greaterThanOrEqualTo($rejoindpromotioncheckdate))
                                            <td>{{ $rejoindpromotioncheck->newstaff_code }}</td>
                                        @else
                                            <td>{{ $timesheetDatas->staffcode }}</td>
                                        @endif
                                    @else
                                        @if ($permotioncheck && $datadate && $datadate->greaterThan($permotiondate))
                                            <td>{{ $permotioncheck->newstaff_code }}</td>
                                        @else
                                            <td>{{ $timesheetDatas->staffcode }}</td>
                                        @endif
                                    @endif
                                    <td class="textfixed">{{ date('d-m-Y', strtotime($timesheetDatas->date)) }}
                                    </td>
                                    <td class="textfixed">
                                        @if ($timesheetDatas->date != null)
                                            {{ $dates ?? '' }}
                                        @endif
                                    </td>



                                    <td class="textfixed">
                                        @foreach ($client_id as $item)
                                            {{ $item->client_name ?? '' }}
                                            @if ($item->client_name != 0)
                                                ,
                                            @endif
                                        @endforeach
                                    </td>
                                    <td>
                                        @foreach ($client_id as $item)
                                            {{ $item->client_code ?? '' }}
                                            @if ($item->client_code != 0)
                                                ,
                                            @endif
                                        @endforeach
                                    </td>
                                    <td class="textfixed">
                                        @foreach ($client_id as $item)
                                            {{ $item->assignment_name ?? '' }}
                                            @if ($item->assignment_name != null)
                                                ,
                                            @endif
                                        @endforeach
                                    </td>

                                    <td class="textfixed">
                                        @foreach ($client_id as $item)
                                            {{ $item->workitem ?? '' }}@if ($item->workitem != null)
                                                ,
                                            @endif
                                        @endforeach
                                    </td>
                                    <td class="textfixed">
                                        @foreach ($client_id as $item)
                                            {{ $item->team_member ?? '' }}
                                            @if ($item->team_member != null)
                                                ,
                                            @endif
                                        @endforeach
                                    </td>
                                    <td>
                                        @foreach ($client_id as $item)
                                            @php
                                                if (in_array($item->client_id, $targetAssignments)) {
                                                    // partner code
                                                    $rejoindpromotioncheckpartner = DB::table('teamrolehistory')
                                                        ->where('teammember_id', $item->id)
                                                        ->first();

                                                    $timesheetDatepartner = $item->date
                                                        ? Carbon\Carbon::createFromFormat(
                                                            'Y-m-d',
                                                            $item->date,
                                                        )->startOfDay()
                                                        : null;

                                                    $rejoindpromotioncheckdatepartner = null;
                                                    if ($rejoindpromotioncheckpartner) {
                                                        $rejoindpromotioncheckdatepartner = Carbon\Carbon::createFromFormat(
                                                            'Y-m-d H:i:s',
                                                            $rejoindpromotioncheckpartner->created_at,
                                                        )->startOfDay();
                                                    }
                                                } else {
                                                    $partnerpermotioncheck = DB::table('teamrolehistory')
                                                        ->where('teammember_id', $item->id)
                                                        ->first();

                                                    $assignmentcheck = DB::table('timesheetusers')
                                                        ->leftJoin(
                                                            'assignmentbudgetings',
                                                            'assignmentbudgetings.assignmentgenerate_id',
                                                            'timesheetusers.assignmentgenerate_id',
                                                        )
                                                        ->where('timesheetid', $timesheetDatas->id)
                                                        ->select('assignmentbudgetings.created_at')
                                                        ->first();

                                                    //shshid client

                                                    $partnerdatadate = $assignmentcheck->created_at
                                                        ? Carbon\Carbon::createFromFormat(
                                                            'Y-m-d H:i:s',
                                                            $assignmentcheck->created_at,
                                                        )
                                                        : null;

                                                    $partnerpermotiondate = null;
                                                    if ($partnerpermotioncheck) {
                                                        $partnerpermotiondate = Carbon\Carbon::createFromFormat(
                                                            'Y-m-d H:i:s',
                                                            $partnerpermotioncheck->created_at,
                                                        );
                                                    }
                                                }
                                            @endphp
                                            @if (in_array($item->client_id, $targetAssignments))
                                                @if (
                                                    $rejoindpromotioncheckpartner &&
                                                        $timesheetDatepartner &&
                                                        $timesheetDatepartner->greaterThanOrEqualTo($rejoindpromotioncheckdatepartner))
                                                    {{ $rejoindpromotioncheckpartner->newstaff_code }}
                                                @else
                                                    {{ $item->staffcode }}
                                                @endif
                                                @if ($item->team_member != null)
                                                    ,
                                                @endif
                                            @else
                                                @if ($partnerpermotioncheck && $partnerdatadate && $partnerdatadate->greaterThan($partnerpermotiondate))
                                                    {{ $partnerpermotioncheck->newstaff_code }}
                                                @else
                                                    {{ $item->staffcode }}
                                                @endif
                                                @if ($item->team_member != null)
                                                    ,
                                                @endif
                                            @endif
                                        @endforeach
                                    </td>
                                    <td class="textfixed">
                                        @foreach ($client_id as $item)
                                            {{ $item->hour ?? '' }} @if ($item->hour != null)
                                                ,
                                            @endif
                                        @endforeach
                                    </td>
                                    <td>{{ $total }}</td>
                                    <td>
                                        @if (auth()->user()->role_id == 18 || auth()->user()->role_id == 11)
                                            <a href="{{ url('/timesheet/destroy/' . $timesheetDatas->id) }}"
                                                onclick="return confirm('Are you sure you want to delete this item?');"
                                                class="btn btn-danger-soft btn-sm"><i class="far fa-trash-alt"></i></a>
                                        @else
                                            <!-- <td> <a href="{{ url('/timesheet/destroy/' . $timesheetDatas->id) }}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            onclick="return confirm('Are you sure you want to delete this item?');"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            class="btn btn-danger-soft btn-sm"><i class="far fa-trash-alt"></i></a></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    -->
                                        @endif
                                    </td>

                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                          







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php
public function show(Request $request)

 } elseif (auth()->user()->role_id == 11 || auth()->user()->role_id == 18) {
 
 
 
  } elseif (auth()->user()->role_id == 11 || auth()->user()->role_id == 18) {
      $teammember = DB::table('teammembers')
        ->leftjoin('roles', 'roles.id', 'teammembers.role_id')
        ->leftJoin('teamrolehistory', 'teamrolehistory.teammember_id', '=', 'teammembers.id')
        ->select('teammembers.id', 'teammembers.team_member', 'teammembers.emailid', 'roles.rolename', 'teammembers.staffcode', 'teamrolehistory.newstaff_code')
        ->where('teammembers.status', '1')->distinct()->get();

      $month = collect([
        'January',
        'February',
        'March',
        'April',
        'May',
        'June',
        'July',
        'August',
        'September',
        'October',
        'November',
        'December'
      ]);

      $timesheetData = DB::table('timesheets')
        ->leftjoin('teammembers', 'teammembers.id', 'timesheets.created_by')
        ->where('timesheets.created_by', $request->teammember)
        ->where('timesheets.month', $request->month)
        ->whereYear('timesheets.date', '=', $request->year)
        ->where('timesheets.status', '=', 0)
        ->select('timesheets.*', 'teammembers.team_member', 'teammembers.staffcode')->get();
    







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php
  // this is for team submitted timesheet on Admin
  
  
      // this is for team submitted timesheet on Admin
    else {
      // dd(auth()->user()->role_id);
      $teamname = $request->input('teamname');
      $start = $request->input('start');
      $end = $request->input('end');
      $totalhours = $request->input('totalhours');
      $partnerId = $request->input('partnersearch');

      $query = DB::table('timesheetreport')
        ->leftjoin('teammembers', 'teammembers.id', 'timesheetreport.teamid')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'teammembers.id')
            ->on('teamrolehistory.created_at', '<', 'timesheetreport.created_at');
        })
        ->leftjoin('teammembers as partners', 'partners.id', 'timesheetreport.partnerid')
        ->select('timesheetreport.*', 'teammembers.team_member', 'partners.team_member as partnername', 'teammembers.staffcode', 'teamrolehistory.newstaff_code')
        ->orderBy('timesheetreport.startdate', 'desc');

      // teamname with othser field to  filter
      if ($teamname) {
        $query->where('timesheetreport.teamid', $teamname);
      }

      if ($teamname && $totalhours) {
        $query->where(function ($q) use ($teamname, $totalhours) {
          $q->where('timesheetreport.teamid', $teamname)
            ->where('timesheetreport.totaltime', $totalhours);
        });
      }
      if ($teamname && $partnerId) {
        $query->where(function ($q) use ($teamname, $partnerId) {
          $q->where('timesheetreport.teamid', $teamname)
            ->where('timesheetreport.partnerid', $partnerId);
        });
      }

      // patner or othse one data
      if ($partnerId) {
        $query->where('timesheetreport.partnerid', $partnerId);
      }

      if ($partnerId && $totalhours) {
        $query->where(function ($q) use ($partnerId, $totalhours) {
          $q->where('timesheetreport.partnerid', $partnerId)
            ->where('timesheetreport.totaltime', $totalhours);
        });
      }

      // total hour wise  wise or othser data
      if ($totalhours) {
        $query->where('timesheetreport.totaltime', $totalhours);
      }
      //! end date 
      if ($start && $end) {
        $query->where(function ($query) use ($start, $end) {
          $query->whereBetween('timesheetreport.startdate', [$start, $end])
            ->orWhereBetween('timesheetreport.enddate', [$start, $end])
            ->orWhere(function ($query) use ($start, $end) {
              $query->where('timesheetreport.startdate', '<=', $start)
                ->where('timesheetreport.enddate', '>=', $end);
            });
        });
      }

      $filteredDataaa = $query->get();

      // maping double date ************
      $groupedData = $filteredDataaa->groupBy(function ($item) {
        return $item->team_member . '|' . $item->week;
      })->map(function ($group) {
        $firstItem = $group->first();

        return (object)[
          'id' => $firstItem->id,
          'teamid' => $firstItem->teamid,
          'week' => $firstItem->week,
          'totaldays' => $group->sum('totaldays'),
          'totaltime' => $group->sum('totaltime'),
          'dayscount' => $group->sum('dayscount'),
          'startdate' => $firstItem->startdate,
          'enddate' => $firstItem->enddate,
          'partnername' => $firstItem->partnername,
          'created_at' => $firstItem->created_at,
          'team_member' => $firstItem->team_member,
          'staffcode' => $firstItem->newstaff_code ?? $firstItem->staffcode,
          'partnerid' => $firstItem->partnerid,
        ];
      });

      $filteredData = collect($groupedData->values());
      // dd($filteredData);
      return response()->json($filteredData);
    }










22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php

   public function allteamsubmitted()
  {
    // Fetch all necessary data in a single query
    $get_datess = DB::table('timesheetreport')
      ->leftjoin('teammembers', 'teammembers.id', 'timesheetreport.teamid')
      ->leftJoin('teamrolehistory', function ($join) {
        $join->on('teamrolehistory.teammember_id', '=', 'teammembers.id')
          ->on('teamrolehistory.created_at', '<', 'timesheetreport.created_at');
      })
      ->leftjoin('teammembers as partners', 'partners.id', 'timesheetreport.partnerid')
      // ->where('timesheetreport.teamid', 868)
      ->select(
        'timesheetreport.*',
        'teamrolehistory.newstaff_code',
        'teammembers.team_member',
        'teammembers.staffcode',
        'partners.team_member as partnername',
        'teammembers.emailid'
      )
      ->latest()
      ->get();

    $permissiontimesheet = DB::table('timesheetreport')->first();

    // Map and group data
    $groupedData = $get_datess->groupBy(function ($item) {
      return $item->team_member . '|' . $item->week;
    })->map(function ($group) {
      $firstItem = $group->first();

      return (object)[
        'id' => $firstItem->id,
        'teamid' => $firstItem->teamid,
        'week' => $firstItem->week,
        'totaldays' => $group->sum('totaldays'),
        'totaltime' => $group->sum('totaltime'),
        'dayscount' => $group->sum('dayscount'),
        'startdate' => $firstItem->startdate,
        'enddate' => $firstItem->enddate,
        'partnername' => $firstItem->partnername,
        'created_at' => $firstItem->created_at,
        'team_member' => $firstItem->team_member,
        'emailid' => $firstItem->emailid,
        // Use newstaff_code if available, otherwise staffcode
        'staffcode' => $firstItem->newstaff_code ?? $firstItem->staffcode,
        'partnerid' => $firstItem->partnerid,
      ];
    });

    $get_date = collect($groupedData->values());


    return view('backEnd.timesheet.myteamindex', compact('get_date', 'permissiontimesheet'));
  }








22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\hrindex.blade.php

                             @foreach ($timesheetData as $timesheetDatas)
                                <tr>
                                    @php
                                        $client_id = DB::table('timesheetusers')
                                            ->leftjoin('clients', 'clients.id', 'timesheetusers.client_id')
                                            ->leftjoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
                                            ->leftjoin('teammembers', 'teammembers.id', 'timesheetusers.partner')
                                            ->where('timesheetusers.timesheetid', $timesheetDatas->id)
                                            ->select(
                                                'timesheetusers.client_id',
                                                'timesheetusers.date',
                                                'clients.client_name',
                                                'clients.client_code',
                                                'timesheetusers.hour',
                                                'assignments.assignment_name',
                                                'billable_status',
                                                'workitem',
                                                'teammembers.id',
                                                'teammembers.team_member',
                                                'teammembers.staffcode',
                                            )
                                            ->get();

                                        //  dd($client_id);
                                        $total = DB::table('timesheetusers')
                                            ->where('timesheetusers.timesheetid', $timesheetDatas->id)
                                            ->sum('hour');

                                        $dates = date('l', strtotime($timesheetDatas->date));

                                        $timesheetusersclientcheck = DB::table('timesheetusers')
                                            ->where('timesheetid', $timesheetDatas->id)
                                            ->first();

                                        $targetAssignments = [29, 34, 32, 33, 134];
                                        if (in_array($timesheetusersclientcheck->client_id, $targetAssignments)) {
                                            $rejoindpromotioncheck = DB::table('teamrolehistory')
                                                ->where('teammember_id', $timesheetusersclientcheck->createdby)
                                                ->first();

                                            $timesheetDate = $timesheetusersclientcheck->date
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d',
                                                    $timesheetusersclientcheck->date,
                                                )->startOfDay()
                                                : null;

                                            $rejoindpromotioncheckdate = null;
                                            if ($rejoindpromotioncheck) {
                                                $rejoindpromotioncheckdate = Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $rejoindpromotioncheck->created_at,
                                                )->startOfDay();
                                            }
                                        } else {
                                            $permotioncheck = DB::table('teamrolehistory')
                                                ->where('teammember_id', $timesheetDatas->created_by)
                                                ->first();

                                            $assignmentcheck = DB::table('timesheetusers')
                                                ->leftJoin(
                                                    'assignmentbudgetings',
                                                    'assignmentbudgetings.assignmentgenerate_id',
                                                    'timesheetusers.assignmentgenerate_id',
                                                )
                                                ->where('timesheetid', $timesheetDatas->id)
                                                ->select('assignmentbudgetings.created_at')
                                                ->first();

                                            //shshid client

                                            $datadate = $assignmentcheck->created_at
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $assignmentcheck->created_at,
                                                )
                                                : null;

                                            $permotiondate = null;
                                            if ($permotioncheck) {
                                                $permotiondate = Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $permotioncheck->created_at,
                                                );
                                            }
                                        }
                                    @endphp
                                    <td style="display: none;">{{ $timesheetDatas->id }}</td>
                                    <td class="textfixed">{{ $timesheetDatas->team_member ?? '' }} </td>
                                    @if (in_array($timesheetusersclientcheck->client_id, $targetAssignments))
                                        @if ($rejoindpromotioncheck && $timesheetDate && $timesheetDate->greaterThanOrEqualTo($rejoindpromotioncheckdate))
                                            <td>{{ $rejoindpromotioncheck->newstaff_code }}</td>
                                        @else
                                            <td>{{ $timesheetDatas->staffcode }}</td>
                                        @endif
                                    @else
                                        @if ($permotioncheck && $datadate && $datadate->greaterThan($permotiondate))
                                            <td>{{ $permotioncheck->newstaff_code }}</td>
                                        @else
                                            <td>{{ $timesheetDatas->staffcode }}</td>
                                        @endif
                                    @endif
                                    <td class="textfixed">{{ date('d-m-Y', strtotime($timesheetDatas->date)) }}
                                    </td>
                                    <td class="textfixed">
                                        @if ($timesheetDatas->date != null)
                                            {{ $dates ?? '' }}
                                        @endif
                                    </td>



                                    <td class="textfixed">
                                        @foreach ($client_id as $item)
                                            {{ $item->client_name ?? '' }}
                                            @if ($item->client_name != 0)
                                                ,
                                            @endif
                                        @endforeach
                                    </td>
                                    <td>
                                        @foreach ($client_id as $item)
                                            {{ $item->client_code ?? '' }}
                                            @if ($item->client_code != 0)
                                                ,
                                            @endif
                                        @endforeach
                                    </td>
                                    <td class="textfixed">
                                        @foreach ($client_id as $item)
                                            {{ $item->assignment_name ?? '' }}
                                            @if ($item->assignment_name != null)
                                                ,
                                            @endif
                                        @endforeach
                                    </td>

                                    <td class="textfixed">
                                        @foreach ($client_id as $item)
                                            {{ $item->workitem ?? '' }}@if ($item->workitem != null)
                                                ,
                                            @endif
                                        @endforeach
                                    </td>
                                    <td class="textfixed">
                                        @foreach ($client_id as $item)
                                            {{ $item->team_member ?? '' }}
                                            @if ($item->team_member != null)
                                                ,
                                            @endif
                                        @endforeach
                                    </td>
                                    <td>
                                        @foreach ($client_id as $item)
                                            @php
                                                if (in_array($item->client_id, $targetAssignments)) {
                                                    // partner code
                                                    $rejoindpromotioncheckpartner = DB::table('teamrolehistory')
                                                        ->where('teammember_id', $item->id)
                                                        ->first();

                                                    $timesheetDatepartner = $item->date
                                                        ? Carbon\Carbon::createFromFormat(
                                                            'Y-m-d',
                                                            $item->date,
                                                        )->startOfDay()
                                                        : null;

                                                    $rejoindpromotioncheckdatepartner = null;
                                                    if ($rejoindpromotioncheckpartner) {
                                                        $rejoindpromotioncheckdatepartner = Carbon\Carbon::createFromFormat(
                                                            'Y-m-d H:i:s',
                                                            $rejoindpromotioncheckpartner->created_at,
                                                        )->startOfDay();
                                                    }
                                                } else {
                                                    $partnerpermotioncheck = DB::table('teamrolehistory')
                                                        ->where('teammember_id', $item->id)
                                                        ->first();

                                                    $assignmentcheck = DB::table('timesheetusers')
                                                        ->leftJoin(
                                                            'assignmentbudgetings',
                                                            'assignmentbudgetings.assignmentgenerate_id',
                                                            'timesheetusers.assignmentgenerate_id',
                                                        )
                                                        ->where('timesheetid', $timesheetDatas->id)
                                                        ->select('assignmentbudgetings.created_at')
                                                        ->first();

                                                    //shshid client

                                                    $partnerdatadate = $assignmentcheck->created_at
                                                        ? Carbon\Carbon::createFromFormat(
                                                            'Y-m-d H:i:s',
                                                            $assignmentcheck->created_at,
                                                        )
                                                        : null;

                                                    $partnerpermotiondate = null;
                                                    if ($partnerpermotioncheck) {
                                                        $partnerpermotiondate = Carbon\Carbon::createFromFormat(
                                                            'Y-m-d H:i:s',
                                                            $partnerpermotioncheck->created_at,
                                                        );
                                                    }
                                                }
                                            @endphp
                                            @if (in_array($item->client_id, $targetAssignments))
                                                @if (
                                                    $rejoindpromotioncheckpartner &&
                                                        $timesheetDatepartner &&
                                                        $timesheetDatepartner->greaterThanOrEqualTo($rejoindpromotioncheckdatepartner))
                                                    {{ $rejoindpromotioncheckpartner->newstaff_code }}
                                                @else
                                                    {{ $item->staffcode }}
                                                @endif
                                                @if ($item->team_member != null)
                                                    ,
                                                @endif
                                            @else
                                                @if ($partnerpermotioncheck && $partnerdatadate && $partnerdatadate->greaterThan($partnerpermotiondate))
                                                    {{ $partnerpermotioncheck->newstaff_code }}
                                                @else
                                                    {{ $item->staffcode }}
                                                @endif
                                                @if ($item->team_member != null)
                                                    ,
                                                @endif
                                            @endif
                                        @endforeach
                                    </td>
                                    <td class="textfixed">
                                        @foreach ($client_id as $item)
                                            {{ $item->hour ?? '' }} @if ($item->hour != null)
                                                ,
                                            @endif
                                        @endforeach
                                    </td>
                                    <td>{{ $total }}</td>
                                    <td>
                                        @if (auth()->user()->role_id == 18 || auth()->user()->role_id == 11)
                                            <a href="{{ url('/timesheet/destroy/' . $timesheetDatas->id) }}"
                                                onclick="return confirm('Are you sure you want to delete this item?');"
                                                class="btn btn-danger-soft btn-sm"><i class="far fa-trash-alt"></i></a>
                                        @else
                                            <!-- <td> <a href="{{ url('/timesheet/destroy/' . $timesheetDatas->id) }}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                onclick="return confirm('Are you sure you want to delete this item?');"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                class="btn btn-danger-soft btn-sm"><i class="far fa-trash-alt"></i></a></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        -->
                                        @endif
                                    </td>

                                </tr>
                            @endforeach
							
							
				


				
	

	
							
							
							
							
							
							



22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\rejectedlist.blade.php
 								
									
																
									
 {{ $timesheetDatas->staffcode }}
 
									
                                  <td>
                                            @if ($permotioncheck && $datadate && $datadate->greaterThan($permotiondate))
                                                {{ $permotioncheck->newstaff_code }}
                                            @else
                                                {{ $timesheetDatas->staffcode }}
                                            @endif
                                        </td>
										
										
										
									
									
									
									
@if (count((array) $client_id->assignment_name) > 1)
									
                                   <td class="textfixed">
                                        {{ $client_id->assignment_name ?? '' }}
                                        @if ($timesheetDatas->assignmentname != null)
                                            ({{ $timesheetDatas->assignmentname ?? '' }})
                                        @endif
                                        @if (count((array) $client_id->assignment_name) > 1)
                                            ,
                                        @endif
                                    </td>	







  {{ $client_id->staffcode ?? '' }}
  
                                    <td class="textfixed">
                                        @if (in_array($timesheetDatas->client_id, $targetAssignments))
                                            @if (
                                                $rejoindpromotioncheckpartner &&
                                                    $timesheetDatepartner &&
                                                    $timesheetDatepartner->greaterThanOrEqualTo($rejoindpromotioncheckdatepartner))
                                                {{ $rejoindpromotioncheckpartner->newstaff_code }}
                                            @else
                                                {{ $client_id->staffcode ?? '' }}
                                            @endif
                                            @if (count((array) $client_id->team_member) > 1)
                                                ,
                                            @endif
                                        @else
                                            @if ($approverdata && $datadate && $datadate->greaterThan($approverdate))
                                                {{ $approverdata->newstaff_code }}
                                            @else
                                                {{ $client_id->staffcode ?? '' }}
                                            @endif
                                            @if (count((array) $client_id->team_member) > 1)
                                                ,
                                            @endif
                                        @endif
                                    </td>									







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\report\assignmentreport.blade.php

 ->where('teammembers.id', $assignmentmappingDatas->otherpartner)



                                                @php
                                                    $leadpartner = DB::table('teammembers')
                                                        ->leftJoin(
                                                            'teamrolehistory',
                                                            'teamrolehistory.teammember_id',
                                                            '=',
                                                            'teammembers.id',
                                                        )
                                                        ->where('teammembers.id', $assignmentmappingDatas->leadpartner)
                                                        ->select(
                                                            'teammembers.team_member',
                                                            'teammembers.staffcode',
                                                            'teamrolehistory.newstaff_code',
                                                        )
                                                        ->first();

                                                    $otherPartner = DB::table('teammembers')
                                                        ->leftJoin(
                                                            'teamrolehistory',
                                                            'teamrolehistory.teammember_id',
                                                            '=',
                                                            'teammembers.id',
                                                        )
                                                        ->where('teammembers.id', $assignmentmappingDatas->otherpartner)
                                                        ->select(
                                                            'teammembers.team_member',
                                                            'teammembers.staffcode',
                                                            'teamrolehistory.newstaff_code',
                                                        )
                                                        ->first();

                                                @endphp
                                                <td>
                                                    {{ $leadpartner->team_member ?? '' }}
                                                </td>
                                                <td>
                                                    @if ($leadpartner && $leadpartner->team_member)
                                                        {{ $leadpartner->newstaff_code ?? ($leadpartner->staffcode ?? '') }}
                                                    @endif
                                                </td>

                                                <td>
                                                    {{ $otherPartner->team_member ?? '' }}
                                                </td>
                                                <td>
                                                    @if ($otherPartner && $otherPartner->team_member)
                                                        {{ $otherPartner->newstaff_code ?? ($otherPartner->staffcode ?? '') }}
                                                    @endif
                                                </td>
												
												
												
												
												
									

									
												
												
 <td>{{ App\Models\Teammember::select('team_member')->where('id', $assignmentmappingcloseDatas->otherpartner)->first()											
												


                                            @php
                                                $leadpartner = DB::table('teammembers')
                                                    ->leftJoin(
                                                        'teamrolehistory',
                                                        'teamrolehistory.teammember_id',
                                                        '=',
                                                        'teammembers.id',
                                                    )
                                                    ->where('teammembers.id', $assignmentmappingcloseDatas->leadpartner)
                                                    ->select(
                                                        'teammembers.team_member',
                                                        'teammembers.staffcode',
                                                        'teamrolehistory.newstaff_code',
                                                    )
                                                    ->first();

                                                $otherPartner = DB::table('teammembers')
                                                    ->leftJoin(
                                                        'teamrolehistory',
                                                        'teamrolehistory.teammember_id',
                                                        '=',
                                                        'teammembers.id',
                                                    )
                                                    ->where(
                                                        'teammembers.id',
                                                        $assignmentmappingcloseDatas->otherpartner,
                                                    )
                                                    ->select(
                                                        'teammembers.team_member',
                                                        'teammembers.staffcode',
                                                        'teamrolehistory.newstaff_code',
                                                    )
                                                    ->first();

                                            @endphp
                                            <td>
                                                {{ $leadpartner->team_member ?? '' }}
                                            </td>
                                            <td>
                                                @if ($leadpartner && $leadpartner->team_member)
                                                    {{ $leadpartner->newstaff_code ?? ($leadpartner->staffcode ?? '') }}
                                                @endif
                                            </td>

                                            <td>
                                                {{ $otherPartner->team_member ?? '' }}
                                            </td>
                                            <td>
                                                @if ($otherPartner && $otherPartner->team_member)
                                                    {{ $otherPartner->newstaff_code ?? ($otherPartner->staffcode ?? '') }}
                                                @endif
                                            </td>
											
											
					


					
											
											

22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\StepController.php

   public function assignmentviewer()
    {
        $assignmentviwerteams = DB::table('assignmentmappings')
            ->join('assignmentbudgetings', 'assignmentmappings.assignmentgenerate_id', '=', 'assignmentbudgetings.assignmentgenerate_id')
            ->join('assignments', 'assignments.id', '=', 'assignmentbudgetings.assignment_id')
            ->leftjoin('assignmentteammappings', 'assignmentteammappings.assignmentmapping_id', 'assignmentmappings.id')
            ->leftjoin('teammembers', 'teammembers.id', 'assignmentteammappings.teammember_id')
            ->leftJoin('teamrolehistory', function ($join) {
                $join->on('teamrolehistory.teammember_id', '=', 'assignmentteammappings.teammember_id')
                    ->on('teamrolehistory.created_at', '<', 'assignmentteammappings.created_at');
            })
            ->leftjoin('titles', 'titles.id', 'teammembers.title_id')
            ->leftjoin('roles', 'roles.id', 'teammembers.role_id')
            ->where('assignmentteammappings.viewerteam', 1)
            ->select(
                'teammembers.*',
                'roles.rolename',
                'assignmentteammappings.type',
                'titles.title',
                'assignmentteammappings.id As assignmentteammappingsId',
                'assignmentteammappings.status as assignmentteammappingsStatus',
                'assignmentmappings.assignmentgenerate_id as assignmentgenerateid',
                'assignmentteammappings.teamhour',
                'assignmentmappings.leadpartner',
                'teamrolehistory.newstaff_code',
                'assignmentbudgetings.assignmentname',
                'assignments.assignment_name',
                'assignmentteammappings.viewerteam'
            )
            ->get();

        // dd($assignmentviwerteams);

        return view('backEnd.assignmentviewer', compact('assignmentviwerteams'));
    }












22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\AttendanceController.php
 // Fetch single user data


       // Fetch single user data
        // $singleusersearched = DB::table('teammembers')
        //     ->where('id', $teamnid)
        //     ->select('team_member', 'staffcode', 'id', 'leavingdate', 'joining_date')
        //     ->first();

        $singleusersearched = DB::table('teammembers')
            ->where('teammembers.id', $teamnid)
            ->leftJoin(
                'teamrolehistory',
                'teamrolehistory.teammember_id',
                '=',
                'teammembers.id',
            )
            ->leftJoin(
                'rejoiningsamepost',
                'rejoiningsamepost.teammember_id',
                '=',
                'teammembers.id',
            )
            ->select([
                'teammembers.id',
                'teammembers.team_member',
                'teammembers.staffcode',
                'teammembers.joining_date',
                'teammembers.team_member',
                DB::raw(
                    'COALESCE(teamrolehistory.rejoiniedexitdate, rejoiningsamepost.rejoiniedexitdate, teammembers.leavingdate) AS final_leavingdate',
                ),
                DB::raw('COALESCE(teamrolehistory.rejoiningdate, rejoiningsamepost.rejoiningdate,teamrolehistory.promotion_date) AS final_rejoining_date'),
            ])
            ->first();

        // dd($singleusersearched);

        // Check leaving date validation
        if ($singleusersearched && $singleusersearched->final_leavingdate) {
            $final_joiningdate = Carbon::parse($singleusersearched->final_rejoining_date);
            $final_leavingdate = Carbon::parse($singleusersearched->final_leavingdate);
            if ($final_leavingdate->gt($final_joiningdate)) {
                if ($startdate->gt($final_leavingdate)) {
                    $output = ['msg' => 'User left on ' . $final_leavingdate->format('d-m-Y') . ', cannot select beyond this date.'];
                    $request->flash();
                    return redirect()->to('attendance')->with('statuss', $output);
                }
            }
        }










22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\applyleave\adminopen.blade.php
 $permotioncheck = DB::table('teamrolehistory')

                                      @php
                                        $teamMembers = DB::table('teamrolehistory')
                                            ->whereIn('teammember_id', [
                                                $applyleaveDatas->createdby,
                                                $applyleaveDatas->approver,
                                            ])
                                            ->get()
                                            ->keyBy('teammember_id');

                                        $datadate = $applyleaveDatas->created_at
                                            ? Carbon\Carbon::createFromFormat(
                                                'Y-m-d H:i:s',
                                                $applyleaveDatas->created_at,
                                            )
                                            : null;

                                        $permotioncheck = $teamMembers[$applyleaveDatas->createdby] ?? null;
                                        $approverdata = $teamMembers[$applyleaveDatas->approver] ?? null;

                                        $permotiondate = $permotioncheck
                                            ? Carbon\Carbon::createFromFormat(
                                                'Y-m-d H:i:s',
                                                $permotioncheck->created_at,
                                            )
                                            : null;
                                        $approverdate = $approverdata
                                            ? Carbon\Carbon::createFromFormat('Y-m-d H:i:s', $approverdata->created_at)
                                            : null;
                                    @endphp
									
	









	

 {{ $applyleaveDatas->staffcode }}

					
	                                 <td>
                                        @if ($permotioncheck && $datadate && $datadate->greaterThan($permotiondate))
                                            {{ $permotioncheck->newstaff_code }}
                                        @else
                                            {{ $applyleaveDatas->staffcode }}
                                        @endif
                                    </td>	

									
								

								
	


	
									
				





				
 {{ App\Models\Teammember::select('team_member', 'staffcode')->where('id', $applyleaveDatas->approver)->first()->staffcode ?? '' }}									
									
									

                                     <td class="textfixed">
                                        {{ App\Models\Teammember::select('team_member')->where('id', $applyleaveDatas->approver)->first()->team_member ?? '' }}
                                    </td>
                                    <td>
                                        @if ($approverdata && $datadate && $datadate->greaterThan($approverdate))
                                            {{ $approverdata->newstaff_code }}
                                        @else
                                            {{ App\Models\Teammember::select('team_member', 'staffcode')->where('id', $applyleaveDatas->approver)->first()->staffcode ?? '' }}
                                        @endif
                                    </td>
									
									
									
									
									
									
									
									
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\applyleave\index.blade.php
 <td>{{ $applyleaveDatas->staffcode }}</td>
 

                                              <td> {{ $applyleaveDatas->newstaff_code ?? ($applyleaveDatas->staffcode ?? '') }}
                                            </td>
											  
											  
											  
											  
											  
		

		

22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php
 public function index()
 } else {
 
 
        $teamapplyleaveDatas  = DB::table('applyleaves')
        ->leftjoin('leavetypes', 'leavetypes.id', 'applyleaves.leavetype')
        ->leftjoin('teammembers', 'teammembers.id', 'applyleaves.createdby')
        ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
          $join->on('teamrolehistoryteam.teammember_id', '=', 'applyleaves.createdby')
            ->on('teamrolehistoryteam.created_at', '<', 'applyleaves.created_at');
        })
        ->leftjoin('roles', 'roles.id', 'teammembers.role_id')
        ->where('applyleaves.approver', auth()->user()->teammember_id)
        ->select('applyleaves.*', 'teammembers.team_member', 'teammembers.staffcode', 'roles.rolename', 'leavetypes.name', 'teamrolehistoryteam.newstaff_code')->get();








 public function index()
 } elseif ($permotioncheck && auth()->user()->role_id == 13) {



      $teamapplyleaveDatas  = DB::table('applyleaves')
        ->leftjoin('leavetypes', 'leavetypes.id', 'applyleaves.leavetype')
        ->leftjoin('teammembers', 'teammembers.id', 'applyleaves.createdby')
        ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
          $join->on('teamrolehistoryteam.teammember_id', '=', 'applyleaves.createdby')
            ->on('teamrolehistoryteam.created_at', '<', 'applyleaves.created_at');
        })
        ->leftjoin('roles', 'roles.id', 'teammembers.role_id')
        ->where('applyleaves.approver', auth()->user()->teammember_id)
        ->select('applyleaves.*', 'teammembers.team_member', 'teammembers.staffcode', 'roles.rolename', 'leavetypes.name', 'teamrolehistoryteam.newstaff_code')->get();

      $hasPendingRequests = $teamapplyleaveDatas->contains('status', 0);









22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\applyleave\examrequestlist.blade.php
 @foreach ($timesheetrequestsDatas as $timesheetrequestsData)
 
                                         @php
                                                $teamMembers = DB::table('teamrolehistory')
                                                    ->whereIn('teammember_id', [
                                                        $timesheetrequestsData->createdby,
                                                        $timesheetrequestsData->approver,
                                                    ])
                                                    ->get()
                                                    ->keyBy('teammember_id');

                                                $datadate = $timesheetrequestsData->created_at
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $timesheetrequestsData->created_at,
                                                    )
                                                    : null;

                                                $permotioncheck =
                                                    $teamMembers[$timesheetrequestsData->createdby] ?? null;
                                                $approverdata = $teamMembers[$timesheetrequestsData->approver] ?? null;

                                                $permotiondate = $permotioncheck
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $permotioncheck->created_at,
                                                    )
                                                    : null;
                                                $approverdate = $approverdata
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $approverdata->created_at,
                                                    )
                                                    : null;
                                            @endphp
											
										







										
 {{ $timesheetrequestsData->teamstaffcode }}
 
                                         <td>
                                                @if ($permotioncheck && $datadate && $datadate->greaterThan($permotiondate))
                                                    {{ $permotioncheck->newstaff_code }}
                                                @else
                                                    {{ $timesheetrequestsData->teamstaffcode }}
                                                @endif
                                            </td>
											
											
											



		


 {{ $timesheetrequestsData->staffcode }}
 
 
                                           <td>
                                                @if ($approverdata && $datadate && $datadate->greaterThan($approverdate))
                                                    {{ $approverdata->newstaff_code }}
                                                @else
                                                    {{ $timesheetrequestsData->staffcode }}
                                                @endif
                                            </td
											
											
											
											





											

22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\applyleave\examrequestlist.blade.php
 @foreach ($myteamtimesheetrequestsDatas as $timesheetrequestsDatass)
                   
				   
                                             @php
                                                $teamMembers = DB::table('teamrolehistory')
                                                    ->whereIn('teammember_id', [
                                                        $timesheetrequestsDatass->createdby,
                                                        $timesheetrequestsDatass->approver,
                                                    ])
                                                    ->get()
                                                    ->keyBy('teammember_id');

                                                $datadate = $timesheetrequestsDatass->created_at
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $timesheetrequestsDatass->created_at,
                                                    )
                                                    : null;

                                                $permotioncheck =
                                                    $teamMembers[$timesheetrequestsDatass->createdby] ?? null;
                                                $approverdata =
                                                    $teamMembers[$timesheetrequestsDatass->approver] ?? null;

                                                $permotiondate = $permotioncheck
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $permotioncheck->created_at,
                                                    )
                                                    : null;
                                                $approverdate = $approverdata
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $approverdata->created_at,
                                                    )
                                                    : null;
                                            @endphp








 {{ $timesheetrequestsDatass->teamstaffcode }}

                                            <td>
                                                @if ($permotioncheck && $datadate && $datadate->greaterThan($permotiondate))
                                                    {{ $permotioncheck->newstaff_code }}
                                                @else
                                                    {{ $timesheetrequestsDatass->teamstaffcode }}
                                                @endif
                                            </td>
											
											
			

			







{{ $timesheetrequestsDatass->staffcode }}

                                            <td>
                                                @if ($approverdata && $datadate && $datadate->greaterThan($approverdate))
                                                    {{ $approverdata->newstaff_code }}
                                                @else
                                                    {{ $timesheetrequestsDatass->staffcode }}
                                                @endif
                                            </td>										






22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheetrequest\teamtimesheetrequest.blade.php
  @foreach ($teamtimesheetrequest as $timesheetrequestsData)
  
                                           @php
                                                $teamMembers = DB::table('teamrolehistory')
                                                    ->whereIn('teammember_id', [
                                                        $timesheetrequestsData->createdby,
                                                        $timesheetrequestsData->partner,
                                                    ])
                                                    ->get()
                                                    ->keyBy('teammember_id');

                                                $datadate = $timesheetrequestsData->created_at
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $timesheetrequestsData->created_at,
                                                    )
                                                    : null;

                                                $permotioncheck =
                                                    $teamMembers[$timesheetrequestsData->createdby] ?? null;
                                                $approverdata = $teamMembers[$timesheetrequestsData->partner] ?? null;

                                                $permotiondate = $permotioncheck
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $permotioncheck->created_at,
                                                    )
                                                    : null;
                                                $approverdate = $approverdata
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $approverdata->created_at,
                                                    )
                                                    : null;
                                            @endphp
											
											
											
											
											
											
@foreach ($teamtimesheetrequest as $timesheetrequestsData)										
   {{ $timesheetrequestsData->staffcodeid }}
   
                                            <td>
                                                @if ($permotioncheck && $datadate && $datadate->greaterThan($permotiondate))
                                                    {{ $permotioncheck->newstaff_code }}
                                                @else
                                                    {{ $timesheetrequestsData->staffcodeid }}
                                                @endif
                                            </td>
											
											
											
			

			
											
@foreach ($teamtimesheetrequest as $timesheetrequestsData)											
	 {{ $timesheetrequestsData->staffcode }}										
											
                                           <td>
                                                @if ($approverdata && $datadate && $datadate->greaterThan($approverdate))
                                                    {{ $approverdata->newstaff_code }}
                                                @else
                                                    {{ $timesheetrequestsData->staffcode }}
                                                @endif
                                            </td>										
											











22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php
  public function timesheet_teamlist()
  
  
  if (auth()->user()->role_id == 13) {

   $get_datess = DB::table('timesheetreport')
        ->leftJoin('teammembers', 'teammembers.id', 'timesheetreport.teamid')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'teammembers.id')
            ->on('teamrolehistory.created_at', '<', 'timesheetreport.created_at');
        })
        ->leftJoin('teammembers as partners', 'partners.id', 'timesheetreport.partnerid')
        ->where('timesheetreport.partnerid', auth()->user()->teammember_id)
        ->whereColumn('timesheetreport.teamid', '!=', 'timesheetreport.partnerid')
        ->select('timesheetreport.*', 'teammembers.team_member', 'teammembers.staffcode', 'partners.team_member as partnername', 'teammembers.emailid', 'teamrolehistory.newstaff_code')
        ->latest()
        ->get();
		
		
		
		
		
and replace 

 return (object)[
        'id' => $firstItem->id,
        'teamid' => $firstItem->teamid,
        'emailid' => $firstItem->emailid,
        'week' => $firstItem->week,
        'totaldays' => $group->sum('totaldays'),
        'totaltime' => $group->sum('totaltime'),
        'dayscount' => $group->sum('dayscount'),
        'startdate' => $firstItem->startdate,
        'enddate' => $firstItem->enddate,
        'partnername' => $firstItem->partnername,
        'created_at' => $firstItem->created_at,
        'team_member' => $firstItem->team_member,
        'partnerid' => $firstItem->partnerid,
        'staffcode' => $firstItem->newstaff_code ?? $firstItem->staffcode,
      ];







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php

public function filterDataAdmin(Request $request)
elseif (auth()->user()->role_id == 13 && $path == '/timesheet/teamlist') {



     $query = DB::table('timesheetreport')
        ->leftjoin('teammembers', 'teammembers.id', 'timesheetreport.teamid')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'teammembers.id')
            ->on('teamrolehistory.created_at', '<', 'timesheetreport.created_at');
        })
        ->leftjoin('teammembers as partners', 'partners.id', 'timesheetreport.partnerid')
        ->where('timesheetreport.partnerid', auth()->user()->teammember_id)
        // ->whereJsonContains('timesheetreport.partnerid', auth()->user()->teammember_id)
        ->select('timesheetreport.*', 'teammembers.team_member', 'partners.team_member as partnername', 'teammembers.staffcode', 'teamrolehistory.newstaff_code')
        ->orderBy('timesheetreport.startdate', 'desc');

		
		
		
		
		
		
		
		
		
		
and find 
  if (auth()->user()->role_id != 11) {
  
  
  
        return (object)[
          'id' => $firstItem->id,
          'teamid' => $firstItem->teamid,
          'week' => $firstItem->week,
          'totaldays' => $group->sum('totaldays'),
          'totaltime' => $group->sum('totaltime'),
          'startdate' => $firstItem->startdate,
          'enddate' => $firstItem->enddate,
          'partnername' => $firstItem->partnername,
          'created_at' => $firstItem->created_at,
          'team_member' => $firstItem->team_member,
          'staffcode' => $firstItem->newstaff_code ?? $firstItem->staffcode,
          'partnerid' => $firstItem->partnerid,
        ];






22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php

   public function filterDataAdmin(Request $request)
  {
    $urlheader = $request->headers->get('referer');
    $url = parse_url($urlheader);
    $path = $url['path'];
    // dd($url);
    // this is for patner submitted timesheet 
    if (auth()->user()->role_id == 13 && $path == '/timesheet/partnersubmitted') {
      // dd('patner');
      $teamname = $request->input('teamname');
      $start = $request->input('start');
      $end = $request->input('end');
      $totalhours = $request->input('totalhours');
      $partnerId = $request->input('partnersearch');


      $query = DB::table('timesheetreport')
        ->leftjoin('teammembers', 'teammembers.id', 'timesheetreport.teamid')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'teammembers.id')
            ->on('teamrolehistory.created_at', '<', 'timesheetreport.created_at');
        })
        ->leftjoin('teammembers as partners', 'partners.id', 'timesheetreport.partnerid')
        ->where('timesheetreport.teamid', auth()->user()->teammember_id)
        ->select('timesheetreport.*', 'teammembers.team_member', 'partners.team_member as partnername', 'teammembers.staffcode', 'teamrolehistory.newstaff_code')
        ->latest();

      // teamname with othser field to  filter
      if ($teamname) {
        $query->where('timesheetreport.teamid', $teamname);
      }

      if ($teamname && $totalhours) {
        $query->where(function ($q) use ($teamname, $totalhours) {
          $q->where('timesheetreport.teamid', $teamname)
            ->where('timesheetreport.totaltime', $totalhours);
        });
      }
      if ($teamname && $partnerId) {
        $query->where(function ($q) use ($teamname, $partnerId) {
          $q->where('timesheetreport.teamid', $teamname)
            ->where('timesheetreport.partnerid', $partnerId);
        });
      }

      // patner or othse one data
      if ($partnerId) {
        $query->where('timesheetreport.partnerid', $partnerId);
      }

      if ($partnerId && $totalhours) {
        $query->where(function ($q) use ($partnerId, $totalhours) {
          $q->where('timesheetreport.partnerid', $partnerId)
            ->where('timesheetreport.totaltime', $totalhours);
        });
      }

      // total hour wise  wise or othser data
      if ($totalhours) {
        $query->where('timesheetreport.totaltime', $totalhours);
      }
      //! end date 
      if ($start && $end) {
        $query->where(function ($query) use ($start, $end) {
          $query->whereBetween('timesheetreport.startdate', [$start, $end])
            ->orWhereBetween('timesheetreport.enddate', [$start, $end])
            ->orWhere(function ($query) use ($start, $end) {
              $query->where('timesheetreport.startdate', '<=', $start)
                ->where('timesheetreport.enddate', '>=', $end);
            });
        });
      }
    }
    // this is for team submitted timesheet on patner
    elseif (auth()->user()->role_id == 13 && $path == '/timesheet/teamlist') {
      // dd($request);
      // dd('team');
      $teamname = $request->input('teamname');
      $start = $request->input('start');
      $end = $request->input('end');
      $totalhours = $request->input('totalhours');
      $partnerId = $request->input('partnersearch');


      $query = DB::table('timesheetreport')
        ->leftjoin('teammembers', 'teammembers.id', 'timesheetreport.teamid')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'teammembers.id')
            ->on('teamrolehistory.created_at', '<', 'timesheetreport.created_at');
        })
        ->leftjoin('teammembers as partners', 'partners.id', 'timesheetreport.partnerid')
        ->where('timesheetreport.partnerid', auth()->user()->teammember_id)
        // ->whereJsonContains('timesheetreport.partnerid', auth()->user()->teammember_id)
        ->select('timesheetreport.*', 'teammembers.team_member', 'partners.team_member as partnername', 'teammembers.staffcode', 'teamrolehistory.newstaff_code')
        ->orderBy('timesheetreport.startdate', 'desc');



      // teamname with othser field to  filter
      if ($teamname) {
        $query->where('timesheetreport.teamid', $teamname);
      }

      if ($teamname && $totalhours) {
        $query->where(function ($q) use ($teamname, $totalhours) {
          $q->where('timesheetreport.teamid', $teamname)
            ->where('timesheetreport.totaltime', $totalhours);
        });
      }
      if ($teamname && $partnerId) {
        $query->where(function ($q) use ($teamname, $partnerId) {
          $q->where('timesheetreport.teamid', $teamname)
            ->where('timesheetreport.partnerid', $partnerId);
        });
      }

      // patner or othse one data
      if ($partnerId) {
        $query->where('timesheetreport.partnerid', $partnerId);
      }

      if ($partnerId && $totalhours) {
        $query->where(function ($q) use ($partnerId, $totalhours) {
          $q->where('timesheetreport.partnerid', $partnerId)
            ->where('timesheetreport.totaltime', $totalhours);
        });
      }

      // total hour wise  wise or othser data
      if ($totalhours) {
        $query->where('timesheetreport.totaltime', $totalhours);
      }
      //! end date 
      if ($start && $end) {
        $query->where(function ($query) use ($start, $end) {
          $query->whereBetween('timesheetreport.startdate', [$start, $end])
            ->orWhereBetween('timesheetreport.enddate', [$start, $end])
            ->orWhere(function ($query) use ($start, $end) {
              $query->where('timesheetreport.startdate', '<=', $start)
                ->where('timesheetreport.enddate', '>=', $end);
            });
        });
      }
    }
    // this is for submitted timesheet on staff and manager 
    elseif (auth()->user()->role_id == 14 || auth()->user()->role_id == 15) {
      // dd($request);
      $teamname = $request->input('teamname');
      $start = $request->input('start');
      $end = $request->input('end');
      $totalhours = $request->input('totalhours');
      $partnerId = $request->input('partnersearch');


      $query = DB::table('timesheetreport')
        ->leftjoin('teammembers', 'teammembers.id', 'timesheetreport.teamid')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'teammembers.id')
            ->on('teamrolehistory.created_at', '<', 'timesheetreport.created_at');
        })
        ->leftjoin('teammembers as partners', 'partners.id', 'timesheetreport.partnerid')
        ->where('timesheetreport.teamid', auth()->user()->teammember_id)
        ->select('timesheetreport.*', 'teammembers.team_member', 'partners.team_member as partnername', 'teammembers.staffcode', 'teamrolehistory.newstaff_code')
        ->latest();

      // teamname with othser field to  filter
      if ($teamname) {
        $query->where('timesheetreport.teamid', $teamname);
      }

      if ($teamname && $totalhours) {
        $query->where(function ($q) use ($teamname, $totalhours) {
          $q->where('timesheetreport.teamid', $teamname)
            ->where('timesheetreport.totaltime', $totalhours);
        });
      }
      if ($teamname && $partnerId) {
        $query->where(function ($q) use ($teamname, $partnerId) {
          $q->where('timesheetreport.teamid', $teamname)
            ->where('timesheetreport.partnerid', $partnerId);
        });
      }

      // patner or othse one data
      if ($partnerId) {
        $query->where('timesheetreport.partnerid', $partnerId);
      }

      if ($partnerId && $totalhours) {
        $query->where(function ($q) use ($partnerId, $totalhours) {
          $q->where('timesheetreport.partnerid', $partnerId)
            ->where('timesheetreport.totaltime', $totalhours);
        });
      }

      // total hour wise  wise or othser data
      if ($totalhours) {
        $query->where('timesheetreport.totaltime', $totalhours);
      }
      //! end date 
      if ($start && $end) {
        $query->where(function ($query) use ($start, $end) {
          $query->whereBetween('timesheetreport.startdate', [$start, $end])
            ->orWhereBetween('timesheetreport.enddate', [$start, $end])
            ->orWhere(function ($query) use ($start, $end) {
              $query->where('timesheetreport.startdate', '<=', $start)
                ->where('timesheetreport.enddate', '>=', $end);
            });
        });
      }
    }
    // this is for team submitted timesheet on Admin
    else {
      // dd(auth()->user()->role_id);
      $teamname = $request->input('teamname');
      $start = $request->input('start');
      $end = $request->input('end');
      $totalhours = $request->input('totalhours');
      $partnerId = $request->input('partnersearch');

      $query = DB::table('timesheetreport')
        ->leftjoin('teammembers', 'teammembers.id', 'timesheetreport.teamid')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'teammembers.id')
            ->on('teamrolehistory.created_at', '<', 'timesheetreport.created_at');
        })
        ->leftjoin('teammembers as partners', 'partners.id', 'timesheetreport.partnerid')
        ->select('timesheetreport.*', 'teammembers.team_member', 'partners.team_member as partnername', 'teammembers.staffcode', 'teamrolehistory.newstaff_code')
        ->orderBy('timesheetreport.startdate', 'desc');

      // teamname with othser field to  filter
      if ($teamname) {
        $query->where('timesheetreport.teamid', $teamname);
      }

      if ($teamname && $totalhours) {
        $query->where(function ($q) use ($teamname, $totalhours) {
          $q->where('timesheetreport.teamid', $teamname)
            ->where('timesheetreport.totaltime', $totalhours);
        });
      }
      if ($teamname && $partnerId) {
        $query->where(function ($q) use ($teamname, $partnerId) {
          $q->where('timesheetreport.teamid', $teamname)
            ->where('timesheetreport.partnerid', $partnerId);
        });
      }

      // patner or othse one data
      if ($partnerId) {
        $query->where('timesheetreport.partnerid', $partnerId);
      }

      if ($partnerId && $totalhours) {
        $query->where(function ($q) use ($partnerId, $totalhours) {
          $q->where('timesheetreport.partnerid', $partnerId)
            ->where('timesheetreport.totaltime', $totalhours);
        });
      }

      // total hour wise  wise or othser data
      if ($totalhours) {
        $query->where('timesheetreport.totaltime', $totalhours);
      }
      //! end date 
      if ($start && $end) {
        $query->where(function ($query) use ($start, $end) {
          $query->whereBetween('timesheetreport.startdate', [$start, $end])
            ->orWhereBetween('timesheetreport.enddate', [$start, $end])
            ->orWhere(function ($query) use ($start, $end) {
              $query->where('timesheetreport.startdate', '<=', $start)
                ->where('timesheetreport.enddate', '>=', $end);
            });
        });
      }

      $filteredDataaa = $query->get();

      // maping double date ************
      $groupedData = $filteredDataaa->groupBy(function ($item) {
        return $item->team_member . '|' . $item->week;
      })->map(function ($group) {
        $firstItem = $group->first();

        return (object)[
          'id' => $firstItem->id,
          'teamid' => $firstItem->teamid,
          'week' => $firstItem->week,
          'totaldays' => $group->sum('totaldays'),
          'totaltime' => $group->sum('totaltime'),
          'dayscount' => $group->sum('dayscount'),
          'startdate' => $firstItem->startdate,
          'enddate' => $firstItem->enddate,
          'partnername' => $firstItem->partnername,
          'created_at' => $firstItem->created_at,
          'team_member' => $firstItem->team_member,
          'staffcode' => $firstItem->newstaff_code ?? $firstItem->staffcode,
          'partnerid' => $firstItem->partnerid,
        ];
      });

      $filteredData = collect($groupedData->values());
      // dd($filteredData);
      return response()->json($filteredData);
    }

    if (auth()->user()->role_id != 11) {
      $filteredDataaa = $query->get();

      // maping double date ************
      $groupedData = $filteredDataaa->groupBy(function ($item) {
        return $item->team_member . '|' . $item->week;
      })->map(function ($group) {
        $firstItem = $group->first();

        return (object)[
          'id' => $firstItem->id,
          'teamid' => $firstItem->teamid,
          'week' => $firstItem->week,
          'totaldays' => $group->sum('totaldays'),
          'totaltime' => $group->sum('totaltime'),
          'startdate' => $firstItem->startdate,
          'enddate' => $firstItem->enddate,
          'partnername' => $firstItem->partnername,
          'created_at' => $firstItem->created_at,
          'team_member' => $firstItem->team_member,
          'staffcode' => $firstItem->newstaff_code ?? $firstItem->staffcode,
          'partnerid' => $firstItem->partnerid,
        ];
      });

      $filteredData = collect($groupedData->values());
      return response()->json($filteredData);
    }
  }












22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php

 public function weeklylist(Request $request)
  {
    // dd($request);
    if (auth()->user()->role_id == 13) {
      $date = DB::table('timesheetreport')->where('id', $request->id)->first();

      $promotionCheck = DB::table('teamrolehistory')
        ->where('teammember_id', $request->teamid)
        ->select('newstaff_code', 'created_at')
        ->first();

      $promotionorRejoinDate = $promotionCheck
        ? Carbon::parse($promotionCheck->created_at)->startOfDay()
        : null;

      $timesheetData = DB::table('timesheetusers')
        ->leftjoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
        ->leftjoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
        ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
          $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
            ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
        })
        ->leftjoin('clients', 'clients.id', 'timesheetusers.client_id')
        ->leftjoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
        ->leftjoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
            ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
        })
        ->where('timesheetusers.createdby', $request->teamid)
        ->whereIn('timesheetusers.status', [1, 2, 3])
        ->whereNotNull('timesheetusers.date')
        ->where('timesheetusers.date', '>=', $date->startdate)
        ->where('timesheetusers.date', '<=', $date->enddate)
        ->select(
          'timesheetusers.*',
          'assignments.assignment_name',
          'clients.client_name',
          'clients.client_code',
          'teammembers.team_member',
          'teammembers.staffcode',
          'patnerid.team_member as patnername',
          'patnerid.staffcode as patnerstaffcodee',
          'assignmentbudgetings.assignmentname',
          'teamrolehistory.newstaff_code as ptnrstaffcode',
          'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
          'assignmentbudgetings.created_at as assignmentcreated'
        )
        // ->orderBy('timesheetusers.id', 'ASC')
        ->orderBy('timesheetusers.date', 'DESC')
        ->get();

      $timesheetData = $this->promotionOrRejoined($timesheetData, $promotionCheck, $promotionorRejoinDate);
    } else {
      $date = DB::table('timesheetreport')->where('id', $request->id)->first();

      $promotionCheck = DB::table('teamrolehistory')
        ->where('teammember_id', $request->teamid)
        ->select('newstaff_code', 'created_at')
        ->first();

      $promotionorRejoinDate = $promotionCheck
        ? Carbon::parse($promotionCheck->created_at)->startOfDay()
        : null;

      $timesheetData = DB::table('timesheetusers')
        ->leftJoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
        ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
        ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
          $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
            ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
        })
        ->leftJoin('clients', 'clients.id', 'timesheetusers.client_id')
        ->leftJoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
        ->leftJoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
            ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
        })
        ->where('timesheetusers.createdby', $request->teamid)
        ->whereIn('timesheetusers.status', [1, 2, 3])
        ->whereNotNull('timesheetusers.date')
        ->whereBetween('timesheetusers.date', [$date->startdate, $date->enddate])
        ->select(
          'timesheetusers.*',
          'assignments.assignment_name',
          'clients.client_name',
          'clients.client_code',
          'teammembers.team_member',
          'teammembers.staffcode',
          'patnerid.team_member as patnername',
          'patnerid.staffcode as patnerstaffcodee',
          'assignmentbudgetings.assignmentname',
          'teamrolehistory.newstaff_code as ptnrstaffcode',
          'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
          'assignmentbudgetings.created_at as assignmentcreated'
        )
        // ->orderBy('timesheetusers.id', 'ASC')
        ->orderBy('timesheetusers.date', 'DESC')
        ->get();

      $timesheetData = $this->promotionOrRejoined($timesheetData, $promotionCheck, $promotionorRejoinDate);
    }
    return view('backEnd.timesheet.weeklylist', compact('timesheetData'));
  }






22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\rejectedlistteam.blade.php
@foreach ($timesheetData as $timesheetDatas)
 $dates = date('l', strtotime($timesheetDatas->date));



                                    $dates = date('l', strtotime($timesheetDatas->date));

                                        $targetAssignments = [29, 34, 32, 33, 134];
                                        if (in_array($timesheetDatas->client_id, $targetAssignments)) {
                                            $rejoindpromotioncheck = DB::table('teamrolehistory')
                                                ->where('teammember_id', $timesheetDatas->createdby)
                                                ->first();

                                            $timesheetDate = $timesheetDatas->date
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d',
                                                    $timesheetDatas->date,
                                                )->startOfDay()
                                                : null;

                                            $rejoindpromotioncheckdate = null;
                                            if ($rejoindpromotioncheck) {
                                                $rejoindpromotioncheckdate = Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $rejoindpromotioncheck->created_at,
                                                )->startOfDay();
                                            }
                                        } else {
                                            $assignmentcheck = DB::table('assignmentbudgetings')
                                                ->where('assignmentgenerate_id', $timesheetDatas->assignmentgenerate_id)
                                                ->first();

                                            $teamMembers = DB::table('teamrolehistory')
                                                ->whereIn('teammember_id', [
                                                    $timesheetDatas->createdby,
                                                    $timesheetDatas->partner,
                                                ])
                                                ->get()
                                                ->keyBy('teammember_id');

                                            $datadate = $assignmentcheck
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $assignmentcheck->created_at,
                                                )
                                                : null;

                                            // dd($teamMembers);

                                            $permotioncheck = $teamMembers[$timesheetDatas->createdby] ?? null;
                                            $approverdata = $teamMembers[$timesheetDatas->partner] ?? null;

                                            $permotiondate = $permotioncheck
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $permotioncheck->created_at,
                                                )
                                                : null;
                                            $approverdate = $approverdata
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $approverdata->created_at,
                                                )
                                                : null;
                                        }

                                    @endphp




                                    <td>
                                        @if (in_array($timesheetDatas->client_id, $targetAssignments))
                                            @if ($rejoindpromotioncheck && $timesheetDate && $timesheetDate->greaterThanOrEqualTo($rejoindpromotioncheckdate))
                                                {{ $rejoindpromotioncheck->newstaff_code }}
                                            @else
                                                {{ $timesheetDatas->staffcode }}
                                            @endif
                                        @else
                                            @if ($permotioncheck && $datadate && $datadate->greaterThan($permotiondate))
                                                {{ $permotioncheck->newstaff_code }}
                                            @else
                                                {{ $timesheetDatas->staffcode }}
                                            @endif
                                        @endif
                                    </td>
									
									
									






                                        <td>
                                            @foreach ($client_id as $item)
                                                @php
                                                    if (in_array($item->client_id, $targetAssignments)) {
                                                        // partner code
                                                        $rejoindpromotioncheckpartner = DB::table('teamrolehistory')
                                                            ->where('teammember_id', $item->partner)
                                                            ->first();

                                                        $timesheetDatepartner = $item->date
                                                            ? Carbon\Carbon::createFromFormat(
                                                                'Y-m-d',
                                                                $item->date,
                                                            )->startOfDay()
                                                            : null;

                                                        $rejoindpromotioncheckdatepartner = null;
                                                        if ($rejoindpromotioncheckpartner) {
                                                            $rejoindpromotioncheckdatepartner = Carbon\Carbon::createFromFormat(
                                                                'Y-m-d H:i:s',
                                                                $rejoindpromotioncheckpartner->created_at,
                                                            )->startOfDay();
                                                        }
                                                    }
                                                @endphp
                                                @if (in_array($item->client_id, $targetAssignments))
                                                    @if (
                                                        $rejoindpromotioncheckpartner &&
                                                            $timesheetDatepartner &&
                                                            $timesheetDatepartner->greaterThanOrEqualTo($rejoindpromotioncheckdatepartner))
                                                        {{ $rejoindpromotioncheckpartner->newstaff_code }}
                                                    @else
                                                        {{ $item->staffcode ?? '' }}
                                                    @endif
                                                    @if ($item->staffcode != null)
                                                        ,
                                                    @endif
                                                @else
                                                    @if ($approverdata && $datadate && $datadate->greaterThan($approverdate))
                                                        {{ $approverdata->newstaff_code }}
                                                    @else
                                                        {{ $item->staffcode ?? '' }}
                                                    @endif
                                                    @if ($item->staffcode != null)
                                                        ,
                                                    @endif
                                                @endif
                                            @endforeach
                                        </td>
										











										


22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\applyleave\openindex.blade.php
       @foreach ($teamapplyleaveDatas as $applyleaveDatas)
	   
	  after tr add this code

                                     @php
                                              $teamMembers = DB::table('teamrolehistory')
                                                  ->whereIn('teammember_id', [
                                                      $applyleaveDatas->createdby,
                                                      $applyleaveDatas->approver,
                                                  ])
                                                  ->get()
                                                  ->keyBy('teammember_id');

                                              $datadate = $applyleaveDatas->created_at
                                                  ? Carbon\Carbon::createFromFormat(
                                                      'Y-m-d H:i:s',
                                                      $applyleaveDatas->created_at,
                                                  )
                                                  : null;

                                              $permotioncheck = $teamMembers[$applyleaveDatas->createdby] ?? null;
                                              $approverdata = $teamMembers[$applyleaveDatas->approver] ?? null;

                                              $permotiondate = $permotioncheck
                                                  ? Carbon\Carbon::createFromFormat(
                                                      'Y-m-d H:i:s',
                                                      $permotioncheck->created_at,
                                                  )
                                                  : null;
                                              $approverdate = $approverdata
                                                  ? Carbon\Carbon::createFromFormat(
                                                      'Y-m-d H:i:s',
                                                      $approverdata->created_at,
                                                  )
                                                  : null;
                                          @endphp







 {{ $applyleaveDatas->staffcode ?? '' }}

                                         <td>
                                              @if ($permotioncheck && $datadate && $datadate->greaterThan($permotiondate))
                                                  {{ $permotioncheck->newstaff_code }}
                                              @else
                                                  {{ $applyleaveDatas->staffcode ?? '' }}
                                              @endif
                                          </td>






22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheetrequest\teamtimesheetrequest.blade.php
@foreach ($mytimesheetrequest as $timesheetrequestsData)
                                   
								   
                                                @php
                                                    $teamMembers = DB::table('teamrolehistory')
                                                        ->whereIn('teammember_id', [
                                                            $timesheetrequestsData->createdby,
                                                            $timesheetrequestsData->partner,
                                                        ])
                                                        ->get()
                                                        ->keyBy('teammember_id');

                                                    $datadate = $timesheetrequestsData->created_at
                                                        ? Carbon\Carbon::createFromFormat(
                                                            'Y-m-d H:i:s',
                                                            $timesheetrequestsData->created_at,
                                                        )
                                                        : null;

                                                    $permotioncheck =
                                                        $teamMembers[$timesheetrequestsData->createdby] ?? null;
                                                    $approverdata =
                                                        $teamMembers[$timesheetrequestsData->partner] ?? null;

                                                    $permotiondate = $permotioncheck
                                                        ? Carbon\Carbon::createFromFormat(
                                                            'Y-m-d H:i:s',
                                                            $permotioncheck->created_at,
                                                        )
                                                        : null;
                                                    $approverdate = $approverdata
                                                        ? Carbon\Carbon::createFromFormat(
                                                            'Y-m-d H:i:s',
                                                            $approverdata->created_at,
                                                        )
                                                        : null;
                                                @endphp
												
											
											
											

											
												
	  {{ $timesheetrequestsData->staffcodeid }}
	  
				                               <td>
                                                    @if ($permotioncheck && $datadate && $datadate->greaterThan($permotiondate))
                                                        {{ $permotioncheck->newstaff_code }}
                                                    @else
                                                        {{ $timesheetrequestsData->staffcodeid }}
                                                    @endif
                                                </td>		

												
												

 {{ $timesheetrequestsData->staffcode }}
 
 
                                          <td>
                                                    @if ($approverdata && $datadate && $datadate->greaterThan($approverdate))
                                                        {{ $approverdata->newstaff_code }}
                                                    @else
                                                        {{ $timesheetrequestsData->staffcode }}
                                                    @endif
                                                </td>
												
												
												
	
	
	
	
	
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\index.blade.php
  @foreach ($timesheetData as $timesheetDatas)
                      
                                        @php
                                            $timeid = DB::table('timesheetusers')
                                                ->where('timesheetusers.id', $timesheetDatas->id)
                                                ->first();

                                            // $client_id = DB::table('timesheetusers')
                                            //     ->leftjoin('clients', 'clients.id', 'timesheetusers.client_id')
                                            //     ->leftjoin(
                                            //         'assignmentbudgetings',
                                            //         'assignmentbudgetings.assignment_id',
                                            //         'timesheetusers.assignment_id',
                                            //     )
                                            //     ->leftjoin(
                                            //         'assignments',
                                            //         'assignments.id',
                                            //         'timesheetusers.assignment_id',
                                            //     )
                                            //     ->leftjoin('teammembers', 'teammembers.id', 'timesheetusers.partner')
                                            //     ->leftJoin('teamrolehistory', function ($join) {
                                            //         $join
                                            //             ->on('teamrolehistory.teammember_id', '=', 'teammembers.id')
                                            //             ->on(
                                            //                 'teamrolehistory.created_at',
                                            //                 '<',
                                            //                 'timesheetusers.created_at',
                                            //             );
                                            //     })
                                            //     ->where('timesheetusers.id', $timesheetDatas->id)
                                            //     ->select(
                                            //         'clients.client_name',
                                            //         'clients.client_code',
                                            //         'timesheetusers.hour',
                                            //         'timesheetusers.location',
                                            //         'timesheetusers.status',
                                            //         'assignments.assignment_name',
                                            //         'billable_status',
                                            //         'workitem',
                                            //         'teammembers.team_member',
                                            //         'teammembers.staffcode',
                                            //         'teamrolehistory.newstaff_code',
                                            //         'assignmentbudgetings.assignmentname',
                                            //         'assignmentbudgetings.assignmentgenerate_id',
                                            //     )
                                            //     ->first();

                                            $client_id = DB::table('timesheetusers')
                                                ->leftjoin('clients', 'clients.id', 'timesheetusers.client_id')
                                                ->leftjoin(
                                                    'assignmentbudgetings',
                                                    'assignmentbudgetings.assignment_id',
                                                    'timesheetusers.assignment_id',
                                                )
                                                ->leftjoin(
                                                    'assignments',
                                                    'assignments.id',
                                                    'timesheetusers.assignment_id',
                                                )
                                                ->leftjoin('teammembers', 'teammembers.id', 'timesheetusers.partner')
                                                ->where('timesheetusers.id', $timesheetDatas->id)
                                                ->select(
                                                    'clients.client_name',
                                                    'clients.client_code',
                                                    'timesheetusers.hour',
                                                    'timesheetusers.location',
                                                    'timesheetusers.status',
                                                    'assignments.assignment_name',
                                                    'billable_status',
                                                    'workitem',
                                                    'teammembers.team_member',
                                                    'teammembers.staffcode',
                                                    'assignmentbudgetings.assignmentname',
                                                )
                                                ->first();

                                            $total = DB::table('timesheetusers')

                                                ->where('timesheetusers.timesheetid', $timesheetDatas->timesheetid)
                                                ->sum('hour');
                                            //	dd($total);
                                            $dates = date('l', strtotime($timesheetDatas->date));

                                            $targetAssignments = [29, 34, 32, 33, 134];
                                            if (in_array($timesheetDatas->client_id, $targetAssignments)) {
                                                // teammember code
                                                $rejoindpromotioncheck = DB::table('teamrolehistory')
                                                    ->where('teammember_id', $timesheetDatas->createdby)
                                                    ->first();

                                                $timesheetDate = $timesheetDatas->date
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d',
                                                        $timesheetDatas->date,
                                                    )->startOfDay()
                                                    : null;

                                                $rejoindpromotioncheckdate = null;
                                                if ($rejoindpromotioncheck) {
                                                    $rejoindpromotioncheckdate = Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $rejoindpromotioncheck->created_at,
                                                    )->startOfDay();
                                                }

                                                // partner code
                                                $rejoindpromotioncheckpartner = DB::table('teamrolehistory')
                                                    ->where('teammember_id', $timesheetDatas->partner)
                                                    ->first();

                                                $timesheetDatepartner = $timesheetDatas->date
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d',
                                                        $timesheetDatas->date,
                                                    )->startOfDay()
                                                    : null;

                                                $rejoindpromotioncheckdatepartner = null;
                                                if ($rejoindpromotioncheckpartner) {
                                                    $rejoindpromotioncheckdatepartner = Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $rejoindpromotioncheckpartner->created_at,
                                                    )->startOfDay();
                                                }
                                            } else {
                                                $teamMembers = DB::table('teamrolehistory')
                                                    ->whereIn('teammember_id', [
                                                        $timesheetDatas->createdby,
                                                        $timesheetDatas->partner,
                                                    ])
                                                    ->get()
                                                    ->keyBy('teammember_id');

                                                $datadate = $timesheetDatas->assignmentcreated
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $timesheetDatas->assignmentcreated,
                                                    )
                                                    : null;

                                                $permotioncheck = $teamMembers[$timesheetDatas->createdby] ?? null;
                                                $approverdata = $teamMembers[$timesheetDatas->partner] ?? null;

                                                $permotiondate = $permotioncheck
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $permotioncheck->created_at,
                                                    )
                                                    : null;
                                                $approverdate = $approverdata
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $approverdata->created_at,
                                                    )
                                                    : null;
                                            }
                                        @endphp








                                        <td>
                                            {{-- @if ($approverdata && $datadate && $datadate->greaterThan($approverdate))
                                                {{ $approverdata->newstaff_code }}
                                            @else
                                                {{ $client_id->staffcode ?? '' }}
                                            @endif
                                            @if (count((array) $client_id->team_member) > 1)
                                                ,
                                            @endif --}}
                                            @if (in_array($timesheetDatas->client_id, $targetAssignments))
                                                @if (
                                                    $rejoindpromotioncheckpartner &&
                                                        $timesheetDatepartner &&
                                                        $timesheetDatepartner->greaterThanOrEqualTo($rejoindpromotioncheckdatepartner))
                                                    {{ $rejoindpromotioncheckpartner->newstaff_code }}
                                                @else
                                                    {{ $client_id->staffcode ?? '' }}
                                                @endif
                                                @if (count((array) $client_id->team_member) > 1)
                                                    ,
                                                @endif
                                            @else
                                                @if ($approverdata && $datadate && $datadate->greaterThan($approverdate))
                                                    {{ $approverdata->newstaff_code }}
                                                @else
                                                    {{ $client_id->staffcode ?? '' }}
                                                @endif
                                                @if (count((array) $client_id->team_member) > 1)
                                                    ,
                                                @endif
                                            @endif
                                        </td>
	







	
										
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php

 public function timesheet_teamlist()
  {

    if (auth()->user()->role_id == 13) {
      $partner = Teammember::where('role_id', '=', 13)->where('status', '=', 1)->with('title')
        ->orderBy('team_member', 'asc')->get();

      // $get_datess = DB::table('timesheetreport')
      //   ->leftjoin('teammembers', 'teammembers.id', 'timesheetreport.teamid')
      //   ->leftjoin('teammembers as partners', 'partners.id', 'timesheetreport.partnerid')
      //   ->where('timesheetreport.partnerid', auth()->user()->teammember_id)
      //   // ->whereJsonContains('timesheetreport.partnerid', auth()->user()->teammember_id)
      //   ->select('timesheetreport.*', 'teammembers.team_member', 'teammembers.staffcode', 'partners.team_member as partnername')
      //   ->latest()->get();

      $get_datess = DB::table('timesheetreport')
        ->leftJoin('teammembers', 'teammembers.id', 'timesheetreport.teamid')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'teammembers.id')
            ->on('teamrolehistory.created_at', '<', 'timesheetreport.created_at');
        })
        ->leftJoin('teammembers as partners', 'partners.id', 'timesheetreport.partnerid')
        ->where('timesheetreport.partnerid', auth()->user()->teammember_id)
        ->whereColumn('timesheetreport.teamid', '!=', 'timesheetreport.partnerid')
        ->select('timesheetreport.*', 'teammembers.team_member', 'teammembers.staffcode', 'partners.team_member as partnername', 'teammembers.emailid', 'teamrolehistory.newstaff_code')
        ->latest()
        ->get();

      // For permission
      $permissiontimesheet = DB::table('timesheetreport')
        ->where('timesheetreport.teamid', auth()->user()->teammember_id)
        ->first();
      // dd($get_datess);
    } else {

      $partner = Teammember::where('role_id', '=', 13)->where('status', '=', 1)->with('title')
        ->orderBy('team_member', 'asc')->get();
      $get_datess = DB::table('timesheetreport')
        ->leftjoin('teammembers', 'teammembers.id', 'timesheetreport.teamid')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'teammembers.id')
            ->on('teamrolehistory.created_at', '<', 'timesheetreport.created_at');
        })
        ->leftjoin('teammembers as partners', 'partners.id', 'timesheetreport.partnerid')
        ->where('timesheetreport.teamid', auth()->user()->teammember_id)
        // ->select('timesheetreport.*', 'teammembers.team_member', 'teammembers.staffcode', 'partners.team_member as partnername')
        ->select('timesheetreport.*', 'teammembers.team_member', 'teammembers.staffcode', 'partners.team_member as partnername', 'teammembers.emailid', 'teamrolehistory.newstaff_code')
        ->latest()->get();

      // For permission working
      $permissiontimesheet = DB::table('timesheetreport')
        ->where('timesheetreport.teamid', auth()->user()->teammember_id)
        ->first();
    }


    $groupedData = $get_datess->groupBy(function ($item) {
      return $item->team_member . '|' . $item->week;
    })->map(function ($group) {
      $firstItem = $group->first();

      return (object)[
        'id' => $firstItem->id,
        'teamid' => $firstItem->teamid,
        'emailid' => $firstItem->emailid,
        'week' => $firstItem->week,
        'totaldays' => $group->sum('totaldays'),
        'totaltime' => $group->sum('totaltime'),
        'dayscount' => $group->sum('dayscount'),
        'startdate' => $firstItem->startdate,
        'enddate' => $firstItem->enddate,
        'partnername' => $firstItem->partnername,
        'created_at' => $firstItem->created_at,
        'team_member' => $firstItem->team_member,
        'partnerid' => $firstItem->partnerid,
        'staffcode' => $firstItem->newstaff_code ?? $firstItem->staffcode,
      ];
    });

    $get_date = collect($groupedData->values());

    return view('backEnd.timesheet.myteamindex', compact('get_date', 'partner', 'permissiontimesheet'));
  }






22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\weeklylist.blade.php
                           @foreach ($timesheetData as $timesheetDatas)
                                <tr>
                                    <td style="display: none;">{{ $timesheetDatas->id }}</td>
                                    <td class="textfixed"> {{ $timesheetDatas->team_member ?? '' }} </td>
                                    {{-- <td>{{ $timesheetDatas->teamnewstaffcode ?? ($timesheetDatas->staffcode ?? '') }}</td> --}}
                                    <td>{{ $timesheetDatas->final_teamstaffcode }}</td>
                                    <td class="textfixed"> <span style="display: none;">
                                            {{ date('Y-m-d', strtotime($timesheetDatas->date)) }}</span>{{ date('d-m-Y', strtotime($timesheetDatas->date)) }}
                                    </td>
                                    <td class="textfixed">
                                        @if ($timesheetDatas->date != null)
                                            {{ date('l', strtotime($timesheetDatas->date)) }}
                                        @endif
                                    </td>
                                    <td class="textfixed">{{ $timesheetDatas->client_name ?? '' }}
                                    </td>
                                    <td> {{ $timesheetDatas->client_code ?? '' }}
                                    </td>
                                    <td class="textfixed">
                                        {{ $timesheetDatas->assignment_name ?? '' }}
                                        @if ($timesheetDatas->assignmentname != null)
                                            ({{ $timesheetDatas->assignmentname ?? '' }})
                                        @endif
                                    </td>
                                    <td>
                                        {{ $timesheetDatas->assignmentgenerate_id ?? '' }}
                                    </td>
                                    <td class="textfixed"> {{ $timesheetDatas->workitem ?? '' }}</td>
                                    <td class="textfixed">{{ $timesheetDatas->location ?? '' }} </td>
                                    <td class="textfixed"> {{ $timesheetDatas->patnername ?? '' }}
                                    </td>
                                    {{-- <td>{{ $timesheetDatas->ptnrstaffcode ?? ($timesheetDatas->patnerstaffcodee ?? '') }}
                                    </td> --}}
                                    <td>{{ $timesheetDatas->final_partnerstaffcode }}</td>
                                    <td>{{ $timesheetDatas->hour ?? '' }}</td>
                                    <td>
                                        @if ($timesheetDatas->status == 0)
                                            <span class="badge badge-pill badge-warning">Saved</span>
                                        @elseif ($timesheetDatas->status == 1 || $timesheetDatas->status == 3)
                                            <span class="badge badge-pill badge-danger">Submit</span>
                                        @else
                                            <span class="badge badge-pill badge-secondary">Rejected</span>
                                        @endif
                                    </td>
                                    @if (Auth::user()->role_id == 11 || Auth::user()->teammember_id != $timesheetDatas->createdby)
                                        <td>
                                            @if ($timesheetDatas->assignmentgenerate_id != null)
                                                <a href="{{ url('/timesheet/reject/' . $timesheetDatas->id) }}"
                                                    onclick="return confirm('Are you sure you want to Reject this timesheet?');">
                                                    <button class="btn btn-danger"
                                                        style="height: 16px; width: auto; border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 11px;"
                                                        {{ $timesheetDatas->status == 2 ? 'disabled' : '' }}>
                                                        Reject
                                                    </button>
                                                </a>
                                            @else
                                                <span>NA</span>
                                            @endif
                                        </td>
                                    @endif
                                </tr>
                            @endforeach 

Rejoining/Promotion features Deployed ```end
Client want to implement Rejoining process to users.

vsalocal, vsademo, vsalive  ```end 














For the following five clients, Off/Holidays, Official Travel, Unallocated, Seminar/Conference and Apply Leave, the old code is still appearing the old code is still appearing. ```start
vsademo, 
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php

 public function mytimesheetlist(Request $request, $teamid)
  {

    if (auth()->user()->role_id == 13) {
      $timesheetData = DB::table('timesheetusers')
        ->leftJoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
        ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
        ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
          $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
            ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
        })
        ->leftJoin('clients', 'clients.id', 'timesheetusers.client_id')
        ->leftJoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
        ->leftJoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
            ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
        })
        ->where('timesheetusers.createdby', $teamid)
        ->whereIn('timesheetusers.status', [1, 2, 3])
        ->whereNotNull('timesheetusers.date')
        ->select(
          'timesheetusers.*',
          'assignments.assignment_name',
          'clients.client_name',
          'clients.client_code',
          'teammembers.team_member',
          'teammembers.staffcode',
          'patnerid.team_member as patnername',
          'patnerid.staffcode as patnerstaffcodee',
          'assignmentbudgetings.assignmentname',
          'teamrolehistory.newstaff_code as ptnrstaffcode',
          'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
          'assignmentbudgetings.created_at as assignmentcreated'
        )
        ->orderBy('timesheetusers.date', 'DESC')
        ->limit(7)
        ->get();

      $timesheetData = $this->rejoinedOrPromotion($timesheetData);
    } else {
      $timesheetData = DB::table('timesheetusers')
        ->leftJoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
        ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
        ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
          $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
            ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
        })
        ->leftJoin('clients', 'clients.id', 'timesheetusers.client_id')
        ->leftJoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
        ->leftJoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
            ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
        })
        ->where('timesheetusers.createdby', $teamid)
        ->whereIn('timesheetusers.status', [1, 2, 3])
        ->whereNotNull('timesheetusers.date')
        ->select(
          'timesheetusers.*',
          'assignments.assignment_name',
          'clients.client_name',
          'clients.client_code',
          'teammembers.team_member',
          'teammembers.staffcode',
          'patnerid.team_member as patnername',
          'patnerid.staffcode as patnerstaffcodee',
          'assignmentbudgetings.assignmentname',
          'teamrolehistory.newstaff_code as ptnrstaffcode',
          'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
          'assignmentbudgetings.created_at as assignmentcreated'
        )
        ->orderBy('timesheetusers.date', 'DESC')
        ->limit(7)
        ->get();

      $timesheetData = $this->rejoinedOrPromotion($timesheetData);
    }
    session()->forget('_old_input');
    return view('backEnd.timesheet.timesheetdownload', compact('timesheetData'));
  }
  
  
  
  
  
  
  

22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\timesheetdownload.blade.php


                                @foreach ($timesheetData as $timesheetDatas)
                                      <tr>
                                          <td style="display: none;">{{ $timesheetDatas->id }}</td>
                                          <td> {{ $timesheetDatas->team_member ?? '' }} </td>
                                          {{-- <td>{{ $timesheetDatas->teamnewstaffcode ?? ($timesheetDatas->staffcode ?? '') }}
                                          </td> --}}
                                          <td>{{ $timesheetDatas->final_staffcode }}</td>
                                          <td class="textfixed"> <span style="display: none;">
                                                  {{ date('Y-m-d', strtotime($timesheetDatas->date)) }}</span>{{ date('d-m-Y', strtotime($timesheetDatas->date)) }}
                                          </td>
                                          <td class="textfixed">
                                              @if ($timesheetDatas->date != null)
                                                  {{ date('l', strtotime($timesheetDatas->date)) }}
                                              @endif
                                          </td>
                                          <td class="textfixed">{{ $timesheetDatas->client_name ?? '' }}
                                          </td>
                                          <td>{{ $timesheetDatas->client_code ?? '' }}
                                          </td>
                                          <td class="textfixed">
                                              {{ $timesheetDatas->assignment_name ?? '' }}
                                              @if ($timesheetDatas->assignmentname != null)
                                                  ({{ $timesheetDatas->assignmentname ?? '' }})
                                              @endif
                                          </td>
                                          <td>
                                              {{ $timesheetDatas->assignmentgenerate_id ?? '' }}
                                          </td>
                                          <td class="textfixed"> {{ $timesheetDatas->workitem ?? '' }}</td>
                                          <td class="textfixed">{{ $timesheetDatas->location ?? '' }} </td>
                                          <td class="textfixed"> {{ $timesheetDatas->patnername ?? '' }}
                                          </td>
                                          {{-- <td>{{ $timesheetDatas->ptnrstaffcode ?? ($timesheetDatas->patnerstaffcodee ?? '') }}
                                          </td> --}}
                                          <td>{{ $timesheetDatas->final_partnerstaffcode }}</td>
                                          <td>{{ $timesheetDatas->hour ?? '' }}</td>
                                      </tr>
                                  @endforeach
							


							
								  
								  
								  
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php

 
  public function searchingtimesheet(Request $request)
  {
    // Get all input from form
    $startDate = $request->input('startdate', null);
    $endDate = $request->input('enddate', null);
    $teamId = $request->input('teamid', null);
    $teammemberId = $request->input('teammemberId', null);
    // $year = $request->input('year', null);

    $teammembers = DB::table('teammembers')
      ->leftJoin('teamrolehistory', 'teamrolehistory.teammember_id', '=', 'teammembers.id')
      ->where('teammembers.status', 1)
      ->whereIn('teammembers.role_id', [14, 15, 13, 11])
      ->select('teammembers.team_member', 'teamrolehistory.newstaff_code', 'teammembers.id', 'teammembers.staffcode')
      ->orderBy('team_member', 'ASC')
      ->get();

    // For patner
    if (auth()->user()->role_id == 13) {
      $query = DB::table('timesheetusers')
        ->leftJoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
        ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
        ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
          $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
            ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
        })
        ->leftJoin('clients', 'clients.id', 'timesheetusers.client_id')
        ->leftJoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
        ->leftJoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
            ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
        })
        ->where('timesheetusers.createdby', $teamId)
        ->whereIn('timesheetusers.status', [1, 2, 3])
        ->whereNotNull('timesheetusers.date')
        ->whereBetween('timesheetusers.date', [$startDate, $endDate])
        ->select(
          'timesheetusers.*',
          'assignments.assignment_name',
          'clients.client_name',
          'clients.client_code',
          'teammembers.team_member',
          'teammembers.staffcode',
          'patnerid.team_member as patnername',
          'patnerid.staffcode as patnerstaffcodee',
          'assignmentbudgetings.assignmentname',
          'teamrolehistory.newstaff_code as ptnrstaffcode',
          'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
          'assignmentbudgetings.created_at as assignmentcreated'
        )
        ->orderBy('timesheetusers.date', 'DESC');

      $timesheetData = $query->get();

      $timesheetData = $this->rejoinedOrPromotion($timesheetData);

      $request->flash();
      return view('backEnd.timesheet.timesheetdownload', compact('timesheetData'));
    }
    // For staff and manager
    else {
      $query = DB::table('timesheetusers')
        ->leftJoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
        ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
        ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
          $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
            ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
        })
        ->leftJoin('clients', 'clients.id', 'timesheetusers.client_id')
        ->leftJoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
        ->leftJoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
            ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
        })
        ->where('timesheetusers.createdby', $teamId)
        ->whereIn('timesheetusers.status', [1, 2, 3])
        ->whereNotNull('timesheetusers.date')
        ->whereBetween('timesheetusers.date', [$startDate, $endDate])
        ->select(
          'timesheetusers.*',
          'assignments.assignment_name',
          'clients.client_name',
          'clients.client_code',
          'teammembers.team_member',
          'teammembers.staffcode',
          'patnerid.team_member as patnername',
          'patnerid.staffcode as patnerstaffcodee',
          'assignmentbudgetings.assignmentname',
          'teamrolehistory.newstaff_code as ptnrstaffcode',
          'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
          'assignmentbudgetings.created_at as assignmentcreated'
        )
        ->orderBy('timesheetusers.date', 'DESC');

      $timesheetData = $query->get();

      $timesheetData = $this->rejoinedOrPromotion($timesheetData);
      // dd($timesheetData);
      $request->flash();
      return view('backEnd.timesheet.timesheetdownload', compact('timesheetData'));
    }
  }







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php

 
  public function adminsearchtimesheet(Request $request)
  {
    if ($request->ajax()) {
      echo "<option value='null'>Select Assignment</option>";
      $assignments = DB::table('assignmentbudgetings')
        ->where('assignmentbudgetings.client_id', $request->cid)
        ->leftJoin('assignments', 'assignments.id', 'assignmentbudgetings.assignment_id')
        ->leftJoin('assignmentmappings', 'assignmentmappings.assignmentgenerate_id', 'assignmentbudgetings.assignmentgenerate_id')
        ->orderBy('assignment_name')
        ->get();

      foreach ($assignments as $sub) {
        echo "<option value='{$sub->assignmentgenerate_id}'>{$sub->assignment_name} ({$sub->assignmentname}) ({$sub->assignmentgenerate_id})</option>";
      }
      return;
    }

    $startDate = $request->input('startdate');
    $endDate = $request->input('enddate');
    $teamId = $request->input('teamid');
    $teammemberId = $request->input('teammemberId');
    $clientId = $request->input('clientId');
    $assignmentId = $request->input('assignmentId') !== 'null' ? $request->input('assignmentId') : null;


    $teammembers = DB::table('teammembers')
      ->leftJoin('teamrolehistory', 'teamrolehistory.teammember_id', '=', 'teammembers.id')
      ->where('teammembers.status', 1)
      ->whereIn('teammembers.role_id', [14, 15, 13, 11])
      ->select('teammembers.team_member', 'teamrolehistory.newstaff_code', 'teammembers.id', 'teammembers.staffcode')
      ->orderBy('team_member', 'ASC')
      ->get();

    $clientsname = DB::table('clients')
      ->whereIn('status', [0, 1])
      ->select('id', 'client_name', 'client_code')
      ->orderBy('client_name', 'ASC')
      ->get();

    $assignmentsname = DB::table('timesheetusers')
      ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
      ->whereIn('timesheetusers.status', [1, 2, 3])
      ->whereNotNull('assignmentbudgetings.assignmentname')
      ->select('timesheetusers.assignmentgenerate_id', 'assignmentbudgetings.assignmentname')
      ->distinct()
      ->orderBy('assignmentname', 'ASC')
      ->get();

    if (!in_array(auth()->user()->role_id, [11, 13])) {
      $output = array('msg' => 'Unauthorized access');
      return back()->with('statuss', $output);
    }

    // Base query
    $query = DB::table('timesheetusers')
      ->leftJoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
      ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
      ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
        $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
          ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
      })
      ->leftJoin('clients', 'clients.id', 'timesheetusers.client_id')
      ->leftJoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
      ->leftJoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
      ->leftJoin('teamrolehistory', function ($join) {
        $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
          ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
      })
      ->whereIn('timesheetusers.status', [1, 2, 3])
      ->select(
        'timesheetusers.*',
        'assignments.assignment_name',
        'clients.client_name',
        'clients.client_code',
        'teammembers.team_member',
        'teammembers.staffcode',
        'patnerid.team_member as patnername',
        'patnerid.staffcode as patnerstaffcodee',
        'assignmentbudgetings.assignmentname',
        'teamrolehistory.newstaff_code as ptnrstaffcode',
        'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
        'assignmentbudgetings.created_at as assignmentcreated'
      )
      ->orderBy('date', 'DESC');

    // if ($startDate && $endDate) {
    //   $query->whereBetween('timesheetusers.date', [$startDate, $endDate]);

    //   if ($teammemberId) {
    //     $query->where('timesheetusers.createdby', $teammemberId);
    //   } elseif ($clientId) {
    //     $query->where('timesheetusers.client_id', $clientId);
    //   } elseif ($assignmentId) {
    //     $query->where('timesheetusers.assignmentgenerate_id', $assignmentId);
    //   }
    // }

    if ($startDate && $endDate) {
      $query->whereBetween('timesheetusers.date', [$startDate, $endDate]);
      if ($teammemberId) {
        $query->where('timesheetusers.createdby', $teammemberId);
      }
      if ($clientId) {
        $query->where('timesheetusers.client_id', $clientId);
      }
      if ($assignmentId) {
        $query->where('timesheetusers.assignmentgenerate_id', $assignmentId);
      }
    }

    $timesheetData = $query->get();

    $timesheetData = $this->rejoinedOrPromotion($timesheetData);

    $request->flash();
    return view('backEnd.timesheet.timesheetdownload', compact('timesheetData', 'teammembers', 'clientsname', 'assignmentsname', 'assignmentId'));
  }
  
  
  
  
  
  


22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php

 ->select('assignmentbudgetings.assignmentgenerate_id', 'assignments.assignment_name', 'assignments.assignmentname')


1

       $assignments = DB::table('assignmentbudgetings')
              ->where('client_id', $id)
              ->leftJoin('assignments', 'assignments.id', '=', 'assignmentbudgetings.assignment_id')
              ->select('assignmentbudgetings.assignmentgenerate_id', 'assignments.assignment_name', 'assignmentbudgetings.assignmentname')
              ->orderBy('assignments.assignment_name')
              ->get();
			  
			  








22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php

 
   public function weeklylist(Request $request)
  {
    // dd($request);
    if (auth()->user()->role_id == 13) {
      $date = DB::table('timesheetreport')->where('id', $request->id)->first();

      $promotionCheck = DB::table('teamrolehistory')
        ->where('teammember_id', $request->teamid)
        ->select('newstaff_code', 'created_at')
        ->first();

      $promotionorRejoinDate = $promotionCheck
        ? Carbon::parse($promotionCheck->created_at)->startOfDay()
        : null;

      $timesheetData = DB::table('timesheetusers')
        ->leftjoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
        ->leftjoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
        ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
          $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
            ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
        })
        ->leftjoin('clients', 'clients.id', 'timesheetusers.client_id')
        ->leftjoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
        ->leftjoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
            ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
        })
        ->where('timesheetusers.createdby', $request->teamid)
        ->whereIn('timesheetusers.status', [1, 2, 3])
        ->whereNotNull('timesheetusers.date')
        ->where('timesheetusers.date', '>=', $date->startdate)
        ->where('timesheetusers.date', '<=', $date->enddate)
        ->select(
          'timesheetusers.*',
          'assignments.assignment_name',
          'clients.client_name',
          'clients.client_code',
          'teammembers.team_member',
          'teammembers.staffcode',
          'patnerid.team_member as patnername',
          'patnerid.staffcode as patnerstaffcodee',
          'assignmentbudgetings.assignmentname',
          'teamrolehistory.newstaff_code as ptnrstaffcode',
          'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
          'assignmentbudgetings.created_at as assignmentcreated'
        )
        // ->orderBy('timesheetusers.id', 'ASC')
        ->orderBy('timesheetusers.date', 'DESC')
        ->get();

      $timesheetData = $this->promotionOrRejoined($timesheetData, $promotionCheck, $promotionorRejoinDate);
    } else {
      $date = DB::table('timesheetreport')->where('id', $request->id)->first();

      $promotionCheck = DB::table('teamrolehistory')
        ->where('teammember_id', $request->teamid)
        ->select('newstaff_code', 'created_at')
        ->first();

      $promotionorRejoinDate = $promotionCheck
        ? Carbon::parse($promotionCheck->created_at)->startOfDay()
        : null;

      $timesheetData = DB::table('timesheetusers')
        ->leftJoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
        ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
        ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
          $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
            ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
        })
        ->leftJoin('clients', 'clients.id', 'timesheetusers.client_id')
        ->leftJoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
        ->leftJoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
            ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
        })
        ->where('timesheetusers.createdby', $request->teamid)
        ->whereIn('timesheetusers.status', [1, 2, 3])
        ->whereNotNull('timesheetusers.date')
        ->whereBetween('timesheetusers.date', [$date->startdate, $date->enddate])
        ->select(
          'timesheetusers.*',
          'assignments.assignment_name',
          'clients.client_name',
          'clients.client_code',
          'teammembers.team_member',
          'teammembers.staffcode',
          'patnerid.team_member as patnername',
          'patnerid.staffcode as patnerstaffcodee',
          'assignmentbudgetings.assignmentname',
          'teamrolehistory.newstaff_code as ptnrstaffcode',
          'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
          'assignmentbudgetings.created_at as assignmentcreated'
        )
        // ->orderBy('timesheetusers.id', 'ASC')
        ->orderBy('timesheetusers.date', 'DESC')
        ->get();

      $timesheetData = $this->promotionOrRejoined($timesheetData, $promotionCheck, $promotionorRejoinDate);
    }
    return view('backEnd.timesheet.weeklylist', compact('timesheetData'));
  }







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\weeklylist.blade.php

                                    {{-- <td>{{ $timesheetDatas->teamnewstaffcode ?? ($timesheetDatas->staffcode ?? '') }}</td> --}}
                                     <td>{{ $timesheetDatas->final_teamstaffcode }}</td>
									
									
									
                                    {{-- <td>{{ $timesheetDatas->ptnrstaffcode ?? ($timesheetDatas->patnerstaffcodee ?? '') }}
                                    </td> --}}
                                    <td>{{ $timesheetDatas->final_partnerstaffcode }}</td>





22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\rejectedlist.blade.php
find $dates = date('l', strtotime($timesheetDatas->date));


                                         $dates = date('l', strtotime($timesheetDatas->date));

                                        $targetAssignments = [29, 34, 32, 33, 134];
                                        if (in_array($timesheetDatas->client_id, $targetAssignments)) {
                                            // teammember code
                                            $rejoindpromotioncheck = DB::table('teamrolehistory')
                                                ->where('teammember_id', $timesheetDatas->createdby)
                                                ->first();

                                            $timesheetDate = $timesheetDatas->date
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d',
                                                    $timesheetDatas->date,
                                                )->startOfDay()
                                                : null;

                                            $rejoindpromotioncheckdate = null;
                                            if ($rejoindpromotioncheck) {
                                                $rejoindpromotioncheckdate = Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $rejoindpromotioncheck->created_at,
                                                )->startOfDay();
                                            }

                                            // partner code
                                            $rejoindpromotioncheckpartner = DB::table('teamrolehistory')
                                                ->where('teammember_id', $timesheetDatas->partner)
                                                ->first();

                                            $timesheetDatepartner = $timesheetDatas->date
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d',
                                                    $timesheetDatas->date,
                                                )->startOfDay()
                                                : null;

                                            $rejoindpromotioncheckdatepartner = null;
                                            if ($rejoindpromotioncheckpartner) {
                                                $rejoindpromotioncheckdatepartner = Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $rejoindpromotioncheckpartner->created_at,
                                                )->startOfDay();
                                            }
                                        } else {
                                            $assignmentcheck = DB::table('assignmentbudgetings')
                                                ->where('assignmentgenerate_id', $timesheetDatas->assignmentgenerate_id)
                                                ->first();

                                            $teamMembers = DB::table('teamrolehistory')
                                                ->whereIn('teammember_id', [
                                                    $timesheetDatas->createdby,
                                                    $timesheetDatas->partner,
                                                ])
                                                ->get()
                                                ->keyBy('teammember_id');

                                            $datadate = $assignmentcheck
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $assignmentcheck->created_at,
                                                )
                                                : null;

                                            // dd($teamMembers);

                                            $permotioncheck = $teamMembers[$timesheetDatas->createdby] ?? null;
                                            $approverdata = $teamMembers[$timesheetDatas->partner] ?? null;

                                            $permotiondate = $permotioncheck
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $permotioncheck->created_at,
                                                )
                                                : null;
                                            $approverdate = $approverdata
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $approverdata->created_at,
                                                )
                                                : null;
                                        }
                                    @endphp







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\rejectedlist.blade.php

{{ $permotioncheck->newstaff_code }}


                                    @if (in_array($timesheetDatas->client_id, $targetAssignments))
                                        @if ($rejoindpromotioncheck && $timesheetDate && $timesheetDate->greaterThanOrEqualTo($rejoindpromotioncheckdate))
                                            <td>{{ $rejoindpromotioncheck->newstaff_code }}</td>
                                        @else
                                            <td>{{ $timesheetDatas->staffcode }}</td>
                                        @endif
                                    @else
                                        <td>
                                            @if ($permotioncheck && $datadate && $datadate->greaterThan($permotiondate))
                                                {{ $permotioncheck->newstaff_code }}
                                            @else
                                                {{ $timesheetDatas->staffcode }}
                                            @endif
                                        </td>
                                    @endif
									
									
									
				


				
									
									
									
									
									
									
{{ $client_id->staffcode ?? '' }}
									
									
                                    <td class="textfixed">
                                        @if (in_array($timesheetDatas->client_id, $targetAssignments))
                                            @if (
                                                $rejoindpromotioncheckpartner &&
                                                    $timesheetDatepartner &&
                                                    $timesheetDatepartner->greaterThanOrEqualTo($rejoindpromotioncheckdatepartner))
                                                {{ $rejoindpromotioncheckpartner->newstaff_code }}
                                            @else
                                                {{ $client_id->staffcode ?? '' }}
                                            @endif
                                            @if (count((array) $client_id->team_member) > 1)
                                                ,
                                            @endif
                                        @else
                                            @if ($approverdata && $datadate && $datadate->greaterThan($approverdate))
                                                {{ $approverdata->newstaff_code }}
                                            @else
                                                {{ $client_id->staffcode ?? '' }}
                                            @endif
                                            @if (count((array) $client_id->team_member) > 1)
                                                ,
                                            @endif
                                        @endif
                                    </td>







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\hrindex.blade.php
 @foreach ($timesheetData as $timesheetDatas)

                             @foreach ($timesheetData as $timesheetDatas)
                                <tr>
                                    @php
                                        $client_id = DB::table('timesheetusers')
                                            ->leftjoin('clients', 'clients.id', 'timesheetusers.client_id')
                                            ->leftjoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
                                            ->leftjoin('teammembers', 'teammembers.id', 'timesheetusers.partner')
                                            ->where('timesheetusers.timesheetid', $timesheetDatas->id)
                                            ->select(
                                                'timesheetusers.client_id',
                                                'timesheetusers.date',
                                                'clients.client_name',
                                                'clients.client_code',
                                                'timesheetusers.hour',
                                                'assignments.assignment_name',
                                                'billable_status',
                                                'workitem',
                                                'teammembers.id',
                                                'teammembers.team_member',
                                                'teammembers.staffcode',
                                            )
                                            ->get();

                                        //  dd($client_id);
                                        $total = DB::table('timesheetusers')
                                            ->where('timesheetusers.timesheetid', $timesheetDatas->id)
                                            ->sum('hour');

                                        $dates = date('l', strtotime($timesheetDatas->date));

                                        $timesheetusersclientcheck = DB::table('timesheetusers')
                                            ->where('timesheetid', $timesheetDatas->id)
                                            ->first();

                                        $targetAssignments = [29, 34, 32, 33, 134];
                                        if (in_array($timesheetusersclientcheck->client_id, $targetAssignments)) {
                                            $rejoindpromotioncheck = DB::table('teamrolehistory')
                                                ->where('teammember_id', $timesheetusersclientcheck->createdby)
                                                ->first();

                                            $timesheetDate = $timesheetusersclientcheck->date
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d',
                                                    $timesheetusersclientcheck->date,
                                                )->startOfDay()
                                                : null;

                                            $rejoindpromotioncheckdate = null;
                                            if ($rejoindpromotioncheck) {
                                                $rejoindpromotioncheckdate = Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $rejoindpromotioncheck->created_at,
                                                )->startOfDay();
                                            }
                                        } else {
                                            $permotioncheck = DB::table('teamrolehistory')
                                                ->where('teammember_id', $timesheetDatas->created_by)
                                                ->first();

                                            $assignmentcheck = DB::table('timesheetusers')
                                                ->leftJoin(
                                                    'assignmentbudgetings',
                                                    'assignmentbudgetings.assignmentgenerate_id',
                                                    'timesheetusers.assignmentgenerate_id',
                                                )
                                                ->where('timesheetid', $timesheetDatas->id)
                                                ->select('assignmentbudgetings.created_at')
                                                ->first();

                                            //shshid client

                                            $datadate = $assignmentcheck->created_at
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $assignmentcheck->created_at,
                                                )
                                                : null;

                                            $permotiondate = null;
                                            if ($permotioncheck) {
                                                $permotiondate = Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $permotioncheck->created_at,
                                                );
                                            }
                                        }
                                    @endphp
									
									
									
									
									
									
									
									
									
									
									
									
									
									

                                    @if (in_array($timesheetusersclientcheck->client_id, $targetAssignments))
                                        @if ($rejoindpromotioncheck && $timesheetDate && $timesheetDate->greaterThanOrEqualTo($rejoindpromotioncheckdate))
                                            <td>{{ $rejoindpromotioncheck->newstaff_code }}</td>
                                        @else
                                            <td>{{ $timesheetDatas->staffcode }}</td>
                                        @endif
                                    @else
                                        @if ($permotioncheck && $datadate && $datadate->greaterThan($permotiondate))
                                            <td>{{ $permotioncheck->newstaff_code }}</td>
                                        @else
                                            <td>{{ $timesheetDatas->staffcode }}</td>
                                        @endif
                                    @endif


									
									
									
									
									
									







                                       @foreach ($client_id as $item)
                                            @php
                                                if (in_array($item->client_id, $targetAssignments)) {
                                                    // partner code
                                                    $rejoindpromotioncheckpartner = DB::table('teamrolehistory')
                                                        ->where('teammember_id', $item->id)
                                                        ->first();

                                                    $timesheetDatepartner = $item->date
                                                        ? Carbon\Carbon::createFromFormat(
                                                            'Y-m-d',
                                                            $item->date,
                                                        )->startOfDay()
                                                        : null;

                                                    $rejoindpromotioncheckdatepartner = null;
                                                    if ($rejoindpromotioncheckpartner) {
                                                        $rejoindpromotioncheckdatepartner = Carbon\Carbon::createFromFormat(
                                                            'Y-m-d H:i:s',
                                                            $rejoindpromotioncheckpartner->created_at,
                                                        )->startOfDay();
                                                    }
                                                } else {
                                                    $partnerpermotioncheck = DB::table('teamrolehistory')
                                                        ->where('teammember_id', $item->id)
                                                        ->first();

                                                    $assignmentcheck = DB::table('timesheetusers')
                                                        ->leftJoin(
                                                            'assignmentbudgetings',
                                                            'assignmentbudgetings.assignmentgenerate_id',
                                                            'timesheetusers.assignmentgenerate_id',
                                                        )
                                                        ->where('timesheetid', $timesheetDatas->id)
                                                        ->select('assignmentbudgetings.created_at')
                                                        ->first();

                                                    //shshid client

                                                    $partnerdatadate = $assignmentcheck->created_at
                                                        ? Carbon\Carbon::createFromFormat(
                                                            'Y-m-d H:i:s',
                                                            $assignmentcheck->created_at,
                                                        )
                                                        : null;

                                                    $partnerpermotiondate = null;
                                                    if ($partnerpermotioncheck) {
                                                        $partnerpermotiondate = Carbon\Carbon::createFromFormat(
                                                            'Y-m-d H:i:s',
                                                            $partnerpermotioncheck->created_at,
                                                        );
                                                    }
                                                }
                                            @endphp
                                            @if (in_array($item->client_id, $targetAssignments))
                                                @if (
                                                    $rejoindpromotioncheckpartner &&
                                                        $timesheetDatepartner &&
                                                        $timesheetDatepartner->greaterThanOrEqualTo($rejoindpromotioncheckdatepartner))
                                                    {{ $rejoindpromotioncheckpartner->newstaff_code }}
                                                @else
                                                    {{ $item->staffcode }}
                                                @endif
                                                @if ($item->team_member != null)
                                                    ,
                                                @endif
                                            @else
                                                @if ($partnerpermotioncheck && $partnerdatadate && $partnerdatadate->greaterThan($partnerpermotiondate))
                                                    {{ $partnerpermotioncheck->newstaff_code }}
                                                @else
                                                    {{ $item->staffcode }}
                                                @endif
                                                @if ($item->team_member != null)
                                                    ,
                                                @endif
                                            @endif
                                        @endforeach
										
										
										
										
										
										

22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\timesheetdownload.blade.php

                                          {{-- <td>{{ $timesheetDatas->ptnrstaffcode ?? ($timesheetDatas->patnerstaffcodee ?? '') }}
                                          </td> --}}
                                              <td>{{ $timesheetDatas->final_partnerstaffcode }}</td>







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php


  public function adminsearchtimesheet(Request $request)
  {
    if ($request->ajax()) {
      echo "<option value='null'>Select Assignment</option>";
      $assignments = DB::table('assignmentbudgetings')
        ->where('assignmentbudgetings.client_id', $request->cid)
        ->leftJoin('assignments', 'assignments.id', 'assignmentbudgetings.assignment_id')
        ->leftJoin('assignmentmappings', 'assignmentmappings.assignmentgenerate_id', 'assignmentbudgetings.assignmentgenerate_id')
        ->orderBy('assignment_name')
        ->get();

      foreach ($assignments as $sub) {
        echo "<option value='{$sub->assignmentgenerate_id}'>{$sub->assignment_name} ({$sub->assignmentname}) ({$sub->assignmentgenerate_id})</option>";
      }
      return;
    }

    $startDate = $request->input('startdate');
    $endDate = $request->input('enddate');
    $teamId = $request->input('teamid');
    $teammemberId = $request->input('teammemberId');
    $clientId = $request->input('clientId');
    $assignmentId = $request->input('assignmentId') !== 'null' ? $request->input('assignmentId') : null;


    $teammembers = DB::table('teammembers')
      ->leftJoin('teamrolehistory', 'teamrolehistory.teammember_id', '=', 'teammembers.id')
      ->where('teammembers.status', 1)
      ->whereIn('teammembers.role_id', [14, 15, 13, 11])
      ->select('teammembers.team_member', 'teamrolehistory.newstaff_code', 'teammembers.id', 'teammembers.staffcode')
      ->orderBy('team_member', 'ASC')
      ->get();

    $clientsname = DB::table('clients')
      ->whereIn('status', [0, 1])
      ->select('id', 'client_name', 'client_code')
      ->orderBy('client_name', 'ASC')
      ->get();

    $assignmentsname = DB::table('timesheetusers')
      ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
      ->whereIn('timesheetusers.status', [1, 2, 3])
      ->whereNotNull('assignmentbudgetings.assignmentname')
      ->select('timesheetusers.assignmentgenerate_id', 'assignmentbudgetings.assignmentname')
      ->distinct()
      ->orderBy('assignmentname', 'ASC')
      ->get();

    if (!in_array(auth()->user()->role_id, [11, 13])) {
      $output = array('msg' => 'Unauthorized access');
      return back()->with('statuss', $output);
    }

    // Base query
    $query = DB::table('timesheetusers')
      ->leftJoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
      ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
      ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
        $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
          ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
      })
      ->leftJoin('clients', 'clients.id', 'timesheetusers.client_id')
      ->leftJoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
      ->leftJoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
      ->leftJoin('teamrolehistory', function ($join) {
        $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
          ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
      })
      ->whereIn('timesheetusers.status', [1, 2, 3])
      ->select(
        'timesheetusers.*',
        'assignments.assignment_name',
        'clients.client_name',
        'clients.client_code',
        'teammembers.team_member',
        'teammembers.staffcode',
        'patnerid.team_member as patnername',
        'patnerid.staffcode as patnerstaffcodee',
        'assignmentbudgetings.assignmentname',
        'teamrolehistory.newstaff_code as ptnrstaffcode',
        'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
        'assignmentbudgetings.created_at as assignmentcreated'
      )
      ->orderBy('date', 'DESC');

    // if ($startDate && $endDate) {
    //   $query->whereBetween('timesheetusers.date', [$startDate, $endDate]);

    //   if ($teammemberId) {
    //     $query->where('timesheetusers.createdby', $teammemberId);
    //   } elseif ($clientId) {
    //     $query->where('timesheetusers.client_id', $clientId);
    //   } elseif ($assignmentId) {
    //     $query->where('timesheetusers.assignmentgenerate_id', $assignmentId);
    //   }
    // }

    if ($startDate && $endDate) {
      $query->whereBetween('timesheetusers.date', [$startDate, $endDate]);
      if ($teammemberId) {
        $query->where('timesheetusers.createdby', $teammemberId);
      }
      if ($clientId) {
        $query->where('timesheetusers.client_id', $clientId);
      }
      if ($assignmentId) {
        $query->where('timesheetusers.assignmentgenerate_id', $assignmentId);
      }
    }

    $timesheetData = $query->get();

    $timesheetData = $this->rejoinedOrPromotion($timesheetData);

    $request->flash();
    return view('backEnd.timesheet.timesheetdownload', compact('timesheetData', 'teammembers', 'clientsname', 'assignmentsname', 'assignmentId'));
  }







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php



 public function totalworkingdays(Request $request, $teamid)
  {

    // total working days startfrom january to december 
    $currentDate = Carbon::now();
    $currentMonth = $currentDate->format('F');
    $startDate = Carbon::create($currentDate->year, 1, 1);
    $endDate = Carbon::create($currentDate->year, 12, 31);

    // $startDate = Carbon::create('01-04-2024');
    // $endDate = Carbon::create('30-09-2024');

    // $home = DB::table('timesheetusers')
    //   ->where('createdby', 847)
    //   ->whereIn('status', [1, 2, 3])
    //   ->whereNotIn('assignmentgenerate_id', ['OFF100004', 'OFF100003'])
    //   ->whereNotIn('client_id', [134])
    //   ->whereBetween('timesheetusers.date', [$startDate->format('Y-m-d'), $endDate->format('Y-m-d')])
    //   ->select('date') // Select only the date column
    //   ->distinct() // Apply distinct on the selected columns
    //   ->get();

    // dd($home);

    $promotionCheck = DB::table('teamrolehistory')
      ->where('teammember_id', $teamid)
      ->select('newstaff_code', 'created_at')
      ->first();

    $promotionorRejoinDate = $promotionCheck
      ? Carbon::parse($promotionCheck->created_at)->startOfDay()
      : null;

    // dd($attendancesstartDate);
    $query = DB::table('timesheetusers')
      ->leftJoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
      ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
      ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
        $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
          ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
      })
      ->leftJoin('clients', 'clients.id', 'timesheetusers.client_id')
      ->leftJoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
      ->leftJoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
      ->leftJoin('teamrolehistory', function ($join) {
        $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
          ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
      })
      ->where('timesheetusers.createdby', $teamid)
      ->whereIn('timesheetusers.status', [1, 2, 3])
      ->whereBetween('timesheetusers.date', [$startDate->format('Y-m-d'), $endDate->format('Y-m-d')])
      // hide offholidays and travel timesheet
      ->whereNotIn('timesheetusers.assignmentgenerate_id', ['OFF100004', 'OFF100003'])
      // hide  casual leave and exam leave timesheet
      ->whereNotIn('timesheetusers.client_id', [134])
      ->select(
        'timesheetusers.*',
        'assignments.assignment_name',
        'clients.client_name',
        'clients.client_code',
        'teammembers.team_member',
        'teammembers.staffcode',
        'patnerid.team_member as patnername',
        'patnerid.staffcode as patnerstaffcodee',
        'assignmentbudgetings.assignmentname',
        'teamrolehistory.newstaff_code as ptnrstaffcode',
        'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
        // 'assignmentbudgetings.created_at as assignmentcreateddate'
        'assignmentbudgetings.created_at as assignmentcreated'
      )
      ->orderBy('timesheetusers.date', 'DESC');

    // Apply filters for partner 
    if (auth()->user()->role_id == 13) {
    }

    $timesheetData = $query->get();

    $timesheetData = $this->promotionOrRejoined($timesheetData, $promotionCheck, $promotionorRejoinDate);

    return view('backEnd.timesheet.totalworkingdays', compact('timesheetData'));
  }







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\totalworkingdays.blade.php

                                 @foreach ($timesheetData as $timesheetDatas)
                                    <tr>
                                        <td style="display: none;">{{ $timesheetDatas->id }}</td>
                                        @if (Auth::user()->role_id == 11 ||
                                                Request::is('adminsearchtimesheet') ||
                                                (Auth::user()->role_id == 13 && Request::is('admintimesheetlist')))
                                            <td> {{ $timesheetDatas->team_member ?? '' }} </td>
                                            {{-- <td>{{ $timesheetDatas->teamnewstaffcode ?? ($timesheetDatas->staffcode ?? '') }}
                                            </td> --}}
                                            <td>{{ $timesheetDatas->final_teamstaffcode }}</td>
                                        @endif

                                        <td class="textfixed"> <span style="display: none;">
                                                {{ date('Y-m-d', strtotime($timesheetDatas->date)) }}</span>{{ date('d-m-Y', strtotime($timesheetDatas->date)) }}
                                        </td>
                                        <td class="textfixed">
                                            @if ($timesheetDatas->date != null)
                                                {{ date('l', strtotime($timesheetDatas->date)) }}
                                            @endif
                                        </td>
                                        <td class="textfixed">{{ $timesheetDatas->client_name ?? '' }}
                                        </td>
                                        <td>{{ $timesheetDatas->client_code ?? '' }}
                                        </td>
                                        <td class="textfixed">
                                            {{ $timesheetDatas->assignment_name ?? '' }}
                                            @if ($timesheetDatas->assignmentname != null)
                                                ({{ $timesheetDatas->assignmentname ?? '' }})
                                            @endif
                                        </td>
                                        <td>
                                            {{ $timesheetDatas->assignmentgenerate_id ?? '' }}
                                        </td>
                                        <td class="textfixed"> {{ $timesheetDatas->workitem ?? '' }}</td>
                                        <td class="textfixed">{{ $timesheetDatas->location ?? '' }} </td>
                                        <td class="textfixed"> {{ $timesheetDatas->patnername ?? '' }}
                                        </td>
                                        {{-- <td>{{ $timesheetDatas->ptnrstaffcode ?? ($timesheetDatas->patnerstaffcodee ?? '') }}
                                        </td> --}}
                                        <td>{{ $timesheetDatas->final_partnerstaffcode }}</td>
                                        <td>{{ $timesheetDatas->hour ?? '' }}</td>
                                    </tr>
                                @endforeach







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php

   public function totaltraveldays(Request $request, $teamid)
  {

    // total working days startfrom january to december 
    $currentDate = Carbon::now();
    $currentMonth = $currentDate->format('F');
    $startDate = Carbon::create($currentDate->year, 1, 1);
    $endDate = Carbon::create($currentDate->year, 12, 31);

    $promotionCheck = DB::table('teamrolehistory')
      ->where('teammember_id', $teamid)
      ->select('newstaff_code', 'created_at')
      ->first();

    $promotionorRejoinDate = $promotionCheck
      ? Carbon::parse($promotionCheck->created_at)->startOfDay()
      : null;

    $query = DB::table('timesheetusers')
      ->leftJoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
      ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
      ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
        $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
          ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
      })
      ->leftJoin('clients', 'clients.id', 'timesheetusers.client_id')
      ->leftJoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
      ->leftJoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
      ->leftJoin('teamrolehistory', function ($join) {
        $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
          ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
      })
      ->where('timesheetusers.createdby', $teamid)
      ->whereIn('timesheetusers.status', [1, 2, 3])
      ->whereBetween('timesheetusers.date', [$startDate->format('Y-m-d'), $endDate->format('Y-m-d')])
      // Get only travel data
      ->whereIn('timesheetusers.assignmentgenerate_id', ['OFF100003'])
      ->select(
        'timesheetusers.*',
        'assignments.assignment_name',
        'clients.client_name',
        'clients.client_code',
        'teammembers.team_member',
        'teammembers.staffcode',
        'patnerid.team_member as patnername',
        'patnerid.staffcode as patnerstaffcodee',
        'assignmentbudgetings.assignmentname',
        'teamrolehistory.newstaff_code as ptnrstaffcode',
        'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
        // 'assignmentbudgetings.created_at as assignmentcreateddate'
        'assignmentbudgetings.created_at as assignmentcreated'
      )
      ->orderBy('timesheetusers.date', 'DESC');

    // Apply role-specific filters if necessary
    if (auth()->user()->role_id == 13) {
      // Add any specific conditions or modifications for role_id 13 if needed.
    }

    $timesheetData = $query->get();

    $timesheetData = $this->promotionOrRejoined($timesheetData, $promotionCheck, $promotionorRejoinDate);

    return view('backEnd.timesheet.totaltraveldays', compact('timesheetData'));
  }
  
  
  
  
  
  
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\totaltraveldays.blade.php


                                <tbody>
                                 @php
                                     $hasData = false;
                                 @endphp
                                 @foreach ($timesheetData as $timesheetDatas)
                                     @php
                                         $timesheetanotherdata = DB::table('timesheetusers')
                                             ->where('timesheetid', $timesheetDatas->timesheetid)
                                             ->count();
                                     @endphp
                                     @if ($timesheetanotherdata <= 1)
                                         @php
                                             $hasData = true;
                                         @endphp
                                         <tr>
                                             <td style="display: none;">{{ $timesheetDatas->id }}</td>
                                             @if (Auth::user()->role_id == 11 ||
                                                     Request::is('adminsearchtimesheet') ||
                                                     (Auth::user()->role_id == 13 && Request::is('admintimesheetlist')))
                                                 <td> {{ $timesheetDatas->team_member ?? '' }} </td>
                                                 <td>{{ $timesheetDatas->final_teamstaffcode }}</td>
                                             @endif

                                             <td class="textfixed"> <span style="display: none;">
                                                     {{ date('Y-m-d', strtotime($timesheetDatas->date)) }}</span>{{ date('d-m-Y', strtotime($timesheetDatas->date)) }}
                                             </td>
                                             <td class="textfixed">
                                                 @if ($timesheetDatas->date != null)
                                                     {{ date('l', strtotime($timesheetDatas->date)) }}
                                                 @endif
                                             </td>
                                             <td class="textfixed">{{ $timesheetDatas->client_name ?? '' }}
                                             </td>
                                             <td>{{ $timesheetDatas->client_code ?? '' }}
                                             </td>
                                             <td class="textfixed">
                                                 {{ $timesheetDatas->assignment_name ?? '' }}
                                                 @if ($timesheetDatas->assignmentname != null)
                                                     ({{ $timesheetDatas->assignmentname ?? '' }})
                                                 @endif
                                             </td>
                                             <td>
                                                 {{ $timesheetDatas->assignmentgenerate_id ?? '' }}
                                             </td>
                                             <td class="textfixed"> {{ $timesheetDatas->workitem ?? '' }}</td>
                                             <td class="textfixed">{{ $timesheetDatas->location ?? '' }} </td>
                                             <td class="textfixed"> {{ $timesheetDatas->patnername ?? '' }}
                                             </td>
                                             <td>{{ $timesheetDatas->final_partnerstaffcode }}</td>
                                             <td>{{ $timesheetDatas->hour ?? '' }}</td>
                                         </tr>
                                     @endif
                                 @endforeach
                                 @if (!$hasData)
                                     <tr>
                                         <td colspan="11" style="text-align: center;">Data not available
                                         </td>
                                     </tr>
                                 @endif
                             </tbody>











22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php



   public function mytimesheetlist(Request $request, $teamid)
  {

    if (auth()->user()->role_id == 13) {
      $timesheetData = DB::table('timesheetusers')
        ->leftJoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
        ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
        ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
          $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
            ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
        })
        ->leftJoin('clients', 'clients.id', 'timesheetusers.client_id')
        ->leftJoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
        ->leftJoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
            ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
        })
        ->where('timesheetusers.createdby', $teamid)
        ->whereIn('timesheetusers.status', [1, 2, 3])
        ->whereNotNull('timesheetusers.date')
        ->select(
          'timesheetusers.*',
          'assignments.assignment_name',
          'clients.client_name',
          'clients.client_code',
          'teammembers.team_member',
          'teammembers.staffcode',
          'patnerid.team_member as patnername',
          'patnerid.staffcode as patnerstaffcodee',
          'assignmentbudgetings.assignmentname',
          'teamrolehistory.newstaff_code as ptnrstaffcode',
          'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
          'assignmentbudgetings.created_at as assignmentcreated'
        )
        ->orderBy('timesheetusers.date', 'DESC')
        ->limit(7)
        ->get();

      $timesheetData = $this->rejoinedOrPromotion($timesheetData);
    } else {
      $timesheetData = DB::table('timesheetusers')
        ->leftJoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
        ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
        ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
          $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
            ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
        })
        ->leftJoin('clients', 'clients.id', 'timesheetusers.client_id')
        ->leftJoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
        ->leftJoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
            ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
        })
        ->where('timesheetusers.createdby', $teamid)
        ->whereIn('timesheetusers.status', [1, 2, 3])
        ->whereNotNull('timesheetusers.date')
        ->select(
          'timesheetusers.*',
          'assignments.assignment_name',
          'clients.client_name',
          'clients.client_code',
          'teammembers.team_member',
          'teammembers.staffcode',
          'patnerid.team_member as patnername',
          'patnerid.staffcode as patnerstaffcodee',
          'assignmentbudgetings.assignmentname',
          'teamrolehistory.newstaff_code as ptnrstaffcode',
          'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
          'assignmentbudgetings.created_at as assignmentcreated'
        )
        ->orderBy('timesheetusers.date', 'DESC')
        ->limit(7)
        ->get();

      $timesheetData = $this->rejoinedOrPromotion($timesheetData);
    }
    session()->forget('_old_input');
    return view('backEnd.timesheet.timesheetdownload', compact('timesheetData'));
  }






















 public function searchingtimesheet(Request $request)
  {
    // Get all input from form
    $startDate = $request->input('startdate', null);
    $endDate = $request->input('enddate', null);
    $teamId = $request->input('teamid', null);
    $teammemberId = $request->input('teammemberId', null);
    // $year = $request->input('year', null);

    $teammembers = DB::table('teammembers')
      ->leftJoin('teamrolehistory', 'teamrolehistory.teammember_id', '=', 'teammembers.id')
      ->where('teammembers.status', 1)
      ->whereIn('teammembers.role_id', [14, 15, 13, 11])
      ->select('teammembers.team_member', 'teamrolehistory.newstaff_code', 'teammembers.id', 'teammembers.staffcode')
      ->orderBy('team_member', 'ASC')
      ->get();

    // For patner
    if (auth()->user()->role_id == 13) {
      $query = DB::table('timesheetusers')
        ->leftJoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
        ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
        ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
          $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
            ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
        })
        ->leftJoin('clients', 'clients.id', 'timesheetusers.client_id')
        ->leftJoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
        ->leftJoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
            ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
        })
        ->where('timesheetusers.createdby', $teamId)
        ->whereIn('timesheetusers.status', [1, 2, 3])
        ->whereNotNull('timesheetusers.date')
        ->whereBetween('timesheetusers.date', [$startDate, $endDate])
        ->select(
          'timesheetusers.*',
          'assignments.assignment_name',
          'clients.client_name',
          'clients.client_code',
          'teammembers.team_member',
          'teammembers.staffcode',
          'patnerid.team_member as patnername',
          'patnerid.staffcode as patnerstaffcodee',
          'assignmentbudgetings.assignmentname',
          'teamrolehistory.newstaff_code as ptnrstaffcode',
          'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
          'assignmentbudgetings.created_at as assignmentcreated'
        )
        ->orderBy('timesheetusers.date', 'DESC');

      $timesheetData = $query->get();

      $timesheetData = $this->rejoinedOrPromotion($timesheetData);

      $request->flash();
      return view('backEnd.timesheet.timesheetdownload', compact('timesheetData'));
    }
    // For staff and manager
    else {
      $query = DB::table('timesheetusers')
        ->leftJoin('teammembers', 'teammembers.id', 'timesheetusers.createdby')
        ->leftJoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'timesheetusers.assignmentgenerate_id')
        ->leftJoin('teamrolehistory as teamrolehistoryteam', function ($join) {
          $join->on('teamrolehistoryteam.teammember_id', '=', 'teammembers.id')
            ->whereRaw('teamrolehistoryteam.created_at < assignmentbudgetings.created_at');
        })
        ->leftJoin('clients', 'clients.id', 'timesheetusers.client_id')
        ->leftJoin('assignments', 'assignments.id', 'timesheetusers.assignment_id')
        ->leftJoin('teammembers as patnerid', 'patnerid.id', 'timesheetusers.partner')
        ->leftJoin('teamrolehistory', function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'patnerid.id')
            ->whereRaw('teamrolehistory.created_at < assignmentbudgetings.created_at');
        })
        ->where('timesheetusers.createdby', $teamId)
        ->whereIn('timesheetusers.status', [1, 2, 3])
        ->whereNotNull('timesheetusers.date')
        ->whereBetween('timesheetusers.date', [$startDate, $endDate])
        ->select(
          'timesheetusers.*',
          'assignments.assignment_name',
          'clients.client_name',
          'clients.client_code',
          'teammembers.team_member',
          'teammembers.staffcode',
          'patnerid.team_member as patnername',
          'patnerid.staffcode as patnerstaffcodee',
          'assignmentbudgetings.assignmentname',
          'teamrolehistory.newstaff_code as ptnrstaffcode',
          'teamrolehistoryteam.newstaff_code as teamnewstaffcode',
          'assignmentbudgetings.created_at as assignmentcreated'
        )
        ->orderBy('timesheetusers.date', 'DESC');

      $timesheetData = $query->get();

      $timesheetData = $this->rejoinedOrPromotion($timesheetData);
      // dd($timesheetData);
      $request->flash();
      return view('backEnd.timesheet.timesheetdownload', compact('timesheetData'));
    }
  }









22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\index.blade.php

                                      $dates = date('l', strtotime($timesheetDatas->date));

                                            $targetAssignments = [29, 34, 32, 33, 134];
                                            if (in_array($timesheetDatas->client_id, $targetAssignments)) {
                                                // teammember code
                                                $rejoindpromotioncheck = DB::table('teamrolehistory')
                                                    ->where('teammember_id', $timesheetDatas->createdby)
                                                    ->first();

                                                $timesheetDate = $timesheetDatas->date
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d',
                                                        $timesheetDatas->date,
                                                    )->startOfDay()
                                                    : null;

                                                $rejoindpromotioncheckdate = null;
                                                if ($rejoindpromotioncheck) {
                                                    $rejoindpromotioncheckdate = Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $rejoindpromotioncheck->created_at,
                                                    )->startOfDay();
                                                }

                                                // partner code
                                                $rejoindpromotioncheckpartner = DB::table('teamrolehistory')
                                                    ->where('teammember_id', $timesheetDatas->partner)
                                                    ->first();

                                                $timesheetDatepartner = $timesheetDatas->date
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d',
                                                        $timesheetDatas->date,
                                                    )->startOfDay()
                                                    : null;

                                                $rejoindpromotioncheckdatepartner = null;
                                                if ($rejoindpromotioncheckpartner) {
                                                    $rejoindpromotioncheckdatepartner = Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $rejoindpromotioncheckpartner->created_at,
                                                    )->startOfDay();
                                                }
                                            } else {
                                                $teamMembers = DB::table('teamrolehistory')
                                                    ->whereIn('teammember_id', [
                                                        $timesheetDatas->createdby,
                                                        $timesheetDatas->partner,
                                                    ])
                                                    ->get()
                                                    ->keyBy('teammember_id');

                                                $datadate = $timesheetDatas->assignmentcreated
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $timesheetDatas->assignmentcreated,
                                                    )
                                                    : null;

                                                $permotioncheck = $teamMembers[$timesheetDatas->createdby] ?? null;
                                                $approverdata = $teamMembers[$timesheetDatas->partner] ?? null;

                                                $permotiondate = $permotioncheck
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $permotioncheck->created_at,
                                                    )
                                                    : null;
                                                $approverdate = $approverdata
                                                    ? Carbon\Carbon::createFromFormat(
                                                        'Y-m-d H:i:s',
                                                        $approverdata->created_at,
                                                    )
                                                    : null;
                                            }
                                        @endphp
										
										
										
										
										
										
									

									
										
										
								


								
										
										

                                        <td>
                                            {{-- @if ($approverdata && $datadate && $datadate->greaterThan($approverdate))
                                                {{ $approverdata->newstaff_code }}
                                            @else
                                                {{ $client_id->staffcode ?? '' }}
                                            @endif
                                            @if (count((array) $client_id->team_member) > 1)
                                                ,
                                            @endif --}}
                                            @if (in_array($timesheetDatas->client_id, $targetAssignments))
                                                @if (
                                                    $rejoindpromotioncheckpartner &&
                                                        $timesheetDatepartner &&
                                                        $timesheetDatepartner->greaterThanOrEqualTo($rejoindpromotioncheckdatepartner))
                                                    {{ $rejoindpromotioncheckpartner->newstaff_code }}
                                                @else
                                                    {{ $client_id->staffcode ?? '' }}
                                                @endif
                                                @if (count((array) $client_id->team_member) > 1)
                                                    ,
                                                @endif
                                            @else
                                                @if ($approverdata && $datadate && $datadate->greaterThan($approverdate))
                                                    {{ $approverdata->newstaff_code }}
                                                @else
                                                    {{ $client_id->staffcode ?? '' }}
                                                @endif
                                                @if (count((array) $client_id->team_member) > 1)
                                                    ,
                                                @endif
                                            @endif
                                        </td>										
										
									




									
										


22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\rejectedlistteam.blade.php

                                 $dates = date('l', strtotime($timesheetDatas->date));

                                        $targetAssignments = [29, 34, 32, 33, 134];
                                        if (in_array($timesheetDatas->client_id, $targetAssignments)) {
                                            $rejoindpromotioncheck = DB::table('teamrolehistory')
                                                ->where('teammember_id', $timesheetDatas->createdby)
                                                ->first();

                                            $timesheetDate = $timesheetDatas->date
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d',
                                                    $timesheetDatas->date,
                                                )->startOfDay()
                                                : null;

                                            $rejoindpromotioncheckdate = null;
                                            if ($rejoindpromotioncheck) {
                                                $rejoindpromotioncheckdate = Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $rejoindpromotioncheck->created_at,
                                                )->startOfDay();
                                            }
                                        } else {
                                            $assignmentcheck = DB::table('assignmentbudgetings')
                                                ->where('assignmentgenerate_id', $timesheetDatas->assignmentgenerate_id)
                                                ->first();

                                            $teamMembers = DB::table('teamrolehistory')
                                                ->whereIn('teammember_id', [
                                                    $timesheetDatas->createdby,
                                                    $timesheetDatas->partner,
                                                ])
                                                ->get()
                                                ->keyBy('teammember_id');

                                            $datadate = $assignmentcheck
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $assignmentcheck->created_at,
                                                )
                                                : null;

                                            // dd($teamMembers);

                                            $permotioncheck = $teamMembers[$timesheetDatas->createdby] ?? null;
                                            $approverdata = $teamMembers[$timesheetDatas->partner] ?? null;

                                            $permotiondate = $permotioncheck
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $permotioncheck->created_at,
                                                )
                                                : null;
                                            $approverdate = $approverdata
                                                ? Carbon\Carbon::createFromFormat(
                                                    'Y-m-d H:i:s',
                                                    $approverdata->created_at,
                                                )
                                                : null;
                                        }

                                    @endphp
									
							




							
			

			
									
									
									
									
									
{{ $permotioncheck->newstaff_code }}									
									
									
									
                                    <td>
                                        @if (in_array($timesheetDatas->client_id, $targetAssignments))
                                            @if ($rejoindpromotioncheck && $timesheetDate && $timesheetDate->greaterThanOrEqualTo($rejoindpromotioncheckdate))
                                                {{ $rejoindpromotioncheck->newstaff_code }}
                                            @else
                                                {{ $timesheetDatas->staffcode }}
                                            @endif
                                        @else
                                            @if ($permotioncheck && $datadate && $datadate->greaterThan($permotiondate))
                                                {{ $permotioncheck->newstaff_code }}
                                            @else
                                                {{ $timesheetDatas->staffcode }}
                                            @endif
                                        @endif
                                    </td>									
									












    @if ($approverdata && $datadate && $datadate->greaterThan($approverdate))

                                      <td>
                                            @foreach ($client_id as $item)
                                                @php
                                                    if (in_array($item->client_id, $targetAssignments)) {
                                                        // partner code
                                                        $rejoindpromotioncheckpartner = DB::table('teamrolehistory')
                                                            ->where('teammember_id', $item->partner)
                                                            ->first();

                                                        $timesheetDatepartner = $item->date
                                                            ? Carbon\Carbon::createFromFormat(
                                                                'Y-m-d',
                                                                $item->date,
                                                            )->startOfDay()
                                                            : null;

                                                        $rejoindpromotioncheckdatepartner = null;
                                                        if ($rejoindpromotioncheckpartner) {
                                                            $rejoindpromotioncheckdatepartner = Carbon\Carbon::createFromFormat(
                                                                'Y-m-d H:i:s',
                                                                $rejoindpromotioncheckpartner->created_at,
                                                            )->startOfDay();
                                                        }
                                                    }
                                                @endphp
                                                @if (in_array($item->client_id, $targetAssignments))
                                                    @if (
                                                        $rejoindpromotioncheckpartner &&
                                                            $timesheetDatepartner &&
                                                            $timesheetDatepartner->greaterThanOrEqualTo($rejoindpromotioncheckdatepartner))
                                                        {{ $rejoindpromotioncheckpartner->newstaff_code }}
                                                    @else
                                                        {{ $item->staffcode ?? '' }}
                                                    @endif
                                                    @if ($item->staffcode != null)
                                                        ,
                                                    @endif
                                                @else
                                                    @if ($approverdata && $datadate && $datadate->greaterThan($approverdate))
                                                        {{ $approverdata->newstaff_code }}
                                                    @else
                                                        {{ $item->staffcode ?? '' }}
                                                    @endif
                                                    @if ($item->staffcode != null)
                                                        ,
                                                    @endif
                                                @endif
                                            @endforeach
                                        </td>
										
										
						




						
		


		

22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php

 public function searchingtimesheet(Request $request)
add this 2 function after searched function


 private function rejoinedOrPromotion($timesheetData)
  {
    $targetClients = [29, 34, 32, 33, 134];
    $createdbyIds = $timesheetData->pluck('createdby')->unique()->toArray();

    $promotionData = DB::table('teamrolehistory')
      ->whereIn('teammember_id', $createdbyIds)
      ->select('teammember_id', 'newstaff_code', 'created_at')
      ->get()
      ->keyBy('teammember_id');

    $partnerIds = $timesheetData->pluck('partner')->unique()->filter()->values();

    $promotionChecksPartner = DB::table('teamrolehistory')
      ->whereIn('teammember_id', $partnerIds)
      ->select('teammember_id', 'newstaff_code', 'created_at')
      ->get()
      ->keyBy('teammember_id')
      ->map(fn($row) => [
        'newstaff_code' => $row->newstaff_code,
        'promotion_date' => Carbon::parse($row->created_at)->startOfDay(),
      ]);

    return $timesheetData->map(function ($row) use ($targetClients, $promotionData, $promotionChecksPartner) {

      $row->final_staffcode = $row->teamnewstaffcode ?? $row->staffcode ?? '';
      if (in_array($row->client_id, $targetClients) && $row->date) {
        $dataDate = Carbon::parse($row->date)->startOfDay();
        $promotion = $promotionData[$row->createdby] ?? null;
        if ($promotion && $dataDate->greaterThanOrEqualTo(Carbon::parse($promotion->created_at)->startOfDay())) {
          $row->final_staffcode = $promotion->newstaff_code;
        } else {
          $row->final_staffcode = $row->staffcode ?? '';
        }
      }

      $row->final_partnerstaffcode = $row->ptnrstaffcode ?? $row->patnerstaffcodee ?? '';
      if (in_array($row->client_id, $targetClients) && $row->date) {
        $dataDate = Carbon::parse($row->date)->startOfDay();
        $promotionPartner = $promotionChecksPartner->get($row->partner);
        if ($promotionPartner && $dataDate->greaterThanOrEqualTo($promotionPartner['promotion_date'])) {
          $row->final_partnerstaffcode = $promotionPartner['newstaff_code'];
        } else {
          $row->final_partnerstaffcode = $row->ptnrstaffcode ?? $row->patnerstaffcodee ?? '';
        }
      }
      return $row;
    });
  }




  private function promotionOrRejoined($timesheetData, $promotionCheck, $promotionorRejoinDate)
  {

    $targetClients = [29, 34, 32, 33, 134];
    $partnerIds = $timesheetData->pluck('partner')->unique()->filter()->values();
    $promotionChecksPartner = DB::table('teamrolehistory')
      ->whereIn('teammember_id', $partnerIds)
      ->select('teammember_id', 'newstaff_code', 'created_at')
      ->get()
      ->keyBy('teammember_id')
      ->map(fn($row) => [
        'newstaff_code' => $row->newstaff_code,
        'promotion_date' => Carbon::parse($row->created_at)->startOfDay(),
      ]);

    return $timesheetData->map(function ($row) use ($targetClients, $promotionCheck, $promotionorRejoinDate, $promotionChecksPartner) {
      $row->final_teamstaffcode = $row->teamnewstaffcode ?? $row->staffcode ?? '';
      if (in_array($row->client_id, $targetClients) && $row->date) {
        $dataDate = Carbon::parse($row->date)->startOfDay();
        if ($promotionCheck && $dataDate->greaterThanOrEqualTo($promotionorRejoinDate)) {
          $row->final_teamstaffcode = $promotionCheck->newstaff_code;
        } else {
          $row->final_teamstaffcode = $row->staffcode ?? '';
        }
      }

      $row->final_partnerstaffcode = $row->ptnrstaffcode ?? $row->patnerstaffcodee ?? '';
      if (in_array($row->client_id, $targetClients) && $row->date) {
        $dataDate = Carbon::parse($row->date)->startOfDay();
        $promotionPartner = $promotionChecksPartner->get($row->partner);
        if ($promotionPartner && $dataDate->greaterThanOrEqualTo($promotionPartner['promotion_date'])) {
          $row->final_partnerstaffcode = $promotionPartner['newstaff_code'];
        } else {
          $row->final_partnerstaffcode = $row->ptnrstaffcode ?? $row->patnerstaffcodee ?? '';
        }
      }

      return $row;
    });
  }









For the following five clients, Off/Holidays, Official Travel, Unallocated, Seminar/Conference and Apply Leave, the old code is still appearing the old code is still appearing. end hare 
















The filter reset functionality should clear all applied filters ```start 
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\applyleave\teamapplication.blade.php
 value="{{ old('endperiod') }}">
 

                             <div class="col-{{ Request::is('applyleave') ? '4' : '3' }}">
                                <div class="form-group">
                                    <strong> <label class="font-weight-600">End Leave Period <span id="endPeriodAsterisk"
                                                class="text-danger d-none">*</span></label></strong>
                                    <input type="date" class="form-control endclass" id="endperiod1" name="endperiod"
                                        value="{{ old('endperiod') }}">
                                </div>
                            </div>









 <div class="col-1 d-flex justify-content-center align-items-center">
 
 
 

                             @if (Request::is('filtering-applyleve'))
                                <div class="col-1 d-flex justify-content-center align-items-center">
                                    <div class="form-group m-0">
                                        <a href="{{ url('/applyleave') }}">
                                            <img src="{{ url('backEnd/image/reload.png') }}"
                                                style="width: 30px; height: 30px;" alt="Reload">
                                        </a>
                                    </div>
                                </div>
                            @endif
							
							
							






22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\myteamindex.blade.php

<label class="font-weight-600">End Date</label>

                         <div class="col-4" id="end-date-col">
                              <div class="form-group">
                                  <label class="font-weight-600">End Date</label>
                                  <input type="date" class="form-control" name="end" id="end">
                              </div>
                          </div>



<label class="font-weight-600">End Date</label>  after this div add below code 


                         <div class="col-1 d-flex justify-content-center align-items-center" id="reload-button-template">
                              @php
                                  $reloadUrl = null;

                                  if (Auth::user()->role_id == 13 && Request::is('timesheet/teamlist')) {
                                      $reloadUrl = url('/timesheet/teamlist');
                                  } elseif (Auth::user()->role_id == 11) {
                                      $reloadUrl = url('/timesheet/allteamsubmitted');
                                  } elseif (Auth::user()->role_id == 13 && Request::is('timesheet/partnersubmitted')) {
                                      $reloadUrl = url('/timesheet/partnersubmitted');
                                  } elseif (
                                      (Auth::user()->role_id == 14 && Request::is('timesheet/teamlist')) ||
                                      (Auth::user()->role_id == 15 && Request::is('timesheet/teamlist'))
                                  ) {
                                      $reloadUrl = url('/timesheet/teamlist');
                                  }
                              @endphp

                              <div class="form-group m-0 d-none">
                                  @if ($reloadUrl)
                                      <a href="{{ $reloadUrl }}">
                                          <img src="{{ url('backEnd/image/reload.png') }}"
                                              style="width: 30px; height: 30px; margin-top: 12px;" alt="Reload">
                                      </a>
                                  @endif
                              </div>
                          </div>
						  
						  
						  
						  
						  
		

		
						  
						  
 var search9 = $('#end').val();

 
						  
              var search9 = $('#end').val();

              $('#end-date-col').removeClass('col-4').addClass('col-3');

              if ($('#reload-button-template .form-group').hasClass('d-none')) {
                  $('#reload-button-template .form-group').removeClass('d-none');
              }				  




22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\assignmentlistwithhour.blade.php

 <link href="https://cdn.datatables.net/buttons/1.7.1/css/buttons.dataTables.min.css" rel="stylesheet">

 <link href="{{ url('backEnd/plugins/select2/dist/css/select2.min.css') }}" rel="stylesheet">
 <link href="{{ url('backEnd/plugins/select2-bootstrap4/dist/select2-bootstrap4.min.css') }}" rel="stylesheet">
 <link href="{{ url('backEnd/plugins/jquery.sumoselect/sumoselect.min.css') }}" rel="stylesheet">







<form method="get" action="{{ url('totaltimeshow/filter') }}" enctype="multipart/form-data">


                     <form method="get" action="{{ url('totaltimeshow/filter') }}" enctype="multipart/form-data">
                             @csrf
                             @php
                                 $teamselect = $teammemberDatas->unique('teamid')->sortBy('team_member');
                                 $partnerselect = $teammemberDatas
                                     ->unique('assignmentgenerate_id')
                                     ->sortBy('assignmentgenerate_id');
                             @endphp
                             <div class="row">
                                 <div class="col-5">
                                     <div class="form-group">
                                         <strong><label for="employee">Teammember</label></strong>
                                         <select class="language form-control" id="employee" name="employee">
                                             <option value="">Please Select One</option>
                                             @foreach ($teamselect as $teammemberData)
                                                 @php
                                                     $permotioncheck = $roleHistories->get($teammemberData->teamid);
                                                     $displayCode =
                                                         $permotioncheck->newstaff_code ?? $teammemberData->staffcode;
                                                 @endphp
                                                 <option
                                                     value="{{ $teammemberData->teamid }}/{{ $teammemberData->role_id }}"
                                                     {{ old('employee') == $teammemberData->teamid . '/' . $teammemberData->role_id ? 'selected' : '' }}>
                                                     {{ $teammemberData->team_member }} ({{ $displayCode }})
                                                 </option>
                                             @endforeach
                                         </select>
                                     </div>
                                 </div>
                                 <div class="col-{{ Request::is('totaltimeshow') ? '5' : '4' }}">
                                     <div class="form-group">
                                         <strong><label for="assignmentgenerateid">Assignment Id</label></strong>
                                         <select class="language form-control" id="assignmentgenerateid"
                                             name="assignmentgenerateid">
                                             <option value="">Please Select One</option>
                                             @foreach ($partnerselect as $assignmentData)
                                                 <option value="{{ $assignmentData->assignmentgenerate_id }}"
                                                     {{ old('assignmentgenerateid') == $assignmentData->assignmentgenerate_id ? 'selected' : '' }}>
                                                     {{ $assignmentData->assignmentgenerate_id }}
                                                 </option>
                                             @endforeach
                                         </select>
                                     </div>
                                 </div>
                                 <div class="col-2 mb-3">
                                     <div class="form-group">
                                         <label for="search">&nbsp;</label>
                                         <button type="submit" class="btn btn-success btn-block">Search</button>
                                     </div>
                                 </div>
                                 @if (Request::is('totaltimeshow/filter'))
                                     <div class="col-1 d-flex justify-content-center align-items-center">
                                         <div class="form-group m-0">
                                             <a href="{{ url('/totaltimeshow') }}">
                                                 <img src="{{ url('backEnd/image/reload.png') }}"
                                                     style="width: 30px; height: 30px;" alt="Reload">
                                             </a>
                                         </div>
                                     </div>
                                 @endif
                             </div>
                         </form>
					 
					
					
					
					

					
					 
					 
					 
					 
					 
<table id="examplee" class="display nowrap">



                       <table id="examplee" class="table display table-bordered table-striped table-hover">





22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\AttendanceController.php
public function index()
  if (auth()->user()->role_id == 11 || auth()->user()->role_id == 13) {
  
  
  
  
       if (auth()->user()->role_id == 11 || auth()->user()->role_id == 13) {
            session()->forget('_old_input');







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\attendance\adminattendance.blade.php
<strong><label for="teammemberId">Employee Name</label></strong>

	
	
     <div class="col-md-{{ Request::is('attendance-filter') ? '3' : '4' }} col-sm-6 mb-3">







 <button type="submit" class="btn btn-success btn-block">Search</button> after this div
 

                            @if (Request::is('attendance-filter'))
                                <div class="col-1 d-flex justify-content-center align-items-center">
                                    <div class="form-group m-0">
                                        <a href="{{ url('/attendance') }}">
                                            <img src="{{ url('backEnd/image/reload.png') }}"
                                                style="width: 30px; height: 30px;" alt="Reload">
                                        </a>
                                    </div>
                                </div>
                            @endif
							
							
							
							

22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\timesheetdownload.blade.php



                                  <th>Action</th>
                                   @if (Request::is('adminsearchtimesheet'))
                                      <th>Refresh</th>
                                  @elseif (Request::is('searchingtimesheet'))
                                      <th>Refresh</th>
                                  @endif

								  		

										
								  
								  
<button type="submit" class="btn btn-success">Search</button> add below code after this td


								  
                                  @php
                                      $reloadUrl = null;
                                      if (Request::is('adminsearchtimesheet')) {
                                          $reloadUrl = url('/admintimesheetlist');
                                      } elseif (Request::is('searchingtimesheet')) {
                                          $reloadUrl = url('/mytimesheetlist/' . auth()->user()->teammember_id);
                                      }
                                  @endphp

                                  @if ($reloadUrl)
                                      <td class="d-flex justify-content-center align-items-center">
                                          <a href="{{ $reloadUrl }}">
                                              <img src="{{ url('backEnd/image/reload.png') }}"
                                                  style="width: 30px; height: 30px;" alt="Reload">
                                          </a>
                                      </td>
                                  @endif

								  





22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php
 public function admintimesheetlist(Request $request)



  public function admintimesheetlist(Request $request)
  {
    session()->forget('_old_input');
	
	
	
	

admin done 
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\applyleave\index.blade.  ````baki


                                   <div class="col-4">
                                        <div class="form-group">
                                            <strong> <label class="font-weight-600">End Leave Period <span
                                                        id="endPeriodAsterisk"
                                                        class="text-danger d-none">*</span></label></strong>
                                            <input type="date" class="form-control endclass" id="endperiod1"
                                                name="endperiod">
                                        </div>
                                    </div>
									
									
remove it  

                                   <div class="col-1 d-flex justify-content-center align-items-center">
                                        <div class="form-group m-0">
                                            <a href="{{ url('/applyleave') }}">
                                                <img src="{{ url('backEnd/image/reload.png') }}"
                                                    style="width: 30px; height: 30px;" alt="Reload">
                                            </a>
                                        </div>
                                    </div>									




22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\myteamindex.blade.php
<img src="{{ url('backEnd/image/reload.png') }}"


                          <div class="col-1 d-flex justify-content-center align-items-center" id="reload-button-template">
                              @php
                                  $reloadUrl = null;

                                  if (Auth::user()->role_id == 13 && Request::is('timesheet/teamlist')) {
                                      $reloadUrl = url('/timesheet/teamlist');
                                  } elseif (Auth::user()->role_id == 11) {
                                      $reloadUrl = url('/timesheet/allteamsubmitted');
                                  } elseif (Auth::user()->role_id == 13 && Request::is('timesheet/partnersubmitted')) {
                                      $reloadUrl = url('/timesheet/partnersubmitted');
                                  } elseif (
                                      (Auth::user()->role_id == 14 && Request::is('timesheet/teamlist')) ||
                                      (Auth::user()->role_id == 15 && Request::is('timesheet/teamlist'))
                                  ) {
                                      $reloadUrl = url('/timesheet/teamlist');
                                  }
                              @endphp

                              <div class="form-group m-0 d-none">
                                  @if ($reloadUrl)
                                      <a href="{{ $reloadUrl }}">
                                          <img src="{{ url('backEnd/image/reload.png') }}"
                                              style="width: 30px; height: 30px; margin-top: 12px;" alt="Reload">
                                      </a>
                                  @endif
                              </div>
                          </div>






22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\myteamindex.blade.php
 <div class="form-group m-0 d-none">
 
  <div class="col-1 d-flex justify-content-center align-items-center" id="reload-button-template">
                              @php
                                  $reloadUrl = null;

                                  if (Auth::user()->role_id == 13 && Request::is('timesheet/teamlist')) {
                                      $reloadUrl = url('/timesheet/teamlist');
                                  } elseif (Auth::user()->role_id == 11) {
                                      $reloadUrl = url('/timesheet/allteamsubmitted');
                                  } elseif (Auth::user()->role_id == 13 && Request::is('timesheet/partnersubmitted')) {
                                      $reloadUrl = url('/timesheet/partnersubmitted');
                                  } elseif (
                                      (Auth::user()->role_id == 14 && Request::is('timesheet/teamlist')) ||
                                      (Auth::user()->role_id == 15 && Request::is('timesheet/teamlist'))
                                  ) {
                                      $reloadUrl = url('/timesheet/teamlist');
                                  }
                              @endphp

                              <div class="form-group m-0 d-none">
                                  @if ($reloadUrl)
                                      <a href="{{ $reloadUrl }}">
                                          <img src="{{ url('backEnd/image/reload.png') }}"
                                              style="width: 30px; height: 30px; margin-top: 12px;" alt="Reload">
                                      </a>
                                  @endif
                              </div>
                          </div>







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\timesheetdownload.blade.php


                                  @php
                                      $reloadUrl = null;
                                      if (Request::is('adminsearchtimesheet')) {
                                          $reloadUrl = url('/admintimesheetlist');
                                      } elseif (Request::is('searchingtimesheet')) {
                                          $reloadUrl = url('/mytimesheetlist/' . auth()->user()->teammember_id);
                                      }
                                  @endphp

                                  @if ($reloadUrl)
                                      <td class="d-flex justify-content-center align-items-center">
                                          <a href="{{ $reloadUrl }}">
                                              <img src="{{ url('backEnd/image/reload.png') }}"
                                                  style="width: 30px; height: 30px;" alt="Reload">
                                          </a>
                                      </td>
                                  @endif
								  






                                   @if (Request::is('adminsearchtimesheet'))
                                      <th>Refresh</th>
                                  @elseif (Request::is('searchingtimesheet'))
                                      <th>Refresh</th>
                                  @endif
								  
								  
								  
								  

22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\AttendanceController.php
public function index()



             } else {
            session()->forget('_old_input');





app\Http\Controllers\TimesheetController.php

 public function assignmentHourShow()
  {
    // Fetch all necessary data with a single query per table
    session()->forget('_old_input');
	
	
	
	
	
	
	
app\Http\Controllers\TimesheetController.php
 public function mytimesheetlist(Request $request, $teamid)




   session()->forget('_old_input');
    return view('backEnd.timesheet.timesheetdownload', compact('timesheetData'));





22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\attendance\teamattendance.blade.php
<button type="submit" class="btn btn-success btn-block">Search</button> after this dive add it 



                             @if (Request::is('attendance-filter'))
                                <div class="col-1 d-flex justify-content-center align-items-center">
                                    <div class="form-group m-0">
                                        <a href="{{ url('/attendance') }}">
                                            <img src="{{ url('backEnd/image/reload.png') }}"
                                                style="width: 30px; height: 30px;" alt="Reload">
                                        </a>
                                    </div>
                                </div>
                            @endif




<label for="teammemberId">




                           <div class="col-md-{{ Request::is('attendance-filter') ? '3' : '4' }} col-sm-6 mb-3">
 



 

22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\myteamindex.blade.php


                          <div class="col-1 d-flex justify-content-center align-items-center" id="reload-button-template">
                              @php
                                  $reloadUrl = null;

                                  if (Auth::user()->role_id == 13 && Request::is('timesheet/teamlist')) {
                                      $reloadUrl = url('/timesheet/teamlist');
                                  } elseif (Auth::user()->role_id == 11) {
                                      $reloadUrl = url('/timesheet/allteamsubmitted');
                                  } elseif (Auth::user()->role_id == 13 && Request::is('timesheet/partnersubmitted')) {
                                      $reloadUrl = url('/timesheet/partnersubmitted');
                                  } elseif (
                                      (Auth::user()->role_id == 14 && Request::is('timesheet/teamlist')) ||
                                      (Auth::user()->role_id == 15 && Request::is('timesheet/teamlist'))
                                  ) {
                                      $reloadUrl = url('/timesheet/teamlist');
                                  }
                              @endphp

                              <div class="form-group m-0 d-none">
                                  @if ($reloadUrl)
                                      <a href="{{ $reloadUrl }}">
                                          <img src="{{ url('backEnd/image/reload.png') }}"
                                              style="width: 30px; height: 30px; margin-top: 12px;" alt="Reload">
                                      </a>
                                  @endif
                              </div>
                          </div>
						  
						  
						  






22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\timesheetdownload.blade.php
<img src="{{ url('backEnd/image/reload.png') }}"

                                  @php
                                      $reloadUrl = null;
                                      if (Request::is('adminsearchtimesheet')) {
                                          $reloadUrl = url('/admintimesheetlist');
                                      } elseif (Request::is('searchingtimesheet')) {
                                          $reloadUrl = url('/mytimesheetlist/' . auth()->user()->teammember_id);
                                      }
                                  @endphp

                                  @if ($reloadUrl)
                                      <td class="d-flex justify-content-center align-items-center">
                                          <a href="{{ $reloadUrl }}">
                                              <img src="{{ url('backEnd/image/reload.png') }}"
                                                  style="width: 30px; height: 30px;" alt="Reload">
                                          </a>
                                      </td>
                                  @endif
								  
								  
						

						

22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\independence\independencereport.blade.php
<button type="submit" class="btn btn-success 
after this dive 

                            @if (Request::is('filterindependencereport'))
                                <div class="col-1 d-flex justify-content-center align-items-center">
                                    <div class="form-group m-0">
                                        <a href="{{ url('/independencereport') }}">
                                            <img src="{{ url('backEnd/image/reload.png') }}"
                                                style="width: 30px; height: 30px;" alt="Reload">
                                        </a>
                                    </div>
                                </div>
                            @endif
							
							
							
							
							
							
							
 <strong><label for="teammemberId">Team Member</label></strong>

 
                           <div class="col-md-{{ Request::is('filterindependencereport') ? '3' : '4' }} col-sm-6">	
		




22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\timesheet\hrindex.blade.php
<button type="submit" class="btn btn-success" style="float:right"> Submit</button>
after this div add 

                        @if (Request::is('timesheet/search'))
                            <div class="col-1 d-flex justify-content-center align-items-center">
                                <div class="form-group m-0">
                                    <a href="{{ url('/timesheet/fulllist') }}">
                                        <img src="{{ url('backEnd/image/reload.png') }}" style="width: 30px; height: 30px;"
                                            alt="Reload">
                                    </a>
                                </div>
                            </div>
                        @endif
						
						
						






js me change jo kiya hai use update karna hai 
resources\views\backEnd\layouts\includes\js.blade.php	

// **Find Next Sunday**  
                 while (endDate.getDay() !== 0) {
                     endDate.setDate(endDate.getDate() + 1);
                 }

                 //  prevent date after current date 
                 //  if (endDate.getTime() > today.getTime()) {
                 //      endDate = new Date(today);
                 //      //  endDate.setDate(today.getDate());
                 //  }

                 //  if (endDate.getTime() > today.getTime()) {
                 //      endDate = new Date(today);
                 //  }
                 //  if (originalDate.getTime() > today.getTime()) {
                 //      originalDate = new Date(today);
                 //  }

                 //  prevent date after current date
                 if (endDate.getTime() > today.getTime() && originalDate.getTime() < today.getTime()) {
                     endDate = new Date(today);
                     //  endDate.setDate(today.getDate());
                 }

                 //  prevent date after current date
                 if (originalDate.getTime() > today.getTime() && endDate.getTime() > today.getTime()) {
                     originalDate = new Date(originalDate);
                     //  endDate = new Date(endDate);
                     endDate = new Date(originalDate);
                 }

                 console.log('Original Date:', originalDate);
                 console.log('Next Sunday:', endDate);







 
C:\xampp\htdocs\vsalive\public\backEnd\image
reload image add on vsalive ``baki 


resources\views\backEnd\timesheet\timesheetdownload.blade.php


                                          @if (Auth::user()->role_id == 11 ||
                                                  Request::is('adminsearchtimesheet') ||
                                                  (Auth::user()->role_id == 13 && Request::is('admintimesheetlist')))
                                              <td> {{ $timesheetDatas->team_member ?? '' }} </td>
                                              <td>{{ $timesheetDatas->final_staffcode }}</td>
                                          @endif





resources\views\backEnd\applyleave\teamapplication.blade.php
   @if (Request::is('filtering-applyleve'))  ise search btn ke baad rakhe 

                             <div class="col-md-2 col-sm-6 mb-3">
                                 <div class="form-group">
                                     <label for="search">&nbsp;</label>
                                     <button type="submit" class="btn btn-success btn-block">Search</button>
                                 </div>
                             </div>

                             @if (Request::is('filtering-applyleve'))
                                 <div class="col-1 d-flex justify-content-center align-items-center">
                                     <div class="form-group m-0">
                                         <a href="{{ url('/applyleave') }}">
                                             <img src="{{ url('backEnd/image/reload.png') }}"
                                                 style="width: 30px; height: 30px;" alt="Reload">
                                         </a>
                                     </div>
                                 </div>
                             @endif
										  




The filter reset functionality should clear all applied filters ```end hare 

										  
above sab updated hai vsalive temp 09-10-2025 file me 										  
										  
										  



13-10-2-25 ```start 22222
1.The design of the navigation button should be fixed. (UAT Pass)
2.Apply Leave: In the Team Application tab on the Partner ID, the latest data should appear by default, and the filter functionality should work correctly. (UAT Pass)
3.After a user rejoins, when the admin filters the data, a warning message appears like 'User left on (date)'. (UAT Pass)

4.After rejoining, the user's old code is still displayed in the 'Assignment Time Report' tab.(UAT Pass)
5.After rejoining when user fill timesheet for a new assignment, their old code is still displayed in the 'Partner' column.(UAT pass)

task ids = 366, 368, 369, 370, 371

The design of the navigation button should be fixed. (UAT Pass) ```start hare 
vsademo, vsalocal,
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\viewassignment.blade.php

<div class="content-header row align-items-center m-0">
        <nav aria-label="breadcrumb" class="col-sm-8 order-sm-last mb-3 mb-sm-0 p-0 ">
            <ol class="breadcrumb d-inline-flex font-weight-600 fs-13 bg-white mb-0 float-sm-right"
                style="flex-wrap: nowrap; white-space: nowrap;">
                @if ($assignmentbudgetingDatas->independenceform == 2)
                    <li class="d-inline-block">
                        @if (in_array(Auth::user()->role_id, [11, 13]) || $assignmentbudgetingDatas->type == 0)
                            <a class="btn btn-danger"
                                href="{{ url('/independencelist/' . $assignmentbudgetingDatas->assignmentgenerate_id) }}">
                                Independence
                            </a>
                        @elseif (in_array(Auth::user()->role_id, [14, 15]) || $assignmentbudgetingDatas->type == 0)
                            <a class="btn btn-success"
                                href="{{ url('independence/create/' . $assignmentbudgetingDatas->assignmentgenerate_id) }}"
                                style="color: white">
                                Submit Independence Form
                            </a>
                        @endif
                    </li>
                @endif
                @if (Auth::user()->role_id == 11 ||
                        Auth::user()->role_id == 13 ||
                        Auth::user()->role_id == 14 ||
                        Auth::user()->role_id == 15)
                    <li class="d-inline-block" style="margin-left: 13px;">
                        <a class="btn btn-success"
                            href="{{ url('/assignmentconfirmation/' . $assignmentbudgetingDatas->assignmentgenerate_id) }}">Confirmation
                        </a>
                    </li>
                @endif
                <li class="d-inline-block" style="margin-left: 13px;">
                    <a class="btn btn-info"
                        href="{{ url('/yearwise?' . 'year=' . $assignmentbudgetingDatas->year . '&&' . 'clientid=' . $assignmentbudgetingDatas->client_id) }}">Back</a>
                </li>

                <li class="d-inline-block" style="margin-left: 13px;">
                    <a class="btn btn-primary"
                        href="{{ url('assignmentfolders/' . $assignmentbudgetingDatas->assignmentgenerate_id) }}">
                        All Files And Folders</a>
                </li>

            </ol>
        </nav>

        <div class="col-sm-4 header-title p-0">
            <div class="media">
                <div class="header-icon text-success mr-3"><i class="typcn typcn-puzzle-outline"></i></div>
                <div class="media-body">
                    <h1 class="font-weight-bold">Assignment Details</h1>
                    <small>Assignment List</small>
                </div>
            </div>
        </div>
    </div>

	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	or 
	
	  <ol class="breadcrumb d-inline-flex font-weight-600 fs-13 bg-white mb-0 float-sm-right"
                style="flex-wrap: nowrap; white-space: nowrap;">
				
				
first li 
<li class="d-inline-block">

after all li 
 <li class="d-inline-block" style="margin-left: 13px;">				








22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\assignmentfolder\index.blade.php
<nav aria-label="breadcrumb"

	
	  <ol class="breadcrumb d-inline-flex font-weight-600 fs-13 bg-white mb-0 float-sm-right"
                style="flex-wrap: nowrap; white-space: nowrap;">
		

		
				
first li 
<li class="d-inline-block">

after all li 
 <li class="d-inline-block" style="margin-left: 13px;">				






22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\independence\indexlist.blade.php
<nav aria-label="breadcrumb"

	
	  <ol class="breadcrumb d-inline-flex font-weight-600 fs-13 bg-white mb-0 float-sm-right"
                style="flex-wrap: nowrap; white-space: nowrap;">
				
				
first li 
<li class="d-inline-block">

after all li 
 <li class="d-inline-block" style="margin-left: 13px;">	





22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\assignmentfolderfile\index.blade.php
<nav aria-label="breadcrumb"

	
	  <ol class="breadcrumb d-inline-flex font-weight-600 fs-13 bg-white mb-0 float-sm-right"
                style="flex-wrap: nowrap; white-space: nowrap;">
				
				
first li 
<li class="d-inline-block">

after all li 
 <li class="d-inline-block" style="margin-left: 13px;">	






The design of the navigation button should be fixed. ```end hare 







In the Team Application tab on the Partner ID, the latest data should appear by default ```start ``1122
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php
  public function index()
} else {


     
		
		
		   $teamapplyleaveDatasfilter  = DB::table('applyleaves')
        ->leftjoin('leavetypes', 'leavetypes.id', 'applyleaves.leavetype')
        ->leftjoin('teammembers', 'teammembers.id', 'applyleaves.createdby')
        ->leftJoin('roles', 'roles.id', '=', 'teammembers.role_id')
        ->leftJoin(DB::raw('
          (SELECT teammember_id, newstaff_code 
           FROM teamrolehistory 
           WHERE created_at = (SELECT MAX(created_at) 
                               FROM teamrolehistory th2 
                               WHERE th2.teammember_id = teamrolehistory.teammember_id)
          ) AS teamrolehistory
      '), function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'teammembers.id');
        })
        ->where('applyleaves.approver', auth()->user()->teammember_id)
        ->select('applyleaves.*', 'teammembers.team_member', 'teammembers.staffcode', 'teammembers.emailid', 'roles.rolename', 'leavetypes.name', 'teamrolehistory.newstaff_code')
        ->distinct()
        ->get();
		
		
pass this varable in view $teamapplyleaveDatasfilter




and 

 } elseif ($permotioncheck && auth()->user()->role_id == 13) {


        $teamapplyleaveDatasfilter  = DB::table('applyleaves')
        ->leftjoin('leavetypes', 'leavetypes.id', 'applyleaves.leavetype')
        ->leftjoin('teammembers', 'teammembers.id', 'applyleaves.createdby')
        ->leftJoin('roles', 'roles.id', '=', 'teammembers.role_id')
        ->leftJoin(DB::raw('
          (SELECT teammember_id, newstaff_code 
           FROM teamrolehistory 
           WHERE created_at = (SELECT MAX(created_at) 
                               FROM teamrolehistory th2 
                               WHERE th2.teammember_id = teamrolehistory.teammember_id)
          ) AS teamrolehistory
      '), function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'teammembers.id');
        })
        ->where('applyleaves.approver', auth()->user()->teammember_id)
        ->select('applyleaves.*', 'teammembers.team_member', 'teammembers.staffcode', 'teammembers.emailid', 'roles.rolename', 'leavetypes.name', 'teamrolehistory.newstaff_code')
        ->distinct()
        ->get();
		
	
	
pass this varable in view $teamapplyleaveDatasfilter






22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php
  public function filterDataAdmin(Request $request)
   $hasPendingRequests = $teamapplyleaveDatas->contains('status', 0);
     

    if (auth()->user()->role_id == 13) {
      $teamapplyleaveDatasfilter  = DB::table('applyleaves')
        ->leftjoin('leavetypes', 'leavetypes.id', 'applyleaves.leavetype')
        ->leftjoin('teammembers', 'teammembers.id', 'applyleaves.createdby')
        ->leftJoin('roles', 'roles.id', '=', 'teammembers.role_id')
        ->leftJoin(DB::raw('
    (SELECT teammember_id, newstaff_code 
     FROM teamrolehistory 
     WHERE created_at = (SELECT MAX(created_at) 
                         FROM teamrolehistory th2 
                         WHERE th2.teammember_id = teamrolehistory.teammember_id)
    ) AS teamrolehistory
    '), function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'teammembers.id');
        })
        ->where('applyleaves.approver', auth()->user()->teammember_id)
        ->select('applyleaves.*', 'teammembers.team_member', 'teammembers.staffcode', 'teammembers.emailid', 'roles.rolename', 'leavetypes.name', 'teamrolehistory.newstaff_code')
        ->distinct()
        ->get();
    } else {
      $teamapplyleaveDatasfilter  = DB::table('applyleaves')
        ->leftjoin('leavetypes', 'leavetypes.id', 'applyleaves.leavetype')
        ->leftjoin('teammembers', 'teammembers.id', 'applyleaves.createdby')
        ->leftJoin('roles', 'roles.id', '=', 'teammembers.role_id')
        ->leftJoin(DB::raw('
      (SELECT teammember_id, newstaff_code 
     FROM teamrolehistory 
     WHERE created_at = (SELECT MAX(created_at) 
                         FROM teamrolehistory th2 
                         WHERE th2.teammember_id = teamrolehistory.teammember_id)
     ) AS teamrolehistory
     '), function ($join) {
          $join->on('teamrolehistory.teammember_id', '=', 'teammembers.id');
        })
        ->select('applyleaves.*', 'teammembers.team_member', 'teammembers.staffcode', 'teammembers.emailid', 'roles.rolename', 'leavetypes.name', 'teamrolehistory.newstaff_code')
        ->distinct()
        ->get();
    }

    $request->flash();







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\applyleave\teamapplication.blade.php
remove it 

     <div class="body-content">
     </div>
	 
	 
	 
	 
replace it  
                             <div class="col-{{ Request::is('applyleave') ? '4' : '3' }}">
                                <div class="form-group">
                                    <strong> <label class="font-weight-600">End Leave Period <span id="endPeriodAsterisk"
                                                class="text-danger d-none">*</span></label></strong>
                                    <input type="date" class="form-control endclass" id="endperiod1" name="endperiod"
                                        value="{{ old('endperiod') }}">
                                </div>
                            </div>
							
							
							 
							 
							 
							 
btn-block">Search</button>  after this div add below code 


                              @if (Request::is('filtering-applyleve'))
                                <div class="col-1 d-flex justify-content-center align-items-center">
                                    <div class="form-group m-0">
                                        <a href="{{ url('/applyleave') }}">
                                            <img src="{{ url('backEnd/image/reload.png') }}"
                                                style="width: 30px; height: 30px;" alt="Reload">
                                        </a>
                                    </div>
                                </div>
                            @endif
							 
		

		
							 
remove below code 

                             {{-- <tr>
                                 <div class="refresh-btn-container"
                                     style="position: relative; left: 305px; top: 34px; z-index: 1;">
                                     <a href="{{ url('/applyleave') }}" class="btn btn-success">Refresh</a>
                                 </div>
                             </tr> --}}






22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\applyleave\teamapplication.blade.php
 function validateDateRange(startSelector, endSelector, errorMessage) {
 
 
 remove this script from this file 




22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\layouts\includes\js.blade.php
add below code end of the file 

 
 @if (Request::is('applyleave') || Request::is('filtering-applyleve'))
     <script>
         $(document).ready(function() {
             function validateDateRange(startSelector, endSelector, errorMessage) {
                 var startDateInput = $(startSelector);
                 var endDateInput = $(endSelector);

                 function compareDates() {
                     var startDate = new Date(startDateInput.val());
                     var endDate = new Date(endDateInput.val());

                     if (startDate > endDate) {
                         alert(errorMessage);
                         endDateInput.val('');
                     }
                 }

                 startDateInput.on('input', compareDates);
                 endDateInput.on('blur', compareDates);
             }

             function validateYearInput(inputSelector) {
                 $(inputSelector).on('change', function() {
                     var input = $(this);
                     var dateValue = new Date(input.val());
                     var year = dateValue.getFullYear();
                     if (year.toString().length > 4) {
                         alert('Enter four digits for the year');
                         input.val('');
                     }
                 });
             }

             // Apply date range validation
             validateDateRange('#start1', '#end1',
                 "'End Request Date' should be greater than or equal to the 'Start Request Date'");
             validateDateRange('#startperiod1', '#endperiod1',
                 "'End Leave Period' should be greater than or equal to the 'Start Leave Period'");

             // Apply year validation
             validateYearInput('#start1');
             validateYearInput('#end1');
             validateYearInput('#startperiod1');
             validateYearInput('#endperiod1');


             // Validation on submit button click 
             //  $('form').submit(function(event) {
             $('#filterform').submit(function(event) {
                 var fields = ['#employee1', '#leave1', '#status1', '#start1', '#end1', '#startperiod1',
                     '#endperiod1'
                 ];

                 var allEmpty = fields.every(function(selector) {
                     return $(selector).val() === "";
                 });

                 if (allEmpty) {
                     alert("Please select data for filter");
                     event.preventDefault(); // Prevent form submission if all fields are empty
                 }

                 // Validate date pairs
                 var startDate = $('#start1').val();
                 var endDate = $('#end1').val();
                 var startPeriod = $('#startperiod1').val();
                 var endPeriod = $('#endperiod1').val();

                 function validateDatePair(start, end, asteriskId, message) {
                     if (start && !end) {
                         alert(message);
                         $(asteriskId).removeClass("d-none"); // Show the asterisk
                         event.preventDefault();
                         return false;
                     }
                     $(asteriskId).addClass("d-none"); // Hide the asterisk if validation passes
                     return true;
                 }

                 // Validate both date ranges and show the corresponding asterisk
                 if (!validateDatePair(startDate, endDate, "#endDateAsterisk",
                         "Please select an 'End Request Date'.") ||
                     !validateDatePair(startPeriod, endPeriod, "#endPeriodAsterisk",
                         "Please select an 'End Leave Period'.")) {
                     return; // Stop if any validation fails
                 }
                 // Validate date pairs end hare 

             });
         });
     </script>
 @endif





22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\applyleave\index.blade.php  please ise live ke code se match kare 
replace all code in this file from  TempraryStore file\replace file\index.blade.php







22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\applyleave\teamapplication.blade.php
replace all hare 

<link href="https://cdn.datatables.net/buttons/1.7.1/css/buttons.dataTables.min.css" rel="stylesheet">

<link href="{{ url('backEnd/plugins/select2/dist/css/select2.min.css') }}" rel="stylesheet">
<link href="{{ url('backEnd/plugins/select2-bootstrap4/dist/select2-bootstrap4.min.css') }}" rel="stylesheet">
<link href="{{ url('backEnd/plugins/jquery.sumoselect/sumoselect.min.css') }}" rel="stylesheet">



 
find it and replace 
<table id="examplee" class="display nowrap">

                     <table id="examplee" class="table display table-bordered table-striped table-hover">








In the Team Application tab on the Partner ID, the latest data should appear by default ```end hare 













After a user rejoins, when the admin filters the data, a warning message appears like 'User left on (date)'. ```start 2nd time
Modification in the Attendance module included in this code  ``1122

vsalocal, vsademo, vsalive//..
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\AttendanceController.php
public function adminattendancereport(Request $request)


 $singleusersearched = DB::table('teammembers')
            ->where('teammembers.id', $teamnid)
            ->leftJoin(
                'teamrolehistory',
                'teamrolehistory.teammember_id',
                '=',
                'teammembers.id',
            )
            ->leftJoin(
                'rejoiningsamepost',
                'rejoiningsamepost.teammember_id',
                '=',
                'teammembers.id',
            )
            ->select([
                'teammembers.id',
                'teammembers.team_member',
                'teammembers.staffcode',
                'teammembers.joining_date',
                'teammembers.team_member',
                DB::raw(
                    'COALESCE(teamrolehistory.rejoiniedexitdate, rejoiningsamepost.rejoiniedexitdate, teammembers.leavingdate) AS final_leavingdate',
                ),
                DB::raw('COALESCE(teamrolehistory.rejoiningdate, rejoiningsamepost.rejoiningdate,teamrolehistory.promotion_date) AS final_rejoining_date'),
            ])
            ->first();

        // dd($singleusersearched);

        // Check leaving date validation
        if ($singleusersearched && $singleusersearched->final_leavingdate) {
            $final_joiningdate = Carbon::parse($singleusersearched->final_rejoining_date);
            $final_leavingdate = Carbon::parse($singleusersearched->final_leavingdate);
            if ($final_leavingdate->gt($final_joiningdate)) {
                if ($startdate->gt($final_leavingdate)) {
                    $output = ['msg' => 'User left on ' . $final_leavingdate->format('d-m-Y') . ', cannot select beyond this date.'];
                    $request->flash();
                    return redirect()->to('attendance')->with('statuss', $output);
                }
            }
        }

        // Check joining date validation
        if ($singleusersearched && $singleusersearched->joining_date) {
            $joiningdate = Carbon::parse($singleusersearched->joining_date);
            if ($joiningdate->gt($enddate)) {
                $output = ['msg' => 'User joined on ' . $joiningdate->format('d-m-Y') . ', cannot select before this date.'];
                $request->flash();
                return redirect()->to('attendance')->with('statuss', $output);
            }
        }
		
		
		
		
		
		
		
	

	
		
		
and 


 $query = DB::table('attendances')
            ->join('teammembers', 'teammembers.id', '=', 'attendances.employee_name')
            ->leftJoin('teamrolehistory', function ($join) {
                $join->on('teamrolehistory.teammember_id', '=', 'attendances.employee_name')
                    ->whereRaw('DATE(teamrolehistory.created_at) <= attendances.fulldate');
            })
            ->leftJoin('rejoiningsamepost', function ($join) {
                $join->on('rejoiningsamepost.teammember_id', '=', 'attendances.employee_name')
                    ->whereRaw('DATE(rejoiningsamepost.rejoiningdate) <= attendances.fulldate');
            })
            // ->leftJoin('rejoiningsamepost', 'rejoiningsamepost.teammember_id', '=', 'teammembers.id')
            ->leftJoin('roles as current_role', 'current_role.id', '=', 'teammembers.role_id')
            ->leftJoin('roles as roleidold', 'roleidold.id', '=', 'teamrolehistory.roleid_old')
            ->leftJoin('roles as roleidnew', 'roleidnew.id', '=', 'teamrolehistory.roleid_new')
            ->select([
                'attendances.*',
                'teammembers.team_member',
                'teammembers.staffcode',
                'teammembers.employment_status',
                // Role names
                'current_role.rolename as current_role_name',
                'roleidold.rolename as old_role_name',
                'roleidnew.rolename as new_role_name',
                'teamrolehistory.newstaff_code',
                // Combine rejoining dates 
                DB::raw('COALESCE(teamrolehistory.rejoiningdate, rejoiningsamepost.rejoiningdate,teamrolehistory.promotion_date) AS final_rejoining_date'),
                'teammembers.joining_date'
            ]);







yahi tak update kare iske aage ka na kare 


22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\attendance\adminattendance.blade.php

 <th>Joining / Rejoining Date</th>



 <td> {{ $attendanceData->month }}</td> find and before this line and @foreach ($attendanceDatas as $attendanceData)
   
   

                             @foreach ($attendanceDatas as $attendanceData)
                                <tr>
                                    @php
                                        $promotionandrejoin = DB::table('teamrolehistory')
                                            ->leftJoin('roles', 'roles.id', '=', 'teamrolehistory.roleid_old')
                                            ->where('teammember_id', $attendanceData->employee_name)
                                            ->value('roles.rolename');
                                    @endphp
                                    <td style="display: none;">{{ $attendanceData->id }}</td>
                                    <td>{{ $attendanceData->team_member }}</td>
                                    <td> {{ $attendanceData->newstaff_code ?? ($attendanceData->staffcode ?? '') }}
                                    </td>
                                    <td> {{ !$attendanceData->old_role_name && $promotionandrejoin ? $promotionandrejoin : $attendanceData->current_role_name }}
                                    </td>
                                    <td> {{ $attendanceData->final_rejoining_date ? date('d-m-Y', strtotime($attendanceData->final_rejoining_date)) : date('d-m-Y', strtotime($attendanceData->joining_date)) }}
                                    </td>
									
									

22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\attendance\teamattendance.blade.php

<th>Joinig / Rejoining Date</th>


 <td> {{ $attendanceData->month }}</td> find and before this line and @foreach ($attendanceDatas as $attendanceData)



                           @foreach ($attendanceDatas as $attendanceData)
                                <tr>
                                    @php
                                        $promotionandrejoin = DB::table('teamrolehistory')
                                            ->leftJoin('roles', 'roles.id', '=', 'teamrolehistory.roleid_old')
                                            ->where('teammember_id', $attendanceData->employee_name)
                                            ->value('roles.rolename');
                                    @endphp
                                    <td style="display: none;">{{ $attendanceData->id }}</td>
                                    <td>{{ $attendanceData->team_member }}</td>
                                    <td> {{ $attendanceData->newstaff_code ?? ($attendanceData->staffcode ?? '') }}
                                    </td>
                                    <td> {{ !$attendanceData->old_role_name && $promotionandrejoin ? $promotionandrejoin : $attendanceData->current_role_name }}
                                    </td>
                                    <td> {{ $attendanceData->final_rejoining_date ? date('d-m-Y', strtotime($attendanceData->final_rejoining_date)) : date('d-m-Y', strtotime($attendanceData->joining_date)) }}
                                    </td>
									
							

							
									


22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\PromotionandrejoiningController.php
 public function rejoinstore(Request $request)
 $checkrole = DB::table('teammembers')
 

        $checkrole = DB::table('teammembers')
            ->where('id', $request->employeeid)
            ->select('id', 'role_id', 'staffcode', 'staffcodenumber', 'joining_date')
            ->first();
			
		

		



 public function rejoinstore(Request $request)  
 add after this function 

 

       private function updateOrInsertAttendance($employeeId, $rejoiningDate, $joiningDate)
    {

        $rejoining_date = Carbon::parse($rejoiningDate);
        $formatted_date = $rejoining_date->format('Y-m-d');
        $month = $rejoining_date->format('F');
        $year = $rejoining_date->format('Y');
        $dayOfExit = $rejoining_date->day;
        $totalDaysInExitMonth = $rejoining_date->daysInMonth;
        $timestampcreated = $formatted_date . ' ' . now()->format('H:i:s');

        $attendance = DB::table('attendances')
            ->where('employee_name', $employeeId)
            ->where('month', $month)
            ->where('year', $year)
            ->first();

        if ($attendance) {

            $daysToColumns = [
                1 => 'one',
                2 => 'two',
                3 => 'three',
                4 => 'four',
                5 => 'five',
                6 => 'six',
                7 => 'seven',
                8 => 'eight',
                9 => 'nine',
                10 => 'ten',
                11 => 'eleven',
                12 => 'twelve',
                13 => 'thirteen',
                14 => 'fourteen',
                15 => 'fifteen',
                16 => 'sixteen',
                17 => 'seventeen',
                18 => 'eighteen',
                19 => 'ninghteen',
                20 => 'twenty',
                21 => 'twentyone',
                22 => 'twentytwo',
                23 => 'twentythree',
                24 => 'twentyfour',
                25 => 'twentyfive',
                26 => 'twentysix',
                27 => 'twentyseven',
                28 => 'twentyeight',
                29 => 'twentynine',
                30 => 'thirty',
                31 => 'thirtyone'
            ];

            $updateData = [];
            foreach ($daysToColumns as $day => $column) {
                if ($day >= $dayOfExit && $day <= $totalDaysInExitMonth) {
                    // $updateData[$column] = 'X';
                    $updateData[$column] = null;
                }
            }

            DB::table('attendances')
                ->where('id', $attendance->id)
                ->update(array_merge([
                    'fulldate' => $formatted_date,
                    'created_at' => $timestampcreated,
                    'updated_at' => $timestampcreated,
                ], $updateData));
        } else {
            DB::table('attendances')->insert([
                'employee_name' => $employeeId,
                'month' => $month,
                'year' => $year,
                'dateofjoining' => $joiningDate,
                'fulldate' => $formatted_date,
                'created_at' => $timestampcreated,
                'updated_at' => $timestampcreated,
            ]);
        }
    }
	
	


	



 public function rejoinstore(Request $request) 
 'created_at' => Carbon::createFromFormat('Y-m-d', $request->rejoining_date)->toDateTimeString(),  find this 

                DB::table('teamrolehistory')->insert([
                    'teammember_id' => $request->employeeid,
                    'roleid_old' => $checkrole->role_id,
                    'roleid_new' => $request->designationtype,
                    'oldstaff_code' =>  $checkrole->staffcode,
                    'newstaff_code' => $newstaffcoderesult,
                    'old_staffcodenumber' => $checkrole->staffcodenumber,
                    'new_staffcodenumber' => $staffcode,
                    'rejoiningdate' => date('Y-m-d', strtotime($request->rejoining_date)),
                    //hare goes to created date 
                    'rejoiningcreated' => now(),
                    'rejointimesheetstatus' => 1,
                    //hare goes to rejoining date from form becouse all condition apply on create column it is common column for pormotion and rejoining
                    'created_at' => Carbon::createFromFormat('Y-m-d', $request->rejoining_date)->toDateTimeString(),
                    'updated_at' => now(),
                ]);
                $this->updateOrInsertAttendance($request->employeeid, $request->rejoining_date, $checkrole->joining_date);
	
	
	
	
	
	
	
 public function rejoinstore(Request $request) 	
DB::table('rejoiningsamepost')->insert([  find it 	
	
              DB::table('rejoiningsamepost')->insert([
                'teammember_id' => $request->employeeid,
                'rejoiningdate' => date('Y-m-d', strtotime($request->rejoining_date)),
                'created_at' => now(),
                'updated_at' => now(),
            ]);

            $this->updateOrInsertAttendance($request->employeeid, $request->rejoining_date, $checkrole->joining_date);









22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\PromotionandrejoiningController.php

 public function permotionandrejoinstore(Request $request)
 
 
        $checkrole = DB::table('teammembers')
            ->where('id', $request->employeeid)
            ->select('id', 'role_id', 'staffcode', 'staffcodenumber', 'joining_date')
            ->first();
			
			
			
	
	


'created_at' => Carbon::createFromFormat('Y-m-d', $request->promotion_date)->toDateTimeString(),	
after this code 


            $this->updateOrInsertAttendance($request->employeeid, $request->promotion_date, $checkrole->joining_date);
	





After a user rejoins, when the admin filters the data, a warning message appears like 'User left on (date)'. ```end hare 2nd time
Implementation in the Attendance module








27-11-2025  vsalive 
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
login 
reset password
signout
password settings


app\Http\Controllers\TeamloginController.php


            $data['status'] = 1;
            $existUser = User::where('email', $request->teammember_id)->first();
            if ($existUser) {
                $existUser->update($data);
            } else {
                User::create($data);
            }




vsalive
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php



  private function promotionOrRejoined($timesheetData)
  {
    $targetClients = [29, 34, 32, 33, 134];
    return $timesheetData->map(function ($row) use ($targetClients) {

      if (in_array($row->client_id, $targetClients)) {
        $timesheetDate = $row->date
          ? Carbon::parse($row->date)->endOfDay()
          : null;
        $row->final_teamstaffcode = $this->getStaffCodeAt($row->createdby, $timesheetDate);
        $row->final_partnerstaffcode = $this->getStaffCodeAt($row->partner, $timesheetDate);
      } else {
        // $row->final_teamstaffcode = $this->getStaffCodeAt($row->createdby, $row->assignmentcreated);
        // $row->final_partnerstaffcode = $this->getStaffCodeAt($row->partner, $row->assignmentcreated);

        $dateCheck = $row->assignmentcreated
          ? $row->assignmentcreated
          : Carbon::parse($row->date)->endOfDay();

        $row->final_teamstaffcode = $this->getStaffCodeAt($row->createdby, $dateCheck);
        $row->final_partnerstaffcode = $this->getStaffCodeAt($row->partner, $dateCheck);
      }

      return $row;
    });
  }
  
  
serch    $targetClients = [29, 34, 32, 33, 134];

and update balde file 

resources\views\backEnd\timesheet\rejectedlistteam.blade.php

 if (in_array($item->client_id, $targetClients)) {
                                                        $timesheetDate = $item->date
                                                            ? Carbon\Carbon::parse($item->date)->endOfDay()
                                                            : null;
                                                        $final_partnerstaffcode = $getStaffCodeAt(
                                                            $item->partner,
                                                            $timesheetDate,
                                                        );
                                                    } else {
                                                        $dateCheck = $item->assignmentcreated
                                                            ? $item->assignmentcreated
                                                            : Carbon\Carbon::parse($item->date)->endOfDay();

                                                        $final_partnerstaffcode = $getStaffCodeAt(
                                                            $item->partner,
                                                            $dateCheck,
                                                        );
                                                    }
													
													
resources\views\backEnd\timesheet\hrindex.blade.php


                                                if (in_array($item->client_id, $targetClients)) {
                                                    $timesheetDate = $item->date
                                                        ? Carbon\Carbon::parse($item->date)->endOfDay()
                                                        : null;
                                                    $final_partnerstaffcode = $getStaffCodeAt(
                                                        $item->partner,
                                                        $timesheetDate,
                                                    );
                                                } else {
                                                    $dateCheck = $item->assignmentcreated
                                                        ? $item->assignmentcreated
                                                        : Carbon\Carbon::parse($item->date)->endOfDay();

                                                    $final_partnerstaffcode = $getStaffCodeAt(
                                                        $item->partner,
                                                        $dateCheck,
                                                    );
                                                }


end hare 


app\Http\Controllers\PromotionandrejoiningController.php


        $rejoiningcheckanotherpost = DB::table('teamrolehistory')
            ->where('teammember_id', $request->employeeid)
            ->orderByDesc('id')
            ->first();

        // this functionality also in teammember edit form 
        $latestteamrolehistory = DB::table('teamrolehistory as teamrolehistorydata')
            ->select(
                'teamrolehistorydata.teammember_id',
                'teamrolehistorydata.created_at as rejoiningdate',
                'teamrolehistorydata.rejoiniedexitdate'
            )
            ->whereRaw('teamrolehistorydata.id = (SELECT MAX(teamrolehistorylatest.id) FROM teamrolehistory as teamrolehistorylatest WHERE teamrolehistorylatest.teammember_id = teamrolehistorydata.teammember_id)');


        $latestrejoiningsamepost = DB::table('rejoiningsamepost as rejoiningsamepostdata')
            ->select(
                'rejoiningsamepostdata.teammember_id',
                'rejoiningsamepostdata.rejoiningdate',
                'rejoiningsamepostdata.rejoiniedexitdate'
            )
            ->whereRaw('rejoiningsamepostdata.id = (SELECT MAX(rejoiningsamepostlatest.id) FROM rejoiningsamepost as rejoiningsamepostlatest WHERE rejoiningsamepostlatest.teammember_id = rejoiningsamepostdata.teammember_id)');


        $teamrecord = DB::table('teammembers')
            ->where('teammembers.id', $request->employeeid)
            ->leftJoinSub($latestteamrolehistory, 'latestrecord', function ($join) {
                $join->on('latestrecord.teammember_id', '=', 'teammembers.id');
            })
            ->leftJoinSub($latestrejoiningsamepost, 'latestrecord2', function ($join) {
                $join->on('latestrecord2.teammember_id', '=', 'teammembers.id');
            })
            ->select([
                'teammembers.id',
                'teammembers.team_member',
                DB::raw('COALESCE(latestrecord.rejoiningdate, latestrecord2.rejoiningdate, teammembers.joining_date) AS final_joiningdate'),
                DB::raw('COALESCE(latestrecord.rejoiniedexitdate, latestrecord2.rejoiniedexitdate, teammembers.leavingdate) AS final_leavingdate'),
            ])
            ->first();

        if ($teamrecord) {
            $finalJoining = Carbon::parse($teamrecord->final_joiningdate)->format('Y-m-d');
            $finalLeaving = Carbon::parse($teamrecord->final_leavingdate)->format('Y-m-d');
            if (empty($teamrecord->final_leavingdate) || $finalLeaving < $finalJoining) {
                $output = array('msg' => "Please enter leaving date");
                return back()->with('statuss', $output)->with('activeTab', 'rejoining');
            }
        }




sahil timesheet fixed 
timesheetusers table me id 154908
createdby 82811

timesheet table me  id = 152160
createdby 82811



rejoiningsamepost
id 15

rejoiniedexitdate
2025-05-11



attendances table id 1958
12 t0 30 tak 
X

exam_leave 
12 se 11



applyleaves
id 1699

2025-05-12 to 2025-05-11


leaveapprove
id 1613

94 to 93


attendances table me 
employee_name = 828
 id = 1958
is id ke baad jitne bhi attendence record hai use delete karna hai vsalive per



12-12-2025 task new ```start hare 
1.When filling the timesheet for an unallocated client, the partner dropdown should display all partner names so that the user can select the appropriate one.
2.When a user applies for leave, the partner's name should appear in the partner column of the timesheet instead of N/A.
3.Timesheet submission report issue. Nalin Kumar.
22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php
find  // adding approver in patner section

1

            // 'partner'     =>     887,
            // adding approver in patner section 
            'partner'     =>     $request->approver,
			
			
			
			
2

              // 'partner'     =>     887,
              // adding approver in patner section 
              'partner'     =>  $team->approver,
			  
			  


22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php
 if (isset($request->assignment)) {
 
 
 
      if (isset($request->assignment)) {
        // dd($request->assignment);
        if (auth()->user()->role_id == 11) {
          echo "<option value=''>Select Partner</option>";
          if ($request->assignment === 'UNA100002') {
            $excludedIds = [887, 663, 841, 836, 843, 447];
            $partners = DB::table('teammembers')
              ->select('id', 'team_member')
              ->where('role_id', 13)
              ->where('status', 1)
              ->whereNotIn('id', $excludedIds)
              ->orderBy('team_member')
              ->get();
          } else {
            $partners = DB::table('assignmentmappings')
              ->leftjoin('teammembers', 'teammembers.id', 'assignmentmappings.leadpartner')
              ->leftjoin('teammembers as team', 'team.id', 'assignmentmappings.otherpartner')
              ->where('assignmentmappings.assignmentgenerate_id', $request->assignment)
              ->select('team.team_member as team_member', 'team.id', 'teammembers.id', 'teammembers.team_member')
              ->get();
          }
          foreach ($partners as $partner) {
            echo "<option value='{$partner->id}'>{$partner->team_member}</option>";
          }
        } elseif ($permotioncheck && auth()->user()->role_id == 13) {
          echo "<option value=''>Select Partner</option>";
          // dd($request->assignment);
          if ($request->assignment === 'UNA100002') {
            $excludedIds = [887, 663, 841, 836, 843, 447];
            $partnerbefore = DB::table('teammembers')
              ->where('role_id', 13)
              ->where('status', 1)
              ->whereNotIn('id', $excludedIds)
              // ->orderBy('team_member')
              ->select('id', 'team_member');
          } else {
            $partnerbefore = DB::table('assignmentmappings')
              ->leftJoin('teammembers', 'teammembers.id', 'assignmentmappings.leadpartner')
              ->leftJoin('teammembers as team', 'team.id', 'assignmentmappings.otherpartner')
              ->where('assignmentmappings.assignmentgenerate_id', $request->assignment)
              ->select('teammembers.id', 'teammembers.team_member');
          }

          $partnerafter = DB::table('assignmentmappings')
            ->leftJoin('teammembers as leadpartner', 'leadpartner.id', '=', 'assignmentmappings.leadpartner')
            ->leftJoin('teammembers as otherpartner', 'otherpartner.id', '=', 'assignmentmappings.otherpartner')
            ->where('assignmentmappings.assignmentgenerate_id', $request->assignment)
            ->where(function ($query) {
              $query->where('assignmentmappings.leadpartner', auth()->user()->teammember_id)
                ->orWhere('assignmentmappings.otherpartner', auth()->user()->teammember_id);
            })
            ->select(DB::raw("
            CASE
                WHEN assignmentmappings.leadpartner = " . auth()->user()->teammember_id . " THEN leadpartner.id
                WHEN assignmentmappings.otherpartner = " . auth()->user()->teammember_id . " THEN otherpartner.id
            END as id,
            CASE
                WHEN assignmentmappings.leadpartner = " . auth()->user()->teammember_id . " THEN leadpartner.team_member
                WHEN assignmentmappings.otherpartner = " . auth()->user()->teammember_id . " THEN otherpartner.team_member
            END as team_member
            "));

          $partnerresult = $partnerafter->union($partnerbefore)->get();

          foreach ($partnerresult as $partner) {
            echo "<option value='{$partner->id}'>{$partner->team_member}</option>";
          }
        } elseif (auth()->user()->role_id == 13) {
          echo "<option value=''>Select Partner</option>";

          $partners = DB::table('teammembers')
            ->where('id', auth()->user()->teammember_id)
            ->select('teammembers.id', 'teammembers.team_member')
            ->get();

          foreach ($partners as $partner) {
            echo "<option value='{$partner->id}'>{$partner->team_member}</option>";
          }
        } else {
          echo "<option value=''>Select Partner</option>";
          if ($request->assignment === 'UNA100002') {
            $excludedIds = [887, 663, 841, 836, 843, 447];
            $partners = DB::table('teammembers')
              ->select('id', 'team_member')
              ->where('role_id', 13)
              ->where('status', 1)
              ->whereNotIn('id', $excludedIds)
              ->orderBy('team_member')
              ->get();
          } else {
            $partners = DB::table('assignmentmappings')
              ->leftjoin('teammembers', 'teammembers.id', 'assignmentmappings.leadpartner')
              ->leftjoin('teammembers as team', 'team.id', 'assignmentmappings.otherpartner')
              ->where('assignmentmappings.assignmentgenerate_id', $request->assignment)
              ->select('team.team_member as team_member', 'team.id', 'teammembers.id', 'teammembers.team_member')
              ->get();
          }
          foreach ($partners as $partner) {
            echo "<option value='{$partner->id}'>{$partner->team_member}</option>";
          }
        }
      }




22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\TimesheetController.php
public function timesheeteditonchange(Request $request)


      if (isset($request->assignment)) {
        // dd($request->assignment);
        if (auth()->user()->role_id == 11) {
          echo "<option value=''>Select Partner</option>";
          if ($request->assignment === 'UNA100002') {
            $excludedIds = [887, 663, 841, 836, 843, 447];
            $partners = DB::table('teammembers')
              ->select('id', 'team_member')
              ->where('role_id', 13)
              ->where('status', 1)
              ->whereNotIn('id', $excludedIds)
              ->orderBy('team_member')
              ->get();
          } else {
            $partners = DB::table('assignmentmappings')
              ->leftjoin('teammembers', 'teammembers.id', 'assignmentmappings.leadpartner')
              ->leftjoin('teammembers as team', 'team.id', 'assignmentmappings.otherpartner')
              ->where('assignmentmappings.assignmentgenerate_id', $request->assignment)
              ->select('team.team_member as team_member', 'team.id', 'teammembers.id', 'teammembers.team_member')
              ->get();
          }
          foreach ($partners as $partner) {
            echo "<option value='{$partner->id}'>{$partner->team_member}</option>";
          }
        } elseif (auth()->user()->role_id == 13) {
          echo "<option value=''>Select Partner</option>";
          foreach (
            DB::table('teammembers')
              ->where('id', auth()->user()->teammember_id)
              ->select('teammembers.id', 'teammembers.team_member')
              ->get() as $subs
          ) {
            echo "<option value='" . $subs->id . "'>" . $subs->team_member . "</option>";
          }
        } else {
          echo "<option value=''>Select Partner</option>";
          if ($request->assignment === 'UNA100002') {
            $excludedIds = [887, 663, 841, 836, 843, 447];
            $partners = DB::table('teammembers')
              ->select('id', 'team_member')
              ->where('role_id', 13)
              ->where('status', 1)
              ->whereNotIn('id', $excludedIds)
              ->orderBy('team_member')
              ->get();
          } else {
            $partners = DB::table('assignmentmappings')
              ->leftjoin('teammembers', 'teammembers.id', 'assignmentmappings.leadpartner')
              ->leftjoin('teammembers as team', 'team.id', 'assignmentmappings.otherpartner')
              ->where('assignmentmappings.assignmentgenerate_id', $request->assignment)
              ->select('team.team_member as team_member', 'team.id', 'teammembers.id', 'teammembers.team_member')
              ->get();
          }
          foreach ($partners as $partner) {
            echo "<option value='{$partner->id}'>{$partner->team_member}</option>";
          }
        }
      }






resources\views\backEnd\timesheet\weeklylist.blade.php

                                @if (Auth::user()->role_id == 11 ||
                                        (isset($timesheetData[0]) && Auth::user()->teammember_id != $timesheetData[0]->createdby))
                                    <th>Action</th>
   
 
 

end hare 


22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php



22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php


22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php



22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php




22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php



22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php


22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php



22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php




22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php



22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php


22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php



22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php




22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php



22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ApplyleaveController.php




22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222



Role Admin, partner, manager and staff

1.submitted timesheet,weeklylist   1 days 
2.apply leave default and filter both   1 days 
3.timesheet request  0.5 days 
4.all report tab 2 days 
5.timesheet, rejected timesheet , team timesheet rejected team timesheet 2 days 
6.entry point  1 days 
7.attendence  0.5 days 
8.dropdown for filter on all place 1 days 


total 9 days 
i have worked 2.5 days then now total 9 - 2.5 = 6.5

final date 31 october 




change_type in teammember  varchar(200) default null

change_type in samepost  varchar(200) default null

change_type in teamrole 


Done
Role admin, partner, manager, staff

Rejoining entry point, completed 
promotion entry point completed 

Submitted Timesheet completed
Submitted Timesheet after filter completed
Weeklylist completed

Apply leave listing completed.
Apply leave listing after filter completed

Attendence completed
Attendence after filter completed

timesheet request 
team timesheet request 
admin timesheet request

rejected submitted timesheet 

 
 
 
 



rejected submitted team timeshheet
team submitted timesheet default 
team submitted timesheet filter 
timesheet list on manager partner and admin 

`````````````````````````````````````````
Apply leave revert list on admin , manager , partner  
team Apply leave revert list on partner 


Reprt section 
Active Team Report
Assignment Report List
Assignment Time Report
Assignment Viewer List report
Independence Confirmation
Promotion and Rejoining
Team Timesheet Report

Confirmation List
/viewclient/191
open_leave


open_timesheet request 

add timesheet request button 
timesheet submitt weekly time 



Assignment Folder

app\Console\Commands\TimesheetnotfillReminder.php  cron 

change_type column add 





regarding vsalive to vsademo / regarding vsademo to vsalive 
two facter middlware 
partner me id 447 nahi aana chahiye 
it wala email 
//!


samepost me change type me data fill 
teamrole me bhi chnage type fill

rejoiningsamepost 
teamrolehistory is dono table me change type me data filed


	admin per timesheet me teammember not coming 
					
					jussi gupta 
					assignment list 



vsalive done
app\Http\Controllers\PromotionandrejoiningController.php


        // $rejoiningdatamerge = $rejoiningdata->merge($rejoiningdatasamepost);
        // dd($rejoiningdatamerge);

        $rejoiningdatamerge = $rejoiningdata
            ->merge($rejoiningdatasamepost)
            ->sortByDesc('created_at')
            ->values(); // index reset
        // dd($rejoiningdatamerge);
		
	
vsalive done	
app\Console\Commands\TimesheetnotfillReminder.php


                // Prepare Excel data
                $excelData = $rejoiningUsers->filter(function ($user) {
                    return !empty($user->last_submission_date);
                })->map(function ($user) {
                    return [
                        'team_member' => $user->team_member,
                        'emailid' => $user->emailid,
                    ];
                })->merge($teammemberOnlySave->map(function ($user) {
                    return [
                        'team_member' => $user->team_member,
                        'emailid' => $user->emailid,
                    ];
                }))->merge($teammemberNeverFilled->map(function ($user) {
                    return [
                        'team_member' => $user->team_member,
                        'emailid' => $user->emailid,
                    ];
                }))
                    ->unique('emailid')
                    ->values()
                    ->toArray();
					
				
					
					
					
					
	vsalive done				
					app\Http\Controllers\ClientController.php
					
					
            // dd(auth()->user()->clientassignment);
            $clientassignment =  DB::table('assignmentmappings')
                ->leftjoin('assignmentbudgetings', 'assignmentbudgetings.assignmentgenerate_id', 'assignmentmappings.assignmentgenerate_id')
                ->leftjoin('teammembers as leadpartner', 'leadpartner.id', 'assignmentmappings.leadpartner')
                ->leftjoin('teammembers as otherpartner', 'otherpartner.id', 'assignmentmappings.otherpartner')
                ->leftjoin('assignmentteammappings', 'assignmentteammappings.assignmentmapping_id', 'assignmentmappings.id')
                ->leftjoin('clients', 'clients.id', 'assignmentbudgetings.client_id')
                ->leftjoin('assignments', 'assignments.id', 'assignmentmappings.assignment_id')
                ->where('assignmentbudgetings.client_id', $id)
                ->where('assignmentteammappings.teammember_id', auth()->user()->teammember_id)
                ->where('assignmentteammappings.status', 1)
                ->select(
                    'assignmentmappings.*',
                    'assignmentbudgetings.duedate',
                    'assignmentbudgetings.assignmentname',
                    'assignmentbudgetings.status',
                    'assignments.assignment_name',
                    'clients.client_name',
                    'clients.client_code',
                    'leadpartner.team_member as leadpartnername',
                    'otherpartner.team_member as otherpartnername',
                )->distinct()->get();
				
				
				

unlocated 
apply leave 
nalin kumar 


jab leave apply karta hai to timesheet me partner column me partner name jana chahiye not NA
jab unlocated client per timesheet fill kare to partner dropdown me sabhi partner ka name aana chahiye so that user can select partner
Nalin kumar timesheet submitted report issue 

